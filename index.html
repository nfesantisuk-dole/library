<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç</title>
  
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Prompt', 'sans-serif'] 
          },
          colors: {
            primary: '#10b981', 
            secondary: '#34d399',
            dark: '#064e3b',
            bg: '#f0fdf4'
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Styles */
    body { -webkit-tap-highlight-color: transparent; }
    
    input, button, select, textarea {
      font-family: 'Prompt', sans-serif !important;
    }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    .content-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease-in-out; }
    .content-section.active { display: block; opacity: 1; transform: translateY(0); }

    /* Mobile Table Card View */
    @media (max-width: 768px) {
      .data-table thead { display: none; }
      .data-table, .data-table tbody, .data-table tr, .data-table td { display: block; width: 100%; }
      .data-table tr {
        margin-bottom: 1rem;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border: 1px solid #e2e8f0;
      }
      .data-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px dashed #e2e8f0;
        text-align: right;
      }
      .data-table td:last-child { border-bottom: none; justify-content: center; padding-top: 1rem; }
      .data-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #059669;
        text-align: left;
        margin-right: 1rem;
      }
      .action-button-group { justify-content: center; }
    }

    @media (min-width: 769px) {
      .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
      .data-table th { background-color: #f0fdf4; color: #065f46; font-weight: 600; padding: 1rem; text-align: left; border-bottom: 2px solid #bbf7d0; }
      .data-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; color: #334155; }
      .data-table tr:hover td { background-color: #f8fafc; }
    }

    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .spinner { width: 48px; height: 48px; border: 5px solid #10b981; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 10000; animation: slideIn 0.3s ease-out; }
    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .toast-warning { background: #f59e0b; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .admin-only { display: none !important; }
    .show-admin .admin-only { display: block !important; }
    @media (max-width: 768px) {
        .show-admin .nav-item.admin-only { display: flex !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-700 min-h-screen pb-24 md:pb-0 font-sans">

  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="spinner"></div>
  </div>

  <div id="mainWrapper" class="max-w-7xl mx-auto md:p-6">
    
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 px-6 py-4 md:rounded-2xl md:shadow-lg border-b md:border-none border-slate-200 flex justify-between items-center transition-all duration-300">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-gradient-to-tr from-emerald-500 to-teal-400 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg shadow-emerald-200">
          <i class="ph ph-books"></i>
        </div>
        <div>
          <h1 id="headerTitle" class="text-xl md:text-2xl font-bold text-slate-800 leading-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h1>
          <p id="headerSubtitle" class="text-xs md:text-sm text-slate-500">‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç</p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <div id="connectionStatus" class="hidden md:flex px-3 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-500 items-center gap-1">
          <span id="statusIcon">üîå</span> <span id="statusText">‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        <button id="adminLoginBtn" onclick="showLoginModal()" class="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 transition text-sm font-semibold">
          <i class="ph ph-lock-key"></i> <span class="hidden sm:inline">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</span>
        </button>
        <button id="adminLogoutBtn" onclick="logout()" style="display: none;" class="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition text-sm font-semibold">
          <i class="ph ph-sign-out"></i> <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å</span>
        </button>
      </div>
    </header>

    <nav class="hidden md:flex gap-4 mt-6 mb-8 overflow-x-auto pb-2">
      <button onclick="navigateTo('dashboard')" class="nav-button active px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 bg-white text-slate-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-200 shadow-sm group" data-target="dashboard">
        <i class="ph ph-house text-xl group-hover:scale-110 transition-transform"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
      </button>
      <button onclick="navigateTo('borrow')" class="nav-button admin-only px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 bg-white text-slate-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-200 shadow-sm group" data-target="borrow">
        <i class="ph ph-shopping-cart text-xl group-hover:scale-110 transition-transform"></i> ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
      </button>
      <button onclick="navigateTo('return')" class="nav-button admin-only px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 bg-white text-slate-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-200 shadow-sm group" data-target="return">
        <i class="ph ph-arrow-u-down-left text-xl group-hover:scale-110 transition-transform"></i> ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
      </button>
      <button onclick="navigateTo('books')" class="nav-button admin-only px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 bg-white text-slate-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-200 shadow-sm group" data-target="books">
        <i class="ph ph-book-bookmark text-xl group-hover:scale-110 transition-transform"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
      </button>
      <button onclick="navigateTo('members')" class="nav-button admin-only px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 bg-white text-slate-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-200 shadow-sm group" data-target="members">
        <i class="ph ph-users text-xl group-hover:scale-110 transition-transform"></i> ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      </button>
      <button onclick="navigateTo('history')" class="nav-button admin-only px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 bg-white text-slate-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-200 shadow-sm group" data-target="history">
        <i class="ph ph-clock-counter-clockwise text-xl group-hover:scale-110 transition-transform"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      </button>
    </nav>

    <main class="p-4 md:p-0">

      <section id="dashboard" class="content-section active space-y-6">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
            <span class="text-sm text-slate-400">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            <span id="totalBooks" class="text-3xl font-bold text-slate-700 my-1">0</span>
            <span class="text-xs px-2 py-0.5 bg-slate-100 rounded text-slate-500">‡πÄ‡∏•‡πà‡∏°</span>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 flex flex-col items-center justify-center relative overflow-hidden">
            <div class="absolute top-0 right-0 p-2 opacity-10"><i class="ph ph-check-circle text-6xl text-emerald-500"></i></div>
            <span class="text-sm text-emerald-600 font-medium">‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏¢‡∏∑‡∏°</span>
            <span id="availableBooks" class="text-3xl font-bold text-emerald-600 my-1">0</span>
            <span class="text-xs px-2 py-0.5 bg-emerald-100 rounded text-emerald-600">‡πÄ‡∏•‡πà‡∏°</span>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex flex-col items-center justify-center">
            <span class="text-sm text-orange-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</span>
            <span id="borrowedBooks" class="text-3xl font-bold text-orange-500 my-1">0</span>
            <span class="text-xs px-2 py-0.5 bg-orange-100 rounded text-orange-600">‡πÄ‡∏•‡πà‡∏°</span>
          </div>
          
          <div class="admin-only bg-white p-4 rounded-2xl shadow-sm border border-red-100 flex flex-col items-center justify-center">
             <span class="text-sm text-red-500 font-medium">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
             <span id="overdueBooks" class="text-3xl font-bold text-red-500 my-1">0</span>
             <span class="text-xs px-2 py-0.5 bg-red-100 rounded text-red-600">‡πÄ‡∏•‡πà‡∏°</span>
          </div>
          <div class="admin-only bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
             <span class="text-sm text-slate-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
             <span id="totalMembers" class="text-3xl font-bold text-slate-700 my-1">0</span>
             <span class="text-xs px-2 py-0.5 bg-slate-100 rounded text-slate-500">‡∏Ñ‡∏ô</span>
          </div>
          <div class="admin-only bg-white p-4 rounded-2xl shadow-sm border border-blue-100 flex flex-col items-center justify-center">
             <span class="text-sm text-blue-500 font-medium">‡∏¢‡∏∑‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
             <span id="todayBorrows" class="text-3xl font-bold text-blue-500 my-1">0</span>
             <span class="text-xs px-2 py-0.5 bg-blue-100 rounded text-blue-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg shadow-slate-200/50">
          <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph ph-magnifying-glass text-emerald-500"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
          <div class="flex flex-col md:flex-row gap-4 mb-6">
            <input type="text" id="searchAvailableBooksPublic" class="flex-1 p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠, ‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á...">
            <select id="filterCategoryPublic" class="p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none cursor-pointer" onchange="searchAvailableBooksPublic()">
              <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
              <option value="‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢">‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</option> <option value="‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô">‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</option> <option value="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option> <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>
          <div id="availableBooksListPublic" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
             <h3 class="text-lg font-bold text-slate-800 mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
             <div class="h-64"><canvas id="borrowChart"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
             <h3 class="text-lg font-bold text-slate-800 mb-4">üèÜ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h3>
             <div class="h-64"><canvas id="popularChart"></canvas></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-red-400">
          <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center gap-2"><i class="ph ph-warning-circle"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</h2>
          <div id="overdueList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
      </section>

      <section id="borrow" class="content-section space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg shadow-emerald-100/50">
          <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
             <div class="p-3 bg-emerald-100 text-emerald-600 rounded-xl"><i class="ph ph-shopping-cart text-xl"></i></div>
             <div>
               <h2 class="text-xl font-bold text-slate-800">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
               <p class="text-sm text-slate-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p>
             </div>
          </div>

          <form id="borrowForm" onsubmit="handleBorrow(event)" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div class="md:col-span-3 space-y-2">
                 <label class="text-sm font-semibold text-slate-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å *</label>
                 <input type="text" id="borrowMemberId" list="memberOptions" required class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...">
                 <datalist id="memberOptions"></datalist>
               </div>
               <div class="space-y-2">
                 <label class="text-sm font-semibold text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label>
                 <input type="date" id="borrowDate" required class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50">
               </div>
               <div class="space-y-2">
                 <label class="text-sm font-semibold text-slate-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô (180 ‡∏ß‡∏±‡∏ô)</label>
                 <input type="date" id="dueDate" required class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50">
               </div>
            </div>

            <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100 space-y-4">
               <label class="text-sm font-bold text-emerald-700 flex items-center gap-2"><i class="ph ph-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏∑‡∏°</label>
               <div class="flex gap-2">
                  <input type="text" id="borrowBookIdInput" class="flex-1 p-3 border border-emerald-200 rounded-xl focus:ring-2 focus:ring-emerald-200 outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô B001)">
                  <button type="button" onclick="addToCart()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 shadow-lg shadow-emerald-200">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
               </div>
            </div>

            <div class="overflow-hidden rounded-xl border border-slate-200">
              <table class="data-table">
                <thead><tr class="bg-slate-50"><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="borrowCartTableBody"><tr><td colspan="3" class="text-center py-8 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr></tbody>
              </table>
            </div>

            <div class="space-y-2">
               <label class="text-sm font-semibold text-slate-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
               <textarea id="borrowNotes" class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
            </div>

            <button type="submit" id="borrowSubmitBtn" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-emerald-200 hover:scale-[1.02] transition-transform">üìñ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</button>
          </form>
        </div>
        
        <div class="bg-white p-6 rounded-2xl shadow-sm">
           <h3 class="font-bold text-slate-700 mb-4">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</h3>
           <input type="text" id="searchAvailableBooks" oninput="searchAvailableBooks()" class="w-full p-2 border rounded-lg mb-4 text-sm" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠...">
           <div id="availableBooksList" class="grid grid-cols-1 md:grid-cols-3 gap-3 max-h-60 overflow-y-auto"></div>
        </div>
      </section>

      <section id="return" class="content-section space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
           <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph ph-arrow-u-down-left text-emerald-500"></i> ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
           <input type="text" id="searchBorrowed" class="w-full p-4 border border-slate-200 rounded-xl bg-slate-50 text-lg mb-6 focus:ring-2 focus:ring-emerald-200 outline-none" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°, ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠..." oninput="searchBorrowedBooks()">
           <div id="borrowedBooksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
      </section>

      <section id="books" class="content-section space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-emerald-500">
          <h2 class="text-lg font-bold text-slate-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</h2>
          <form id="bookForm" onsubmit="handleAddBook(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ *</label><input type="text" id="bookId" required class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ *</label><input type="text" id="bookTitle" required class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á *</label><input type="text" id="bookAuthor" required class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *</label>
              <select id="bookCategory" required class="w-full p-2.5 border rounded-lg bg-slate-50">
                 <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option> <option value="‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢">‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</option> <option value="‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô">‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</option> <option value="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option> <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
            </div>
            <div class="space-y-1"><label class="text-sm font-semibold">ISBN</label><input type="text" id="bookISBN" class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="bookQuantity" required min="1" value="1" class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <button type="submit" class="md:col-span-2 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</button>
          </form>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm">
          <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
             <h2 class="text-lg font-bold">üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
             <input type="text" id="searchBooks" class="w-full md:w-64 p-2 border rounded-lg text-sm" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="searchBooks()">
          </div>
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th>‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>ISBN</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
              <tbody id="booksTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="members" class="content-section space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-500">
          <h2 class="text-lg font-bold text-slate-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
          <form id="memberForm" onsubmit="handleAddMember(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å *</label><input type="text" id="memberId" required class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="memberName" required class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="memberEmail" class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1"><label class="text-sm font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label><input type="tel" id="memberPhone" required class="w-full p-2.5 border rounded-lg bg-slate-50"></div>
            <div class="space-y-1 md:col-span-2"><label class="text-sm font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label>
              <select id="memberType" required class="w-full p-2.5 border rounded-lg bg-slate-50">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option> <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢</option> <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏£‡∏π</option> <option value="‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
              </select>
            </div>
            <button type="submit" class="md:col-span-2 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
          </form>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm">
           <div class="flex flex-col md:flex-row gap-4 mb-4">
              <input type="text" id="searchMembers" class="flex-1 p-2 border rounded-lg text-sm" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™..." oninput="searchMembers()">
              <select id="filterMemberType" class="p-2 border rounded-lg text-sm" onchange="searchMembers()"> <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option> <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢</option> <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏£‡∏π</option> <option value="‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> </select>
           </div>
           <div class="overflow-x-auto">
             <table class="data-table">
               <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
               <tbody id="membersTableBody"></tbody>
             </table>
           </div>
        </div>
      </section>

      <section id="history" class="content-section space-y-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm">
          <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
             <h2 class="text-xl font-bold">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
             <button onclick="exportHistory()" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-black flex items-center gap-2"><i class="ph ph-download-simple"></i> Export CSV</button>
          </div>
          <div class="flex flex-wrap gap-4 mb-4">
             <input type="text" id="searchHistory" class="flex-1 min-w-[200px] p-2 border rounded-lg" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="searchHistory()">
             <select id="filterStatus" class="p-2 border rounded-lg" onchange="searchHistory()"> <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option> <option value="borrowed">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</option> <option value="returned">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option> <option value="overdue">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option> </select>
          </div>
          <div class="overflow-x-auto">
             <table class="data-table">
               <thead><tr><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th><th>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
               <tbody id="historyTableBody"></tbody>
             </table>
          </div>
        </div>
      </section>

    </main>
    
    <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
       <p class="mb-1">¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç</p>
    </footer>

  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 md:hidden z-50 px-2 py-2 flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
     <button onclick="navigateTo('dashboard')" class="nav-button active flex flex-col items-center gap-1 p-2 min-w-[3.5rem] text-slate-400 hover:text-emerald-600 transition" data-target="dashboard">
       <i class="ph ph-house text-2xl"></i> <span class="text-[10px] font-medium">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
     </button>
     
     <button onclick="navigateTo('borrow')" class="nav-button admin-only flex flex-col items-center gap-1 p-2 min-w-[3.5rem] text-slate-400 hover:text-emerald-600 transition" data-target="borrow">
       <i class="ph ph-shopping-cart text-2xl"></i> <span class="text-[10px] font-medium">‡∏¢‡∏∑‡∏°</span>
     </button>
     
     <button onclick="navigateTo('return')" class="nav-button admin-only flex flex-col items-center gap-1 p-2 min-w-[3.5rem] text-slate-400 hover:text-emerald-600 transition" data-target="return">
       <i class="ph ph-arrow-u-down-left text-2xl"></i> <span class="text-[10px] font-medium">‡∏Ñ‡∏∑‡∏ô</span>
     </button>
     
     <button onclick="navigateTo('books')" class="nav-button admin-only flex flex-col items-center gap-1 p-2 min-w-[3.5rem] text-slate-400 hover:text-emerald-600 transition" data-target="books">
       <i class="ph ph-books text-2xl"></i> <span class="text-[10px] font-medium">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</span>
     </button>
     
     <button onclick="navigateTo('members')" class="nav-button admin-only flex flex-col items-center gap-1 p-2 min-w-[3.5rem] text-slate-400 hover:text-emerald-600 transition" data-target="members">
       <i class="ph ph-users text-2xl"></i> <span class="text-[10px] font-medium">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
     </button>

     <button onclick="navigateTo('history')" class="nav-button admin-only flex flex-col items-center gap-1 p-2 min-w-[3.5rem] text-slate-400 hover:text-emerald-600 transition" data-target="history">
       <i class="ph ph-clock-counter-clockwise text-2xl"></i> <span class="text-[10px] font-medium">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
     </button>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRS1iie8d2Bj-jxh6n2Y7XcZBoVWOoNxtXIvA6p3rjyx_DnhUyUWR3TqmL7GYwD5Ybiw/exec';
    const ADMIN_PASSWORD = "admin1250240004"; 
    const LOAN_DAYS = 180; 
    
    let books = [], members = [], borrowRecords = [], borrowCart = [], charts = {};
    let isConnected = false, isAdmin = false;

    const defaultConfig = {
      library_name: "üìö ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç",
      admin_name: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
      contact_info: "¬© 2025 ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç <br class='block md:hidden'> <span class='hidden md:inline'>|</span> ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏¢‡∏∏‡∏£‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏Ç‡∏±‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏ö‡∏∏‡∏ç",
    };

    // --- Color Mapping for Categories (UI Badges) ---
    const categoryColors = {
      '‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢': 'bg-pink-100 text-pink-700',
      '‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô': 'bg-orange-100 text-orange-700',
      '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 'bg-sky-100 text-sky-700',
      '‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ': 'bg-purple-100 text-purple-700', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô': 'bg-cyan-100 text-cyan-700',       
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û': 'bg-red-100 text-red-700',         
      '‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï': 'bg-emerald-100 text-emerald-700', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°': 'bg-indigo-100 text-indigo-700',    
      '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'bg-slate-100 text-slate-700'
    };

    // --- Title Text Colors (Matching Badge) ---
    // Globally Accessible
    const categoryTitleColors = {
      '‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢': 'text-pink-600',
      '‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô': 'text-orange-600',
      '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 'text-sky-600',
      '‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ': 'text-purple-700', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô': 'text-cyan-700',       
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û': 'text-red-600',         
      '‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï': 'text-emerald-600', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°': 'text-indigo-700',    
      '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'text-slate-600'
    };

    // --- Color Mapping for Chart (Hex Codes) ---
    const categoryChartColors = {
      '‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢': '#ec4899', 
      '‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô': '#f97316', 
      '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': '#0ea5e9', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ': '#a855f7', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô': '#0891b2', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û': '#ef4444', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï': '#10b981', 
      '‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°': '#6366f1', 
      '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': '#64748b' 
    };

    function formatThaiDate(dateString) {
        if (!dateString) return '-';
        const parts = dateString.split('-'); 
        if (parts.length !== 3) return dateString;
        const year = parseInt(parts[0]) + 543;
        const month = parts[1];
        const day = parts[2];
        return `${day}-${month}-${year}`;
    }

    // --- Helper to get title color by book ID (Updated) ---
    function getTitleColorClass(category) {
        return categoryTitleColors[category] || 'text-slate-700';
    }

    function updateNavUI(targetId) {
        document.querySelectorAll('.nav-button').forEach(b => {
            b.classList.remove('text-emerald-600', 'bg-emerald-50', 'active', 'border-emerald-200');
            b.classList.add('text-slate-600', 'bg-white', 'border-transparent');
            if(b.dataset.target === targetId) {
                b.classList.add('text-emerald-600', 'bg-emerald-50', 'active', 'border-emerald-200');
                b.classList.remove('text-slate-600', 'bg-white', 'border-transparent');
                if(b.querySelector('span')) b.querySelector('span').classList.remove('text-slate-400');
            }
        });
    }

    // ... (Login/Logout/Connection functions remain the same) ...
    function showLoginModal() {
        const overlay = document.createElement('div'); overlay.className = 'loading-overlay'; overlay.id = 'loginOverlay';
        overlay.innerHTML = `<div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative animate-[slideIn_0.2s_ease-out]"><div class="text-4xl mb-4">üîê</div><h3 class="text-xl font-bold mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3><p class="text-slate-500 text-sm mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</p><form onsubmit="handleLogin(event)"><input type="password" id="adminPassword" class="w-full p-3 border border-slate-200 rounded-xl text-center text-lg tracking-widest mb-4 focus:border-emerald-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required><div class="flex gap-2"><button type="button" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200" onclick="document.getElementById('loginOverlay').remove()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 shadow-lg shadow-emerald-200">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div></form></div>`;
        document.body.appendChild(overlay); setTimeout(() => document.getElementById('adminPassword').focus(), 100);
    }
    function handleLogin(e) {
        e.preventDefault(); const pwd = document.getElementById('adminPassword').value;
        if (pwd === ADMIN_PASSWORD) { isAdmin = true; document.getElementById('mainWrapper').classList.add('show-admin'); 
        document.querySelector('.fixed.bottom-0').classList.add('show-admin'); 
        document.getElementById('adminLoginBtn').style.display = 'none'; document.getElementById('adminLogoutBtn').style.display = 'flex'; document.getElementById('loginOverlay').remove(); showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); updateAllViews();
        } else { showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
    }
    function logout() { isAdmin = false; document.getElementById('mainWrapper').classList.remove('show-admin');
    document.querySelector('.fixed.bottom-0').classList.remove('show-admin'); 
    document.getElementById('adminLoginBtn').style.display = 'flex'; document.getElementById('adminLogoutBtn').style.display = 'none'; navigateTo('dashboard'); showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success'); }

    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connectionStatus');
      const iconEl = document.getElementById('statusIcon');
      const textEl = document.getElementById('statusText');
      statusEl.className = 'hidden md:flex px-3 py-1 rounded-full text-xs font-semibold items-center gap-1 transition-all duration-500';
      statusEl.style.opacity = '1';
      if (status === 'connected') { 
          statusEl.classList.add('bg-emerald-100', 'text-emerald-700'); iconEl.innerHTML = '<i class="ph-fill ph-wifi-high"></i>'; textEl.textContent = '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'; isConnected = true; 
          setTimeout(() => { statusEl.style.opacity = '0'; setTimeout(() => statusEl.style.display = 'none', 500); }, 3000);
      } else if (status === 'syncing') { 
          statusEl.classList.add('bg-amber-100', 'text-amber-700'); iconEl.innerHTML = '<i class="ph ph-spinner animate-spin"></i>'; textEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...'; statusEl.style.display = 'flex'; 
      } else { 
          statusEl.classList.add('bg-red-100', 'text-red-700'); iconEl.innerHTML = '<i class="ph-fill ph-wifi-slash"></i>'; textEl.textContent = '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'; isConnected = false; statusEl.style.display = 'flex'; 
      }
    }
    
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
    
    function scriptRequest(params) {
      return new Promise((resolve, reject) => {
        const formData = new FormData(); Object.keys(params).forEach(key => formData.append(key, params[key]));
        fetch(SCRIPT_URL, { method: 'POST', body: formData }).then(r => { if (!r.ok) throw new Error(r.status); return r.json(); }).then(d => { if (d && d.success === false) reject(new Error(d.error)); else resolve(d); }).catch(e => { console.error("Script Error:", e); reject(e); });
      });
    }

    async function loadDataFromSheets() {
      if (isConnected) return; showLoading(); updateConnectionStatus('syncing'); 
      try { const r = await scriptRequest({ action: 'getData' }); if (r && r.success) { books = r.books || []; members = r.members || []; borrowRecords = r.borrowRecords || []; updateConnectionStatus('connected'); updateAllViews(); hideLoading(); showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); return true; } else { throw new Error(r?.error); } } catch (e) { updateConnectionStatus('disconnected'); hideLoading(); showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error'); return false; }
    }

    async function saveToSheets(sheet, data) { try { updateConnectionStatus('syncing'); const r = await scriptRequest({ action: 'saveData', sheet: sheet, data: JSON.stringify(data) }); if (r && r.success) { updateConnectionStatus('connected'); return true; } else { throw new Error(r?.error); } } catch (e) { updateConnectionStatus('disconnected'); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); return false; } }
    async function deleteFromSheets(sheet, id) { try { updateConnectionStatus('syncing'); const r = await scriptRequest({ action: 'deleteData', sheet: sheet, id: id }); if (r && r.success) { updateConnectionStatus('connected'); return true; } else { throw new Error(r?.error); } } catch (e) { updateConnectionStatus('disconnected'); showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); return false; } }

    function showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast toast-${type}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
    function showConfirmModal(title, message, onConfirm) { const overlay = document.createElement('div'); overlay.className = 'loading-overlay'; overlay.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full relative"><h3 class="text-lg font-bold mb-2 text-slate-800">${title}</h3><p class="text-slate-600 mb-6">${message}</p><div class="flex gap-3 justify-end"><button class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200" onclick="this.closest('.loading-overlay').remove()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600" id="confirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div>`; document.body.appendChild(overlay); document.getElementById('confirmBtn').onclick = () => { onConfirm(); overlay.remove(); }; overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); }; }
    function findItem(array, id) { return array.find(item => item.id === id); }
    function showEditModal(title, formHtml, onSave) { const existing = document.getElementById('genericModalOverlay'); if (existing) existing.remove(); const overlay = document.createElement('div'); overlay.className = 'loading-overlay'; overlay.id = 'genericModalOverlay'; overlay.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800">${title}</h3><button onclick="this.closest('.loading-overlay').remove()" class="text-slate-400 hover:text-slate-600">‚úï</button></div><form id="editForm" class="space-y-4"><div class="space-y-4">${formHtml}</div><div class="flex gap-3 pt-4 mt-4 border-t"><button type="button" class="flex-1 py-2.5 rounded-xl bg-slate-100 text-slate-600 font-medium" onclick="this.closest('.loading-overlay').remove()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="flex-1 py-2.5 rounded-xl bg-emerald-500 text-white font-medium hover:bg-emerald-600" id="saveEditBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`; document.body.appendChild(overlay); document.getElementById('editForm').onsubmit = async (e) => { e.preventDefault(); const btn = document.getElementById('saveEditBtn'); btn.disabled = true; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; await onSave(); overlay.remove(); }; overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); }; }

    // ... (Navigation & View Update functions) ...
    function navigateTo(sectionId) { document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); document.getElementById(sectionId).classList.add('active'); updateNavUI(sectionId); if (sectionId === 'books') updateBooksTable(); if (sectionId === 'members') updateMembersTable(); if (sectionId === 'history') updateHistoryTable(); if (sectionId === 'borrow') { updateAvailableBooksList(); const t = new Date(); const d = new Date(); d.setDate(d.getDate()+LOAN_DAYS); document.getElementById('borrowDate').value = t.toISOString().split('T')[0]; document.getElementById('dueDate').value = d.toISOString().split('T')[0]; } if (sectionId === 'return') updateBorrowedBooksList(); if (sectionId === 'dashboard') updateAvailableBooksListPublic(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function updateMemberOptions() { const dl = document.getElementById('memberOptions'); if(dl) dl.innerHTML = members.map(m => `<option value="${m.id} : ${m.name}">`).join(''); }
    function updateAllViews() { updateDashboardStats(); updateAvailableBooksListPublic(); updateMemberOptions(); updateCharts(); if (isAdmin) { updateBooksTable(); updateMembersTable(); updateHistoryTable(); updateAvailableBooksList(); updateBorrowedBooksList(); } }

    function updateDashboardStats() {
      const totalAvailable = books.reduce((s, b) => s + parseInt(b.available), 0);
      const totalBorrowed = borrowRecords.filter(b => b.status === 'borrowed').length;
      const now = new Date(); const todayString = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      const todayBorrows = borrowRecords.filter(b => b.borrowDate === todayString && b.status === 'borrowed').length;
      const overdue = borrowRecords.filter(b => b.status === 'borrowed' && new Date(b.dueDate) < new Date());

      document.getElementById('totalBooks').textContent = books.length; document.getElementById('availableBooks').textContent = totalAvailable;
      document.getElementById('borrowedBooks').textContent = totalBorrowed;
      document.getElementById('overdueBooks').textContent = overdue.length; document.getElementById('totalMembers').textContent = members.length; document.getElementById('todayBorrows').textContent = todayBorrows;
      
      const overdueList = document.getElementById('overdueList');
      if (overdue.length === 0) { overdueList.innerHTML = '<div class="col-span-full text-center py-6 text-emerald-500 bg-emerald-50 rounded-xl">üéâ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</div>';
      } else {
        overdueList.innerHTML = overdue.map(item => {
          const book = books.find(b => b.id === item.bookId); const member = members.find(m => m.id === item.memberId);
          const daysOverdue = Math.floor((new Date() - new Date(item.dueDate)) / (1000 * 60 * 60 * 24));
          const cat = book ? book.category : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
          const titleColor = getTitleColorClass(cat);
          return `<div class="bg-red-50 p-4 rounded-xl border border-red-100 flex justify-between items-center"><div class="overflow-hidden"><div class="font-bold ${titleColor} truncate">${book ? book.title : item.bookId}</div><div class="text-sm text-slate-500">${member ? member.name : item.memberId}</div><div class="text-xs text-red-400 mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${formatThaiDate(item.dueDate)}</div></div><span class="px-3 py-1 bg-white text-red-500 text-xs font-bold rounded-full shadow-sm whitespace-nowrap">‡πÄ‡∏Å‡∏¥‡∏ô ${daysOverdue} ‡∏ß‡∏±‡∏ô</span></div>`;
        }).join('');
      }
    }
    
    function updateAvailableBooksListPublic() {
        const term = document.getElementById('searchAvailableBooksPublic')?.value.toLowerCase() || '';
        const cat = document.getElementById('filterCategoryPublic')?.value || '';
        let list = books.filter(b => parseInt(b.available) > 0 && (b.id.toLowerCase().includes(term) || b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term)) && (!cat || b.category === cat));
        const container = document.getElementById('availableBooksListPublic');
        if (list.length === 0) { container.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center py-10 text-slate-400"><i class="ph ph-books text-4xl mb-2"></i><span>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span></div>'; return; }
        
        container.innerHTML = list.map(b => {
            const badgeColor = categoryColors[b.category] || 'bg-slate-100 text-slate-700';
            const titleColor = categoryTitleColors[b.category] || 'text-slate-700';
            
            return `
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all duration-300 group cursor-pointer relative overflow-hidden flex flex-col justify-between h-full">
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <span class="${badgeColor} px-3 py-1 rounded-xl text-[11px] font-bold tracking-wide">${b.category}</span>
                        <span class="text-xs font-bold text-slate-400 tracking-wider">${b.id}</span>
                    </div>
                    <h3 class="text-lg font-bold ${titleColor} mb-1 line-clamp-2 leading-tight transition-colors">${b.title}</h3>
                    <p class="text-sm text-slate-400 font-medium">${b.author}</p>
                </div>
                <div class="flex justify-between items-end mt-6 pt-4 border-t border-slate-50">
                    <span class="text-xs text-slate-400 font-medium">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                    <span class="bg-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm shadow-emerald-200">
                        ${b.available} ‡πÄ‡∏•‡πà‡∏°
                    </span>
                </div>
            </div>`;
        }).join('');
    }
    function searchAvailableBooksPublic() { updateAvailableBooksListPublic(); }

    async function handleAddBook(event) {
      event.preventDefault();
      const id = document.getElementById('bookId').value;
      if (books.some(b => b.id === id)) { showToast('‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return; }
      const q = parseInt(document.getElementById('bookQuantity').value);
      const b = { id: id, title: document.getElementById('bookTitle').value, author: document.getElementById('bookAuthor').value, category: document.getElementById('bookCategory').value, isbn: document.getElementById('bookISBN').value || '', quantity: q, available: q, timestamp: Date.now() };
      const btn = event.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const s = await saveToSheets('books', b); if (s) { books.push(b); updateAllViews(); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); event.target.reset(); } btn.disabled = false; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠';
    }

    async function handleAddMember(event) {
      event.preventDefault();
      const id = document.getElementById('memberId').value;
      if (members.some(m => m.id === id)) { showToast('‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return; }
      const m = { id: id, name: document.getElementById('memberName').value, email: document.getElementById('memberEmail').value || '', phone: document.getElementById('memberPhone').value, type: document.getElementById('memberType').value, timestamp: Date.now() };
      const btn = event.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const s = await saveToSheets('members', m); if (s) { members.push(m); updateAllViews(); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); event.target.reset(); } btn.disabled = false; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
    }

    function addToCart() {
        const input = document.getElementById('borrowBookIdInput');
        const id = input.value.trim(); if (!id) return;
        const book = books.find(b => b.id === id); if (!book) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', 'warning'); return; }
        const inCart = borrowCart.filter(i => i.id === id).length;
        if (parseInt(book.available) - inCart <= 0) { showToast('‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return; }
        borrowCart.push(book);
        input.value = ''; input.focus(); updateCartTable();
    }
    function removeFromCart(i) { borrowCart.splice(i, 1); updateCartTable(); }
    
    function updateCartTable() {
        const tbody = document.getElementById('borrowCartTableBody');
        const btn = document.getElementById('borrowSubmitBtn');
        if (borrowCart.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</td></tr>';
        btn.innerHTML = 'üìñ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠'; return; }
        
        tbody.innerHTML = borrowCart.map((b, i) => {
            const titleColor = getTitleColorClass(b.category);
            return `<tr>
                <td data-label="‡∏£‡∏´‡∏±‡∏™">${b.id}</td>
                <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" class="${titleColor} font-bold">${b.title}</td>
                <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" class="text-center"><button type="button" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition" onclick="removeFromCart(${i})"><i class="ph ph-trash"></i> ‡∏•‡∏ö</button></td>
            </tr>`;
        }).join('');
        btn.innerHTML = `üìñ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (${borrowCart.length} ‡πÄ‡∏•‡πà‡∏°)`;
    }

    async function handleBorrow(event) {
      event.preventDefault();
      let mid = document.getElementById('borrowMemberId').value; if (mid.includes(':')) mid = mid.split(':')[0].trim();
      const mem = members.find(m => m.id === mid);
      if (!mem) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'warning'); return; }
      if (borrowCart.length === 0) { showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏•‡πà‡∏°', 'warning'); return; }
      const btn = document.getElementById('borrowSubmitBtn'); btn.disabled = true;
      let success = 0, fail = 0;
      for (let i = 0; i < borrowCart.length; i++) {
          const bCart = borrowCart[i];
          btn.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... (${i+1}/${borrowCart.length})`;
          const liveB = books.find(b => b.id === bCart.id);
          if (liveB && parseInt(liveB.available) > 0) {
              const rec = { id: 'BR'+Date.now()+Math.floor(Math.random()*1000), memberId: mid, bookId: liveB.id, bookTitle: liveB.title, borrowDate: document.getElementById('borrowDate').value, dueDate: document.getElementById('dueDate').value, returnDate: '', status: 'borrowed', notes: document.getElementById('borrowNotes').value || '', timestamp: Date.now() };
              const s = await saveToSheets('borrows', rec); if (s) { liveB.available = parseInt(liveB.available)-1; await saveToSheets('books', liveB); borrowRecords.push(rec); success++; } else fail++;
          } else fail++;
      }
      updateAllViews();
      if (fail === 0) { showToast(`‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success} ‡πÄ‡∏•‡πà‡∏°!`, 'success'); borrowCart = []; updateCartTable(); event.target.reset(); const t = new Date();
      const d = new Date(); d.setDate(d.getDate()+LOAN_DAYS); document.getElementById('borrowDate').value = t.toISOString().split('T')[0]; document.getElementById('dueDate').value = d.toISOString().split('T')[0];
      } else { showToast(`‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success}, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${fail}`, 'warning'); borrowCart = []; updateCartTable(); }
      btn.disabled = false;
    }

    function returnBook(bid) {
      const b = borrowRecords.find(i => i.id === bid); if (!b) return;
      showConfirmModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô', `‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: ${b.bookTitle}?`, async () => {
          b.status = 'returned'; b.returnDate = new Date().toISOString().split('T')[0];
          const s = await saveToSheets('borrows', b); if (s) { const book = books.find(k => k.id === b.bookId); if (book) { book.available = parseInt(book.available)+1; await saveToSheets('books', book); } updateAllViews(); showToast('‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); }
      });
    }

    // ... (Edit History/Book/Member functions remain mostly same, just check for color application where needed)
    function editHistory(rid) {
        const r = borrowRecords.find(i => i.id === rid); if (!r) return;
        const m = members.find(k => k.id === r.memberId); const mName = m ? m.name : '-';
        const html = `<input type="hidden" id="editHistoryId" value="${r.id}"><div class="space-y-3"><div class="grid grid-cols-2 gap-2"><div class="bg-slate-50 p-2 rounded"><label class="text-xs text-slate-400">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><div class="text-sm font-semibold text-slate-600">${r.id}</div></div><div class="bg-slate-50 p-2 rounded"><label class="text-xs text-slate-400">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</label><div class="text-sm truncate">${mName}</div></div></div><div class="bg-slate-50 p-2 rounded"><label class="text-xs text-slate-400">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label><div class="text-sm font-medium">${r.bookTitle}</div></div><div><label class="text-sm font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label><input type="date" id="editBorrowDate" value="${r.borrowDate}" class="w-full p-2 border rounded mt-1"></div><div><label class="text-sm font-semibold">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</label><input type="date" id="editDueDate" value="${r.dueDate}" class="w-full p-2 border rounded mt-1"></div><div class="bg-blue-50 p-3 rounded-lg border border-blue-100"><label class="text-sm font-semibold text-blue-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="date" id="editReturnDate" value="${r.returnDate || ''}" class="w-full p-2 border border-blue-200 rounded mt-1 bg-white"></div></div>`;
        showEditModal(`‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥`, html, updateHistoryDetails);
    }
    async function updateHistoryDetails() {
        const id = document.getElementById('editHistoryId').value; const old = borrowRecords.find(r => r.id === id);
        const up = { ...old, borrowDate: document.getElementById('editBorrowDate').value, dueDate: document.getElementById('editDueDate').value, returnDate: document.getElementById('editReturnDate').value };
        up.status = up.returnDate ? 'returned' : 'borrowed';
        const idx = borrowRecords.findIndex(r => r.id === id); if (idx !== -1) borrowRecords[idx] = up;
        showLoading(); const s = await saveToSheets('borrows', up); hideLoading();
        if (s) { updateAllViews(); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); return true; } else { if (idx !== -1) borrowRecords[idx] = old; updateAllViews(); return false; }
    }

    function editBook(bid) {
      const b = findItem(books, bid); if (!b) return;
      const cats = ['‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢','‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ','‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ','‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô','‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û','‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï','‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'].map(c => `<option value="${c}" ${b.category === c ? 'selected' : ''}>${c}</option>`).join('');
      const html = `<input type="hidden" id="editBookId" value="${b.id}"><div class="space-y-3"><div class="space-y-1"><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label><input type="text" id="editBookTitle" value="${b.title}" class="w-full p-2 border rounded"></div><div class="space-y-1"><label class="text-sm">‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á</label><input type="text" id="editBookAuthor" value="${b.author}" class="w-full p-2 border rounded"></div><div class="space-y-1"><label class="text-sm">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="editBookCategory" class="w-full p-2 border rounded">${cats}</select></div><div class="grid grid-cols-2 gap-3"><div class="space-y-1"><label class="text-sm">ISBN</label><input type="text" id="editBookISBN" value="${b.isbn||''}" class="w-full p-2 border rounded"></div><div class="space-y-1"><label class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label><input type="number" id="editBookQuantity" value="${b.quantity}" class="w-full p-2 border rounded" min="1"></div></div></div>`;
      showEditModal(`‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠`, html, updateBookDetails);
    }
    async function updateBookDetails() {
      const id = document.getElementById('editBookId').value; const old = findItem(books, id);
      const newQ = parseInt(document.getElementById('editBookQuantity').value);
      if (newQ < parseInt(old.quantity) - parseInt(old.available)) { showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', 'warning'); return false; }
      const newAv = parseInt(old.available) + (newQ - parseInt(old.quantity));
      const up = { id: id, title: document.getElementById('editBookTitle').value, author: document.getElementById('editBookAuthor').value, category: document.getElementById('editBookCategory').value, isbn: document.getElementById('editBookISBN').value, quantity: newQ, available: newAv, timestamp: old.timestamp };
      const idx = books.findIndex(b => b.id === id); if (idx !== -1) books[idx] = up;
      showLoading(); const s = await saveToSheets('books', up); hideLoading();
      if (s) { updateAllViews(); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); return true; } else { if (idx !== -1) books[idx] = old; updateAllViews(); return false; }
    }

    function editMember(mid) {
      const m = findItem(members, mid); if (!m) return;
      const types = [{v:'‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤',t:'‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤'},{v:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô',t:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô'},{v:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢',t:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢'},{v:'‡∏Ñ‡∏£‡∏π',t:'‡∏Ñ‡∏£‡∏π'},{v:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£',t:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'},{v:'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',t:'‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}].map(t => `<option value="${t.v}" ${m.type === t.v ? 'selected' : ''}>${t.t}</option>`).join('');
      const html = `<input type="hidden" id="editMemberId" value="${m.id}"><div class="space-y-3"><div class="space-y-1"><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="editMemberName" value="${m.name}" class="w-full p-2 border rounded"></div><div class="space-y-1"><label class="text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="editMemberEmail" value="${m.email||''}" class="w-full p-2 border rounded"></div><div class="space-y-1"><label class="text-sm">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="editMemberPhone" value="${m.phone}" class="w-full p-2 border rounded"></div><div class="space-y-1"><label class="text-sm">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="editMemberType" class="w-full p-2 border rounded">${types}</select></div></div>`;
      showEditModal(`‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å`, html, updateMemberDetails);
    }
    async function updateMemberDetails() {
      const id = document.getElementById('editMemberId').value; const old = findItem(members, id);
      const up = { id: id, name: document.getElementById('editMemberName').value, email: document.getElementById('editMemberEmail').value, phone: document.getElementById('editMemberPhone').value, type: document.getElementById('editMemberType').value, timestamp: old.timestamp };
      const idx = members.findIndex(m => m.id === id); if (idx !== -1) members[idx] = up;
      showLoading(); const s = await saveToSheets('members', up); hideLoading();
      if (s) { updateAllViews(); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); return true; } else { if (idx !== -1) members[idx] = old; updateAllViews(); return false; }
    }

    function deleteBook(id) { const b = books.find(i => i.id === id); if (!b) return; if (borrowRecords.some(r => r.bookId === id && r.status === 'borrowed')) { showToast('‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà', 'error'); return; } showConfirmModal('‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', `‡∏•‡∏ö: ${b.title}?`, async () => { const s = await deleteFromSheets('books', id); if (s) { books = books.filter(i => i.id !== id); updateAllViews(); showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); } }); }
    function deleteMember(id) { const m = members.find(i => i.id === id); if (!m) return; if (borrowRecords.some(r => r.memberId === id && r.status === 'borrowed')) { showToast('‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà', 'error'); return; } showConfirmModal('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', `‡∏•‡∏ö: ${m.name}?`, async () => { const s = await deleteFromSheets('members', id); if (s) { members = members.filter(i => i.id !== id); updateAllViews(); showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); } }); }

    // --- Admin Views Update (APPLY COLORS HERE) ---
    function updateBooksTable() {
      const term = document.getElementById('searchBooks')?.value.toLowerCase() || '';
      const list = books.filter(b => b.id.toLowerCase().includes(term) || b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term));
      const tbody = document.getElementById('booksTableBody');
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</td></tr>`; return; }
      
      tbody.innerHTML = list.map(b => {
          const titleColor = getTitleColorClass(b.category);
          return `<tr>
            <td data-label="‡∏£‡∏´‡∏±‡∏™">${b.id}</td>
            <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠"><div class="font-bold ${titleColor}">${b.title}</div></td>
            <td data-label="‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á">${b.author}</td>
            <td data-label="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"><span class="px-2 py-1 bg-slate-100 rounded text-xs">${b.category}</span></td>
            <td data-label="ISBN" class="text-xs text-slate-500">${b.isbn||'-'}</td>
            <td data-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">${b.quantity}</td>
            <td data-label="‡πÄ‡∏´‡∏•‡∏∑‡∏≠" class="font-bold ${parseInt(b.available)>0?'text-emerald-600':'text-red-500'}">${b.available}</td>
            <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-button-group flex gap-2"><button class="p-2 text-blue-600 hover:bg-blue-50 rounded" onclick="editBook('${b.id}')"><i class="ph ph-pencil-simple"></i></button><button class="p-2 text-red-600 hover:bg-red-50 rounded" onclick="deleteBook('${b.id}')"><i class="ph ph-trash"></i></button></div></td>
          </tr>`;
      }).join('');
    }

    function updateMembersTable() {
      const term = document.getElementById('searchMembers')?.value.toLowerCase() || ''; const type = document.getElementById('filterMemberType')?.value || '';
      const list = members.filter(m => (m.id.toLowerCase().includes(term) || m.name.toLowerCase().includes(term)) && (!type || m.type === type));
      const tbody = document.getElementById('membersTableBody');
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</td></tr>`; return; }
      tbody.innerHTML = list.map(m => `<tr><td data-label="‡∏£‡∏´‡∏±‡∏™">${m.id}</td><td data-label="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="font-medium">${m.name}</td><td data-label="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="text-sm">${m.email||'-'}</td><td data-label="‡πÇ‡∏ó‡∏£">${m.phone}</td><td data-label="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"><span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs border border-blue-100">${m.type}</span></td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-button-group flex gap-2"><button class="p-2 text-blue-600 hover:bg-blue-50 rounded" onclick="editMember('${m.id}')"><i class="ph ph-pencil-simple"></i></button><button class="p-2 text-red-600 hover:bg-red-50 rounded" onclick="deleteMember('${m.id}')"><i class="ph ph-trash"></i></button></div></td></tr>`).join('');
    }

    function updateHistoryTable() {
      const term = document.getElementById('searchHistory')?.value.toLowerCase() || ''; const status = document.getElementById('filterStatus')?.value || '';
      let list = borrowRecords.filter(r => {
        const m = members.find(i => i.id === r.memberId); const mName = m ? m.name.toLowerCase() : '';
        const match = r.memberId.toLowerCase().includes(term) || r.bookId.toLowerCase().includes(term) || r.bookTitle.toLowerCase().includes(term) || mName.includes(term);
        let sMatch = true; if (status === 'borrowed') sMatch = r.status === 'borrowed' && new Date(r.dueDate) >= new Date(); else if (status === 'returned') sMatch = r.status === 'returned'; else if (status === 'overdue') sMatch = r.status === 'borrowed' && new Date(r.dueDate) < new Date();
        return match && sMatch;
      });
      list.sort((a, b) => b.timestamp - a.timestamp);
      const tbody = document.getElementById('historyTableBody');
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="9" class="text-center py-6 text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`; return; }
      tbody.innerHTML = list.map(r => {
        let badge = '', cls = ''; const m = members.find(i => i.id === r.memberId); const mName = m ? m.name : '-';
        if (r.status === 'returned') { badge = '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; cls = 'bg-blue-100 text-blue-700'; } else if (new Date(r.dueDate) < new Date()) { badge = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î'; cls = 'bg-red-100 text-red-700'; } else { badge = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°'; cls = 'bg-emerald-100 text-emerald-700'; }
        
        // Find category color for history item
        const book = books.find(b => b.id === r.bookId);
        const cat = book ? book.category : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
        const titleColor = getTitleColorClass(cat);

        return `<tr><td data-label="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">${r.memberId}</td><td data-label="‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°" class="font-medium text-slate-800">${mName}</td><td data-label="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">${r.bookId}</td><td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" class="text-sm font-bold ${titleColor}">${r.bookTitle}</td><td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°">${formatThaiDate(r.borrowDate)}</td><td data-label="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô">${formatThaiDate(r.dueDate)}</td><td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô">${r.returnDate ? formatThaiDate(r.returnDate) : '-'}</td><td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><span class="px-2 py-1 rounded-full text-xs font-bold ${cls}">${badge}</span></td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-button-group flex gap-2 items-center"><button class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded" onclick="editHistory('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>${r.status === 'borrowed' ? `<button class="text-xs bg-emerald-100 text-emerald-700 hover:bg-emerald-200 px-2 py-1 rounded font-bold" onclick="returnBook('${r.id}')">‡∏Ñ‡∏∑‡∏ô</button>` : ''}</div></td></tr>`;
      }).join('');
    }

    // --- Admin Available Books List (Corrected Color) ---
    function updateAvailableBooksList() {
      const term = document.getElementById('searchAvailableBooks')?.value.toLowerCase() || '';
      let list = books.filter(b => parseInt(b.available) > 0 && (b.id.toLowerCase().includes(term) || b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term)));
      const container = document.getElementById('availableBooksList');
      if (list.length === 0) { container.innerHTML = '<div class="text-center py-4 text-slate-400 col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</div>'; return; }
      
      container.innerHTML = list.map(b => {
          const badgeColor = categoryColors[b.category] || 'bg-slate-100 text-slate-700';
          const titleColor = getTitleColorClass(b.category);
          
          return `
          <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all duration-300 group cursor-pointer relative overflow-hidden flex flex-col justify-between h-full" onclick="document.getElementById('borrowBookIdInput').value='${b.id}'; addToCart();">
              <div>
                  <div class="flex justify-between items-start mb-4">
                      <span class="${badgeColor} px-3 py-1 rounded-xl text-[11px] font-bold tracking-wide">${b.category}</span>
                      <span class="text-xs font-bold text-slate-400 tracking-wider">${b.id}</span>
                  </div>
                  <h3 class="text-lg font-bold ${titleColor} mb-1 line-clamp-2 leading-tight transition-colors">${b.title}</h3>
                  <p class="text-sm text-slate-400 font-medium">${b.author}</p>
              </div>
              <div class="flex justify-between items-end mt-6 pt-4 border-t border-slate-50">
                  <span class="text-xs text-slate-400 font-medium">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                  <span class="bg-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm shadow-emerald-200">
                      ${b.available} ‡πÄ‡∏•‡πà‡∏°
                  </span>
              </div>
          </div>`;
      }).join('');
    }

    function updateBorrowedBooksList() {
      const term = document.getElementById('searchBorrowed')?.value.toLowerCase() || '';
      let list = borrowRecords.filter(b => b.status === 'borrowed').filter(b => {
        const m = members.find(i => i.id === b.memberId); const mName = m ? m.name.toLowerCase() : '';
        return b.memberId.toLowerCase().includes(term) || b.bookId.toLowerCase().includes(term) || b.bookTitle.toLowerCase().includes(term) || mName.includes(term);
      });
      list.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      const container = document.getElementById('borrowedBooksList');
      if (list.length === 0) { container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400"><i class="ph ph-tray text-4xl mb-2"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</div>'; return; }
      
      container.innerHTML = list.map(b => {
        const m = members.find(i => i.id === b.memberId); const isOver = new Date(b.dueDate) < new Date();
        
        // Find category color
        const book = books.find(k => k.id === b.bookId);
        const cat = book ? book.category : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
        const titleColor = getTitleColorClass(cat);

        return `<div class="bg-white p-5 rounded-2xl shadow-sm border ${isOver ? 'border-red-200' : 'border-slate-100'} hover:shadow-md transition"><div class="flex justify-between items-start mb-3"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold">${b.memberId.substring(0,2)}</div><div><div class="font-bold text-slate-800 text-sm">${m ? m.name : b.memberId}</div><div class="text-xs text-slate-400">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</div></div></div><span class="px-2 py-1 rounded text-xs font-bold ${isOver ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">${isOver ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°'}</span></div><h4 class="font-bold ${titleColor} mb-1">${b.bookTitle}</h4><p class="text-xs text-slate-400 mb-4">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${formatThaiDate(b.dueDate)}</p><button onclick="returnBook('${b.id}')" class="w-full py-2 rounded-xl bg-emerald-50 text-emerald-600 font-bold text-sm hover:bg-emerald-500 hover:text-white transition flex items-center justify-center gap-2"><i class="ph ph-arrow-u-down-left"></i> ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</button></div>`;
      }).join('');
    }

    function searchBooks() { updateBooksTable(); } function searchMembers() { updateMembersTable(); } function searchHistory() { updateHistoryTable(); } function searchAvailableBooks() { updateAvailableBooksList(); } function searchBorrowedBooks() { updateBorrowedBooksList(); }

    function exportHistory() {
      if (borrowRecords.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning'); return; }
      const headers = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°', '‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°', '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
      const csv = borrowRecords.map(r => {
        let st = r.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (new Date(r.dueDate) < new Date() ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°'); const m = members.find(i => i.id === r.memberId); const mn = m ? m.name : '-';
        return [r.memberId, `"${mn}"`, r.bookId, `"${r.bookTitle.replace(/"/g, '""')}"`, r.borrowDate, r.dueDate, r.returnDate || '', st].join(',');
      }).join('\n');
      const blob = new Blob(["\ufeff", headers.join(',') + '\n' + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `library_history_${new Date().toISOString().split('T')[0]}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    
    function initializeCharts() {
      Chart.defaults.font.family = "'Prompt', sans-serif";
      Chart.defaults.color = '#64748b';
      Chart.defaults.font.size = 14;

      const lineOpts = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: '#f1f5f9' },
            ticks: { font: { family: "'Prompt', sans-serif" }, precision: 0 }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: "'Prompt', sans-serif" } }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            titleFont: { family: "'Prompt', sans-serif" },
            bodyFont: { family: "'Prompt', sans-serif" }
          }
        }
      };

      const barOpts = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            grid: { color: '#f1f5f9' },
            ticks: { font: { family: "'Prompt', sans-serif" }, precision: 0 }
          },
          y: {
            grid: { display: false },
            ticks: { font: { family: "'Prompt', sans-serif" }, autoSkip: false }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            titleFont: { family: "'Prompt', sans-serif" },
            bodyFont: { family: "'Prompt', sans-serif" }
          }
        }
      };

      if (charts.borrow) charts.borrow.destroy();
      charts.borrow = new Chart(document.getElementById('borrowChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: '‡∏¢‡∏∑‡∏°', data: [], backgroundColor: 'rgba(16, 185, 129, 0.1)', borderColor: '#10b981', borderWidth: 2, pointBackgroundColor: '#ffffff', pointBorderColor: '#10b981', fill: true, tension: 0.4 }] }, options: lineOpts });
      if (charts.popular) charts.popular.destroy(); 
      charts.popular = new Chart(document.getElementById('popularChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: [], backgroundColor: [], borderRadius: 6 }] }, options: barOpts });
    }

    function updateCharts() {
      if (!charts.borrow || !charts.popular) return;
      const last7 = [], counts = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
        const ds = `${y}-${m}-${day}`; last7.push(`${d.getDate()}/${d.getMonth() + 1}`);
        counts.push(borrowRecords.filter(b => b.borrowDate === ds).length);
      }
      charts.borrow.data.labels = last7; charts.borrow.data.datasets[0].data = counts; charts.borrow.update();
      
      const bc = {}; 
      borrowRecords.forEach(b => bc[b.bookTitle] = (bc[b.bookTitle] || 0) + 1);
      const topBooks = Object.entries(bc).sort((a, b) => b[1] - a[1]).slice(0, 10);
      
      const labels = topBooks.map(b => b[0]);
      const data = topBooks.map(b => b[1]);
      
      // Update: Determine chart colors based on book category
      const backgroundColors = labels.map(title => {
          const book = books.find(b => b.title === title);
          const category = book ? book.category : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
          return categoryChartColors[category] || '#cbd5e1'; 
      });

      charts.popular.data.labels = labels; 
      charts.popular.data.datasets[0].data = data; 
      charts.popular.data.datasets[0].backgroundColor = backgroundColors; // Apply dynamic colors
      charts.popular.update();
    }

    function onConfigChange(c) { document.getElementById('headerTitle').textContent = c.library_name || defaultConfig.library_name; document.getElementById('headerSubtitle').textContent = c.admin_name || defaultConfig.admin_name;
    document.querySelector('footer p.mb-1').innerHTML = c.contact_info || defaultConfig.contact_info; }
    function initializeApp() { if (typeof elementSDK !== 'undefined') elementSDK.config.onConfigChange(onConfigChange);
    else onConfigChange(defaultConfig); initializeCharts(); loadDataFromSheets(); updateAvailableBooksListPublic(); }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initializeApp); else initializeApp();
  </script>
</body>
</html>
