
<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Big Data ‡∏™‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏î‡∏≠‡∏¢‡∏´‡∏•‡πà‡∏≠</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      box-sizing: border-box;
    }
   
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
   
    body {
      font-family: 'Kanit', sans-serif;
      min-height: 100%;
      overflow-x: hidden;
    }

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏≤‡∏¢-‡∏´‡∏ç‡∏¥‡∏á */
.gender-level-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.gender-level-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.progress-bar-fill {
  transition: width 0.8s ease-in-out;
}

.gender-total-section {
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

    .container {
      display: flex;
      min-height: 100%;
      max-width: 100%;
    }
    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #4A2C6D 0%, #2C1A4D 100%);
      color: white;
      position: fixed;
      height: 100%;
      left: 0;
      top: 0;
      transition: transform 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 4px 0 20px rgba(0,0,0,0.3);
    }
    .sidebar.hidden {
      transform: translateX(-100%);
    }
    .logo-section {
      padding: 30px 20px;
      text-align: center;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .logo {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .network-name {
      font-size: 18px;
      font-weight: 600;
      margin-top: 10px;
      color: #FFCA28;
    }
    .affiliation-name {
      font-size: 14px;
      font-weight: 400;
      margin-top: 8px;
      color: rgba(255,255,255,0.8);
      line-height: 1.3;
    }
    .menu-section {
      padding: 20px 0;
    }
    .menu-title {
      padding: 15px 20px;
      font-size: 12px;
      font-weight: 600;
      color: #AED581;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .menu-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(255,255,255,0.8);
      border-left: 4px solid transparent;
    }
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      border-left-color: #26A69A;
    }
    .menu-item.active {
      background: rgba(38,166,154,0.2);
      color: white;
      border-left-color: #26A69A;
      font-weight: 600;
    }
    .menu-icon {
      font-size: 24px;
    }
    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 30px;
      transition: margin-left 0.3s ease;
    }
    .main-content.expanded {
      margin-left: 0;
    }
    .top-bar {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .menu-toggle {
      display: none;
      background: #26A69A;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 24px;
      transition: all 0.3s ease;
    }
    .menu-toggle:hover {
      background: #1e8a7f;
      transform: scale(1.05);
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .user-avatar {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #26A69A, #AED581);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .logout-btn {
      background: #EF5350;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Kanit', sans-serif;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      background: #D32F2F;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239,83,80,0.4);
    }
    /* Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }
    .stat-card.schools {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .stat-card.teachers {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    .stat-card.students {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    .stat-card.schools .stat-value,
    .stat-card.teachers .stat-value,
    .stat-card.students .stat-value {
      color: white;
    }
    .stat-card.schools .stat-label,
    .stat-card.teachers .stat-label,
    .stat-card.students .stat-label {
      color: rgba(255,255,255,0.9);
    }
    .stat-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #4A2C6D;
      margin-bottom: 5px;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    /* Forms */
    .form-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group label {
      font-weight: 500;
      color: #4A2C6D;
      font-size: 14px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-family: 'Kanit', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #26A69A;
      box-shadow: 0 0 0 3px rgba(38,166,154,0.1);
    }
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-family: 'Kanit', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: #26A69A;
      color: white;
    }
    .btn-primary:hover {
      background: #1e8a7f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(38,166,154,0.4);
    }
    .btn-success {
      background: #AED581;
      color: #4A2C6D;
    }
    .btn-success:hover {
      background: #9CCC65;
      transform: translateY(-2px);
    }
    .btn-danger {
      background: #EF5350;
      color: white;
    }
    .btn-danger:hover {
      background: #D32F2F;
      transform: translateY(-2px);
    }
    .btn-warning {
      background: #FFCA28;
      color: #4A2C6D;
    }
    .btn-warning:hover {
      background: #FBC02D;
      transform: translateY(-2px);
    }
    /* Tables */
    .table-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background: linear-gradient(135deg, #26A69A, #AED581);
      color: white;
    }
    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }
    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    tbody tr:hover {
      background: #f8f9fa;
    }
    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
    }
    .badge-success {
      background: #AED581;
      color: #4A2C6D;
    }
    .badge-info {
      background: #0288D1;
      color: white;
    }
    .badge-warning {
      background: #FFCA28;
      color: #4A2C6D;
    }
    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #4A2C6D;
      margin-bottom: 20px;
      text-align: center;
    }
    .chart-wrapper {
      position: relative;
      height: 250px;
    }
    /* Progress Bars */
    .progress-item {
      margin-bottom: 20px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
      color: #4A2C6D;
    }
    .progress-bar-container {
      height: 12px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #26A69A, #AED581);
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-overlay.active {
      display: flex;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: #26A69A;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    .modal-title {
      font-size: 24px;
      font-weight: 600;
      color: #4A2C6D;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      transition: color 0.3s ease;
    }
    .modal-close:hover {
      color: #EF5350;
    }
    .page-content {
      display: none;
    }
    .page-content.active {
      display: block;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .menu-toggle {
        display: block;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: #4A2C6D;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .iframe-container {
      width: 100%;
      height: 400px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
    }
    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .multi-select-container {
      position: relative;
    }
    .multi-select-display {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      min-height: 45px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }
    .multi-select-tag {
      background: #26A69A;
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .multi-select-tag button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      line-height: 1;
    }
    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      margin-top: 5px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .multi-select-dropdown.active {
      display: block;
    }
    .multi-select-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .multi-select-option:hover {
      background: #f0f0f0;
    }
    .multi-select-option input {
      margin-right: 8px;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ */
.range-card {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.range-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  border-color: #e0e0e0;
}

.range-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--card-color, #4A2C6D), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.range-card:hover::before {
  opacity: 1;
}

.progress-bar-fill {
  position: relative;
  overflow: hidden;
}

.progress-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.range-stats-grid {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="loading-overlay" id="loadingOverlay">
   <div class="spinner"></div>
  </div>
  <div class="container"><!-- Sidebar -->
   <div class="sidebar" id="sidebar">
    <div class="logo-section">
     <div class="logo" id="logoDisplay">
      üìä
     </div>
     <div class="network-name" id="networkNameDisplay">
      ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢
     </div>
     <div class="affiliation-name" id="affiliationDisplay">
      ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
     </div>
    </div>
    <div class="menu-section" id="guestMenu">
     <div class="menu-title">
      üìã ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
     </div>
     <div class="menu-item active" data-page="home"><span class="menu-icon">üè†</span> <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
     </div>
     <div class="menu-item" data-page="school-info"><span class="menu-icon">üè´</span> <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
     </div>
     <div class="menu-item" data-page="teacher-info"><span class="menu-icon">üë®‚Äçüè´</span> <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</span>
     </div>
     <div class="menu-item" data-page="student-info"><span class="menu-icon">üë®‚Äçüéì</span> <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
     </div>
     <div class="menu-title">
      üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
     </div>
     <div class="menu-item" data-page="login"><span class="menu-icon">üîë</span> <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
     </div>
    </div>
    <div class="menu-section" id="adminMenu" style="display: none;">
     <div class="menu-title">
      ‚öôÔ∏è ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
     </div>
     <div class="menu-item" data-page="admin-settings"><span class="menu-icon">‚öôÔ∏è</span> <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
     </div>
     <div class="menu-item" data-page="admin-users"><span class="menu-icon">üë•</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin</span>
     </div>
     <div class="menu-item" data-page="school-admins"><span class="menu-icon">üè´</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
     </div>
     <div class="menu-item" data-page="manage-levels"><span class="menu-icon">üìä</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
     </div>
     <div class="menu-item" data-page="manage-sizes"><span class="menu-icon">üìè</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
     </div>
     <div class="menu-item" data-page="manage-positions"><span class="menu-icon">üíº</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
     </div>
     <div class="menu-item" data-page="manage-semesters"><span class="menu-icon">üìÖ</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
     </div>
    </div>
    <div class="menu-section" id="schoolAdminMenu" style="display: none;">
     <div class="menu-title">
      üè´ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
     </div>
     <div class="menu-item" data-page="school-general"><span class="menu-icon">üìù</span> <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
     </div>
     <div class="menu-item" data-page="school-students"><span class="menu-icon">üë®‚Äçüéì</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
     </div>
     <div class="menu-item" data-page="school-teachers"><span class="menu-icon">üë®‚Äçüè´</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</span>
     </div>
     <div class="menu-item" data-page="school-users"><span class="menu-icon">üë•</span> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
     </div>
    </div>
   </div><!-- Main Content -->
   <div class="main-content" id="mainContent">
    <div class="top-bar"><button class="menu-toggle" id="menuToggle">‚ò∞</button>
     <h1 id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Big Data</h1>
     <div class="user-info">
      <div class="user-avatar" id="userAvatar">
       üë§
      </div><button class="logout-btn" id="logoutBtn" style="display: none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
     </div>
    </div><!-- Home Page -->
    <div class="page-content active" id="homePage">
     <div class="form-section">
      <div class="form-row">
       <div class="form-group"><label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label> <select id="homeSemester" onchange="loadHomePageBySemester()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option> </select>
       </div>
      </div>
     </div>
     <div class="stats-grid">
      <div class="stat-card schools">
       <div class="stat-icon">
        üè´
       </div>
       <div class="stat-value" id="totalSchools">
        0
       </div>
       <div class="stat-label">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
      <div class="stat-card teachers">
       <div class="stat-icon">
        üë®‚Äçüè´
       </div>
       <div class="stat-value" id="totalTeachers">
        0
       </div>
       <div class="stat-label">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£
       </div>
      </div>
      <div class="stat-card students">
       <div class="stat-icon">
        üë®‚Äçüéì
       </div>
       <div class="stat-value" id="totalStudents">
        0
       </div>
       <div class="stat-label">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </div>
      </div>
     </div>
     <div class="charts-grid">
      <div class="chart-card">
       <div class="chart-title">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö
       </div>
       <div class="chart-wrapper">
        <canvas id="levelChart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <div class="chart-title">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î
       </div>
       <div class="chart-wrapper">
        <canvas id="sizeChart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <div class="chart-title">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö
       </div>
       <div class="chart-wrapper">
        <canvas id="studentLevelChart"></canvas>
       </div>
      </div>

<div class="chart-card">
  <div class="chart-title">
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
  </div>
  <div class="chart-wrapper">
    <canvas id="positionChart"></canvas>
  </div>
</div>

     </div>
     
     <div class="table-container">
  <h3 class="section-title">üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
  <div id="studentRangeStats"></div>
</div>

<div class="table-container" style="margin-top: 30px; border-top: 2px solid #f0f0f0; padding-top: 25px;">
  <h3 class="section-title">üë¶üëß ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®</h3>
  <div id="studentGenderStats"></div>
</div>

    </div><!-- School Info Page -->
    <div class="page-content" id="schoolInfoPage">
     <div class="form-section">
      <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <select id="schoolSelect"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option> </select>
      </div>
     </div>
     <div id="schoolDetails" style="display: none;">
      <div class="form-section">
       <h3 class="section-title">üè´ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
       <div class="form-row">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <input type="text" id="viewSchoolName" readonly>
        </div>
        <div class="form-group"><label>‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</label> <input type="text" id="viewSchoolLevels" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <input type="text" id="viewSchoolSize" readonly>
        </div>
        <div class="form-group"><label>SMIS 8 ‡∏´‡∏•‡∏±‡∏Å</label> <input type="text" id="viewSmis" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á 10 ‡∏´‡∏•‡∏±‡∏Å</label> <input type="text" id="viewMinistry" readonly>
        </div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠ (‡πÑ‡∏ó‡∏¢)</label> <input type="text" id="viewNameTh" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label> <input type="text" id="viewNameEn" readonly>
        </div>
        <div class="form-group"><label>‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label> <input type="text" id="viewMoo" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏ñ‡∏ô‡∏ô</label> <input type="text" id="viewRoad" readonly>
        </div>
        <div class="form-group"><label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label> <input type="text" id="viewVillage" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏ï‡∏≥‡∏ö‡∏•</label> <input type="text" id="viewSubdistrict" readonly>
        </div>
        <div class="form-group"><label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label> <input type="text" id="viewDistrict" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label> <input type="text" id="viewProvince" readonly>
        </div>
        <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label> <input type="text" id="viewPostcode" readonly>
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label> <input type="text" id="viewPhone" readonly>
        </div>
        <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå</label> <input type="text" id="viewEmail" readonly>
        </div>
       </div>
       <div class="form-group"><label>‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</label>
        <div style="display: flex; align-items: center; gap: 10px;"><input type="text" id="viewWebsite" readonly style="flex: 1;"> <button id="websiteBtn" class="btn btn-primary" style="display: none; padding: 8px 12px;" onclick="openWebsite()"> üåê ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå </button>
        </div>
       </div>
       <div class="form-group"><label>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</label>
        <div class="iframe-container" id="mapContainer"></div>
       </div>
      </div>
     </div>
    </div><!-- Teacher Info Page -->
    <div class="page-content" id="teacherInfoPage">
     <div class="form-section">
      <div class="form-row">
       <div class="form-group"><label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label> <select id="teacherSemester"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option> </select>
       </div>
       <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <select id="teacherSchoolSelect"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option> </select>
       </div>
      </div>
     </div>
     <div class="table-container" id="teacherTableContainer" style="display: none;">
      <h3 class="section-title">üë®‚Äçüè´ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
         <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
         <th>‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</th>
        </tr>
       </thead>
       <tbody id="teacherTableBody"></tbody>
      </table>
     </div>
    </div><!-- Student Info Page -->
    <div class="page-content" id="studentInfoPage">
     <div class="form-section">
      <div class="form-row">
       <div class="form-group"><label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label> <select id="studentSemester"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option> </select>
       </div>
       <div class="form-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <select id="studentSchoolSelect"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option> </select>
       </div>
      </div>
     </div>
     <div class="table-container" id="studentTableContainer" style="display: none;">
      <h3 class="section-title">üë®‚Äçüéì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
         <th>‡∏ä‡∏≤‡∏¢</th>
         <th>‡∏´‡∏ç‡∏¥‡∏á</th>
         <th>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
        </tr>
       </thead>
       <tbody id="studentTableBody"></tbody>
      </table>
     </div>
    </div><!-- Login Page -->
    <div class="page-content" id="loginPage">
     <div class="form-section" style="max-width: 500px; margin: 50px auto;">
      <h3 class="section-title">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="loginUsername" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
      </div>
      <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="loginPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
      </div><button class="btn btn-primary" onclick="handleLogin()" style="width: 100%; margin-top: 20px;"> üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
     </div>
    </div><!-- Admin Settings Page -->
    <div class="page-content" id="adminSettingsPage">
     <div class="form-section">
      <h3 class="section-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</label> <input type="text" id="networkNameInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢">
      </div>
      <div class="form-group"><label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label> <input type="text" id="affiliationInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
      </div>
      <div class="form-group"><label>‡πÇ‡∏•‡πÇ‡∏Å‡πâ</label>
       <div style="display: flex; gap: 15px; align-items: flex-start;">
        <div style="flex: 1;"><input type="file" id="logoFileInput" accept="image/*" onchange="previewLogo()" style="margin-bottom: 10px;"> <input type="text" id="logoInput" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å Emoji ‡πÄ‡∏ä‡πà‡∏ô üìä" maxlength="2">
        </div>
        <div style="width: 80px; height: 80px; border: 2px dashed #e0e0e0; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #f9f9f9;">
         <div id="logoPreview" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 40px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          üìä
         </div>
        </div>
       </div>
      </div><button class="btn btn-success" onclick="saveSystemSettings()"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ </button>
     </div>
    </div><!-- Admin Users Page -->
    <div class="page-content" id="adminUsersPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddAdminModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="adminUsersTableBody"></tbody>
      </table>
     </div>
    </div><!-- School Admins Page -->
    <div class="page-content" id="schoolAdminsPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddSchoolAdminModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üè´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="schoolAdminsTableBody"></tbody>
      </table>
     </div>
    </div><!-- Manage Levels Page -->
    <div class="page-content" id="manageLevelsPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddLevelModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="levelsTableBody"></tbody>
      </table>
     </div>
    </div><!-- Manage Sizes Page -->
    <div class="page-content" id="manageSizesPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddSizeModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üìè ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="sizesTableBody"></tbody>
      </table>
     </div>
    </div><!-- Manage Positions Page -->
    <div class="page-content" id="managePositionsPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddPositionModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üíº ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="positionsTableBody"></tbody>
      </table>
     </div>
    </div><!-- School General Page -->
    <div class="page-content" id="schoolGeneralPage">
     <div class="form-section">
      <h3 class="section-title">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
      <div class="form-group"><label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label> <select id="schoolGeneralSemester" onchange="loadSchoolGeneralBySemester()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option> </select>
      </div>
      <div id="schoolGeneralForm" style="display: none;">
       <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <input type="text" id="editSchoolName" readonly>
       </div>
       <div class="form-group"><label>‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
        <div class="multi-select-container">
         <div class="multi-select-display" id="levelMultiSelect" onclick="toggleLevelDropdown()"><span style="color: #999;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö...</span>
         </div>
         <div class="multi-select-dropdown" id="levelDropdown"></div>
        </div>
       </div>
       <div class="form-group"><label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label> <select id="editSchoolSize"></select>
       </div>
       <div class="form-row">
        <div class="form-group"><label>SMIS 8 ‡∏´‡∏•‡∏±‡∏Å</label> <input type="text" id="editSmis" maxlength="8">
        </div>
        <div class="form-group"><label>‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á 10 ‡∏´‡∏•‡∏±‡∏Å</label> <input type="text" id="editMinistry" maxlength="10">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠ (‡πÑ‡∏ó‡∏¢)</label> <input type="text" id="editNameTh">
        </div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠ (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label> <input type="text" id="editNameEn">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label> <input type="text" id="editMoo">
        </div>
        <div class="form-group"><label>‡∏ñ‡∏ô‡∏ô</label> <input type="text" id="editRoad">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label> <input type="text" id="editVillage">
        </div>
        <div class="form-group"><label>‡∏ï‡∏≥‡∏ö‡∏•</label> <input type="text" id="editSubdistrict">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label> <input type="text" id="editDistrict">
        </div>
        <div class="form-group"><label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label> <input type="text" id="editProvince">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label> <input type="text" id="editPostcode" maxlength="5">
        </div>
        <div class="form-group"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label> <input type="text" id="editPhone">
        </div>
       </div>
       <div class="form-row">
        <div class="form-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå</label> <input type="email" id="editEmail">
        </div>
        <div class="form-group"><label>‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</label> <input type="text" id="editWebsite">
        </div>
       </div>
       <div class="form-group"><label>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Google Maps Link)</label> <input type="text" id="editMapLink" placeholder="https://www.google.com/maps/embed?...">
       </div><button class="btn btn-success" onclick="saveSchoolGeneral()"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
      </div>
     </div>
    </div><!-- School Students Page -->
    <div class="page-content" id="schoolStudentsPage">
     <div class="form-section">
      <h3 class="section-title">üë®‚Äçüéì ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <div class="form-group"><label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label> <select id="schoolStudentSemester" onchange="loadSchoolStudentsBySemester()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option> </select>
      </div>
      <div id="studentLevelForms"></div><button class="btn btn-success" onclick="saveStudentCounts()" id="saveStudentBtn" style="display: none;"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
     </div>
    </div><!-- Manage Semesters Page -->
    <div class="page-content" id="manageSemestersPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddSemesterModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
         <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="semestersTableBody"></tbody>
      </table>
     </div>
    </div><!-- Manage Semesters Page -->
    <div class="page-content" id="manageSemestersPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddSemesterModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
         <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="semestersTableBody"></tbody>
      </table>
     </div>
    </div><!-- School Teachers Page -->
    <div class="page-content" id="schoolTeachersPage">
     <div class="form-section">
      <div class="form-group"><label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label> <select id="schoolTeacherSemester" onchange="loadSchoolTeachersBySemester()"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option> </select>
      </div>
     </div>
     <div class="action-buttons" id="teacherActionButtons" style="display: none;"><button class="btn btn-primary" onclick="openAddTeacherModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ </button>
     </div>
     <div class="table-container" id="schoolTeachersTableContainer" style="display: none;">
      <h3 class="section-title">üë®‚Äçüè´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
         <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
         <th>‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="schoolTeachersTableBody"></tbody>
      </table>
     </div>
    </div><!-- School Users Page -->
    <div class="page-content" id="schoolUsersPage">
     <div class="action-buttons"><button class="btn btn-primary" onclick="openAddSchoolUserModal()"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô </button>
     </div>
     <div class="table-container">
      <h3 class="section-title">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
      <table>
       <thead>
        <tr>
         <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
         <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
         <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
       </thead>
       <tbody id="schoolUsersTableBody"></tbody>
      </table>
     </div>
    </div>
   </div>
  </div><!-- Modals -->
  <div class="modal" id="genericModal">
   <div class="modal-content">
    <div class="modal-header">
     <h3 class="modal-title" id="modalTitle">Modal</h3><button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div id="modalBody"></div>
   </div>
  </div>
 <script>
  // Chart instances for proper cleanup
let chartInstances = {
  levelChart: null,
  sizeChart: null, 
  studentLevelChart: null,
  positionChart: null // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
};

  // Helper for google.script.run promises
  function getPromise(methodName, ...args) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler((err) => {
          console.error(err);
          reject(err);
        })[methodName](...args);
    });
  }

  // Data access helpers
  const getSystemSettings = () => getPromise('getSystemSettings');
  const setSystemSettings = (settings) => getPromise('setSystemSettings', settings);
  const getData = (sheetName) => getPromise('getData', sheetName);
  const setData = (sheetName, data) => getPromise('setData', sheetName, data);
  const addItem = (sheetName, item) => getPromise('addItem', sheetName, item);
  const updateItem = (sheetName, id, item) => getPromise('updateItem', sheetName, id, item);
  const deleteItem = (sheetName, id) => getPromise('deleteItem', sheetName, id);
  const uploadLogo = (base64, mimeType, fileName) => getPromise('uploadLogo', base64, mimeType, fileName);
  const handleLoginServer = (username, password) => getPromise('handleLogin', username, password);
  const deleteSchool = (schoolId) => getPromise('deleteSchool', schoolId);

  // Loading overlay functions
  function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
  }
  function hideLoading() {
    setTimeout(() => {
      document.getElementById('loadingOverlay').classList.remove('active');
    }, 500);
  }

  // Menu toggle
  document.getElementById('menuToggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('active');
  });

  // Page navigation
  document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', () => {
      const page = item.getAttribute('data-page');
      navigateToPage(page);

      // Update active menu item
      document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
      item.classList.add('active');

      // Hide sidebar on mobile
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('active');
      }
    });
  });

  async function navigateToPage(page) {
    showLoading();

    // Hide all pages
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));

    // Show selected page
    const pageMap = {
      'home': 'homePage',
      'school-info': 'schoolInfoPage',
      'teacher-info': 'teacherInfoPage',
      'student-info': 'studentInfoPage',
      'login': 'loginPage',
      'admin-settings': 'adminSettingsPage',
      'admin-users': 'adminUsersPage',
      'school-admins': 'schoolAdminsPage',
      'manage-levels': 'manageLevelsPage',
      'manage-sizes': 'manageSizesPage',
      'manage-positions': 'managePositionsPage',
      'manage-semesters': 'manageSemestersPage',
      'school-general': 'schoolGeneralPage',
      'school-students': 'schoolStudentsPage',
      'school-teachers': 'schoolTeachersPage',
      'school-users': 'schoolUsersPage'
    };

    const pageId = pageMap[page];
    if (pageId) {
      document.getElementById(pageId).classList.add('active');

      // Load page-specific data
      switch(page) {
        case 'home':
          await loadHomePage();
          break;
        case 'school-info':
          await loadSchoolInfoPage();
          break;
        case 'teacher-info':
          await loadTeacherInfoPage();
          break;
        case 'student-info':
          await loadStudentInfoPage();
          break;
        case 'admin-settings':
          await loadAdminSettings();
          break;
        case 'admin-users':
          await loadAdminUsers();
          break;
        case 'school-admins':
          await loadSchoolAdmins();
          break;
        case 'manage-levels':
          await loadLevels();
          break;
        case 'manage-sizes':
          await loadSizes();
          break;
        case 'manage-positions':
          await loadPositions();
          break;
        case 'manage-semesters':
          await loadSemesters();
          break;
        case 'school-general':
          await loadSchoolGeneral();
          break;
        case 'school-students':
          await loadSchoolStudents();
          break;
        case 'school-teachers':
          await loadSchoolTeachers();
          break;
        case 'school-users':
          await loadSchoolUsers();
          break;
      }
    }

    hideLoading();
  }

  // Login functionality
  async function handleLogin() {
    showLoading();

    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'
      });
      return;
    }

    const result = await handleLoginServer(username, password);

    if (result) {
      localStorage.setItem('currentUser', JSON.stringify(result));
      updateUIForUser(result.type);
      if (result.type === 'admin') {
        navigateToPage('admin-settings');
        Swal.fire({
          icon: 'success',
          title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
          timer: 1500
        });
      } else if (result.type === 'school') {
        navigateToPage('school-general');
        Swal.fire({
          icon: 'success',
          title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
          timer: 1500
        });
      }
    } else {
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    }

    hideLoading();
  }

  // Logout functionality
  document.getElementById('logoutBtn').addEventListener('click', () => {
    Swal.fire({
      title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then((result) => {
      if (result.isConfirmed) {
        localStorage.setItem('currentUser', JSON.stringify(null));
        updateUIForUser(null);
        navigateToPage('home');
        Swal.fire({
          icon: 'success',
          title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  });

  function updateUIForUser(userType) {
    const guestMenu = document.getElementById('guestMenu');
    const adminMenu = document.getElementById('adminMenu');
    const schoolAdminMenu = document.getElementById('schoolAdminMenu');
    const logoutBtn = document.getElementById('logoutBtn');

    guestMenu.style.display = 'none';
    adminMenu.style.display = 'none';
    schoolAdminMenu.style.display = 'none';
    logoutBtn.style.display = 'none';

    if (userType === 'admin') {
      adminMenu.style.display = 'block';
      logoutBtn.style.display = 'block';
    } else if (userType === 'school') {
      schoolAdminMenu.style.display = 'block';
      logoutBtn.style.display = 'block';
    } else {
      guestMenu.style.display = 'block';
    }
  }

  // Load system settings
  async function loadSystemSettings() {
    const settings = await getSystemSettings();
    document.getElementById('networkNameDisplay').textContent = settings.networkName;
    document.getElementById('affiliationDisplay').textContent = settings.affiliation || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';

    const logoDisplay = document.getElementById('logoDisplay');
    if (settings.logoImage) {
      logoDisplay.innerHTML = `<img src="${settings.logoImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
    } else {
      logoDisplay.textContent = settings.logo;
    }
  }

  // Home page functions
  async function loadHomePage() {
    await loadSemesterSelects();

    // Load data for current semester by default
    const semesters = await getData('semesters');
    const currentSemester = semesters.find(s => s.isCurrent);
    if (currentSemester) {
      document.getElementById('homeSemester').value = currentSemester.id;
      await loadHomePageBySemester();
    } else {
      await loadHomePageBySemester();
    }
  }

async function loadHomePageBySemester() {
  showLoading(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  
  const semesterId = parseInt(document.getElementById('homeSemester').value);

  try {
    const [schools, teachersData, studentsData, schoolSemesters, levels, sizes] = await Promise.all([
      getData('schools'),
      getData('teachers'),
      getData('students'),
      getData('schoolSemesters'),
      getData('levels'),
      getData('sizes')
    ]);

    let teachers = teachersData;
    let students = studentsData;

    if (semesterId) {
      teachers = teachers.filter(t => t.semesterId === semesterId);
      students = students.filter(s => s.semesterId === semesterId);
    }

    document.getElementById('totalSchools').textContent = schools.length;
    document.getElementById('totalTeachers').textContent = teachers.length;

    const totalStudents = students.reduce((sum, s) => sum + (s.male + s.female), 0);
    document.getElementById('totalStudents').textContent = totalStudents;

    // Create charts with filtered data
    createLevelChart(semesterId, schoolSemesters, levels);
    createSizeChart(semesterId, schoolSemesters, sizes);
    createStudentLevelChart(students, levels);
    createStudentRangeStats(schools, students);
    createPositionChart(semesterId);
    createStudentGenderStats(students, levels);
  } catch (error) {
    console.error('Error loading home page data:', error);
    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
    });
  } finally {
    hideLoading(); // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  }
}
  function createLevelChart(semesterId, schoolSemesters, levels) {
  const ctx = document.getElementById('levelChart');

  if (chartInstances.levelChart) {
    chartInstances.levelChart.destroy();
  }

  const levelCounts = {};
  levels.forEach(l => levelCounts[l.name] = 0);

  let filteredSemesters = schoolSemesters;
  if (semesterId) {
    filteredSemesters = schoolSemesters.filter(ss => ss.semesterId === semesterId);
  }

  filteredSemesters.forEach(schoolSemester => {
    if (schoolSemester.levels) {
      schoolSemester.levels.forEach(levelId => {
        const level = levels.find(l => l.id === levelId);
        if (level) levelCounts[level.name]++;
      });
    }
  });

  const totalSchools = filteredSemesters.length;
  const labels = Object.keys(levelCounts);
  const data = Object.values(levelCounts);
  const percentages = data.map(count => totalSchools > 0 ? Math.round((count / totalSchools) * 100) : 0);

  // ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö
  const levelColors = {
    '‡∏õ‡∏ê‡∏°‡∏ß‡∏±‡∏¢': '#26A69A',
    '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤': '#AED581',
    '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô': '#FFCA28',
    '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢': '#FF8A65',
    '‡∏Ç‡∏¢‡∏≤‡∏¢‡πÇ‡∏≠‡∏Å‡∏≤‡∏™': '#EF5350'
  };

  const backgroundColors = labels.map(label => levelColors[label] || '#999999');

  chartInstances.levelChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColors,
        borderWidth: 2,
        borderColor: '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: {
              family: "'Kanit', sans-serif",
              size: 12
            },
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const percentage = percentages[i];
                  return {
                    text: `${label}: ${value} ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (${percentage}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: data.datasets[0].borderWidth,
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const percentage = percentages[context.dataIndex];
              return `${label}: ${value} ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (${percentage}%)`;
            }
          }
        }
      },
      layout: {
        padding: {
          right: 20
        }
      },
      animation: {
        animateScale: true,
        animateRotate: true
      }
    },
    plugins: [{
      id: 'pieArrowLabels',
      afterDraw: function(chart) {
        const ctx = chart.ctx;
        const chartArea = chart.chartArea;
        const centerX = (chartArea.left + chartArea.right) / 2;
        const centerY = (chartArea.top + chartArea.bottom) / 2;
        const radius = Math.min(
          (chartArea.right - chartArea.left) / 2,
          (chartArea.bottom - chartArea.top) / 2
        ) * 0.8;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 14px Kanit';

        // ‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
        chart.data.datasets[0].data.forEach((value, i) => {
          if (value > 0) {
            const startAngle = chart.getDatasetMeta(0).data[i].startAngle;
            const endAngle = chart.getDatasetMeta(0).data[i].endAngle;
            const midAngle = startAngle + (endAngle - startAngle) / 2;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏®‡∏£
            const arrowLength = radius * 0.9;
            const arrowX = centerX + Math.cos(midAngle) * arrowLength;
            const arrowY = centerY + Math.sin(midAngle) * arrowLength;

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(arrowX, arrowY);
            ctx.strokeStyle = backgroundColors[i];
            ctx.lineWidth = 2;
            ctx.stroke();

            // ‡∏ß‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£
            const headLength = 10;
            const angle = Math.atan2(arrowY - centerY, arrowX - centerX);
            
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(
              arrowX - headLength * Math.cos(angle - Math.PI / 6),
              arrowY - headLength * Math.sin(angle - Math.PI / 6)
            );
            ctx.lineTo(
              arrowX - headLength * Math.cos(angle + Math.PI / 6),
              arrowY - headLength * Math.sin(angle + Math.PI / 6)
            );
            ctx.closePath();
            ctx.fillStyle = backgroundColors[i];
            ctx.fill();

            // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const textDistance = radius * 1.1;
            const textX = centerX + Math.cos(midAngle) * textDistance;
            const textY = centerY + Math.sin(midAngle) * textDistance;

            // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const text = value.toString();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.strokeStyle = backgroundColors[i];
            ctx.lineWidth = 2;
            
            // ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const textWidth = ctx.measureText(text).width;
            const padding = 8;
            
            ctx.beginPath();
            ctx.roundRect(
              textX - textWidth / 2 - padding,
              textY - 10 - padding,
              textWidth + padding * 2,
              20 + padding * 2,
              10
            );
            ctx.fill();
            ctx.stroke();

            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
            ctx.fillStyle = backgroundColors[i];
            ctx.font = 'bold 14px Kanit';
            ctx.fillText(text, textX, textY);

            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ" ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ï‡πâ
            ctx.fillStyle = '#666';
            ctx.font = '10px Kanit';
            ctx.fillText('‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', textX, textY + 15);
          }
        });

        ctx.restore();
      }
    }]
  });
}
  function createPositionChart(semesterId) {
  const ctx = document.getElementById('positionChart');

  if (chartInstances.positionChart) {
    chartInstances.positionChart.destroy();
  }

  google.script.run
    .withSuccessHandler((positionCounts) => {
      const labels = Object.keys(positionCounts);
      const data = Object.values(positionCounts);
      const totalTeachers = data.reduce((sum, count) => sum + count, 0);
      const percentages = data.map(count => totalTeachers > 0 ? Math.round((count / totalTeachers) * 100) : 0);

      // ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      const positionColors = {
        '‡∏Ñ‡∏£‡∏π': '#26A69A',
        '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢': '#AED581', 
        '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£': '#FFCA28',
        '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£': '#FF8A65'
      };

      const backgroundColors = labels.map(label => positionColors[label] || '#999999');
      const borderColors = backgroundColors.map(color => Chart.helpers.color(color).darken(0.2).rgbString());

      chartInstances.positionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
            hoverBackgroundColor: backgroundColors.map(color => Chart.helpers.color(color).lighten(0.2).rgbString()),
            hoverBorderColor: borderColors.map(color => Chart.helpers.color(color).darken(0.3).rgbString()),
            hoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(74, 44, 109, 0.9)',
              titleFont: {
                family: "'Kanit', sans-serif",
                size: 13,
                weight: '600'
              },
              bodyFont: {
                family: "'Kanit', sans-serif",
                size: 12,
                weight: '500'
              },
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw || 0;
                  const percentage = percentages[context.dataIndex];
                  return `${label}: ${value} ‡∏Ñ‡∏ô (${percentage}%)`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏ô)',
                font: {
                  family: "'Kanit', sans-serif",
                  size: 12,
                  weight: '600'
                },
                color: '#4A2C6D'
              },
              ticks: {
                font: {
                  family: "'Kanit', sans-serif",
                  size: 11
                },
                color: '#666',
                stepSize: 1,
                callback: function(value) {
                  return value.toLocaleString();
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)',
                drawBorder: false
              }
            },
            x: {
              title: {
                display: true,
                text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
                font: {
                  family: "'Kanit', sans-serif",
                  size: 12,
                  weight: '600'
                },
                color: '#4A2C6D'
              },
              ticks: {
                font: {
                  family: "'Kanit', sans-serif",
                  size: 11,
                  weight: '500'
                },
                color: '#4A2C6D'
              },
              grid: {
                display: false
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          hover: {
            animationDuration: 300
          }
        },
        plugins: [{
          id: 'dataLabels',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '600 14px "Kanit", sans-serif';

            chart.data.datasets.forEach((dataset, datasetIndex) => {
              const meta = chart.getDatasetMeta(datasetIndex);
              
              meta.data.forEach((bar, index) => {
                const value = dataset.data[index];
                if (value > 0) {
                  const x = bar.x;
                  const y = bar.y - 15; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ó‡πà‡∏á
                  
                  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                  const barHeight = bar.height;
                  const useWhiteText = barHeight > 30; // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ó‡πà‡∏á‡∏™‡∏π‡∏á‡∏û‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
                  
                  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ó‡πà‡∏á)
                  ctx.fillStyle = useWhiteText ? '#FFFFFF' : '#4A2C6D';
                  ctx.strokeStyle = useWhiteText ? 'rgba(255, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.8)';
                  ctx.lineWidth = 2;
                  
                  const text = value.toString();
                  
                  // ‡∏ß‡∏≤‡∏î‡πÄ‡∏á‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                  ctx.strokeText(text, x, y);
                  
                  // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å
                  ctx.fillText(text, x, y);
                }
              });
            });

            ctx.restore();
          }
        },
        {
          id: 'totalTeachers',
          afterDraw: function(chart) {
            const ctx = chart.ctx;
            const chartArea = chart.chartArea;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            ctx.save();
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';
            ctx.font = '600 14px "Kanit", sans-serif';
            ctx.fillStyle = '#4A2C6D';
            
            const totalText = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalTeachers} ‡∏Ñ‡∏ô`;
            ctx.fillText(totalText, chartArea.right - 10, chartArea.top + 10);
            ctx.restore();
          }
        }]
      });
    })
    .withFailureHandler((error) => {
      console.error('Error loading position chart data:', error);
      ctx.innerHTML = '<p style="text-align: center; color: #999; padding: 20px; font-family: \'Kanit\', sans-serif;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏£‡∏π‡πÑ‡∏î‡πâ</p>';
    })
    .getTeacherPositionStats(semesterId);
}

  function createSizeChart(semesterId, schoolSemesters, sizes) {
  const ctx = document.getElementById('sizeChart');

  if (chartInstances.sizeChart) {
    chartInstances.sizeChart.destroy();
  }

  const sizeCounts = {};
  sizes.forEach(s => sizeCounts[s.name] = 0);

  let filteredSemesters = schoolSemesters;
  if (semesterId) {
    filteredSemesters = schoolSemesters.filter(ss => ss.semesterId === semesterId);
  }

  filteredSemesters.forEach(schoolSemester => {
    if (schoolSemester.size) {
      const size = sizes.find(s => s.id === schoolSemester.size);
      if (size) sizeCounts[size.name]++;
    }
  });

  const totalSchools = filteredSemesters.length;
  const labels = Object.keys(sizeCounts);
  const data = Object.values(sizeCounts);
  const percentages = data.map(count => totalSchools > 0 ? Math.round((count / totalSchools) * 100) : 0);

  // ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
  const sizeColors = {
    '‡πÄ‡∏•‡πá‡∏Å': '#4A2C6D',
    '‡∏Å‡∏•‡∏≤‡∏á': '#D32F2F', 
    '‡πÉ‡∏´‡∏ç‡πà': '#F57C00',
    '‡πÉ‡∏´‡∏ç‡πà‡∏û‡∏¥‡πÄ‡∏®‡∏©': '#FBC02D'
  };

  const backgroundColors = labels.map(label => sizeColors[label] || '#999999');

  chartInstances.sizeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels.map((label, index) => `${label} (${data[index]} ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ - ${percentages[index]}%)`),
      datasets: [{
        data: data,
        backgroundColor: backgroundColors,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%', // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ring gauge
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              family: "'Kanit', sans-serif",
              size: 12
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const percentage = percentages[context.dataIndex];
              return `${label.split(' (')[0]}: ${value} ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (${percentage}%)`;
            }
          }
        }
      },
      animation: {
        animateScale: true,
        animateRotate: true
      }
    },
    plugins: [{
      id: 'centerText',
      afterDraw: function(chart) {
        const ctx = chart.ctx;
        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
        
        // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏≤‡∏á
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, 50, 0, 2 * Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.restore();

        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
        ctx.font = 'bold 14px Kanit';
        ctx.fillStyle = '#4A2C6D';
        ctx.fillText('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', centerX, centerY - 10);
        
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
        ctx.font = 'bold 24px Kanit';
        ctx.fillStyle = '#4A2C6D';
        ctx.fillText(totalSchools.toString(), centerX, centerY + 15);
        
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ"
        ctx.font = '12px Kanit';
        ctx.fillStyle = '#666';
        ctx.fillText('‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', centerX, centerY + 35);
        
        ctx.restore();
      }
    }]
  });
}

 function createStudentLevelChart(students, levels) {
  const ctx = document.getElementById('studentLevelChart');

  if (chartInstances.studentLevelChart) {
    chartInstances.studentLevelChart.destroy();
  }

  const levelCounts = {};
  levels.forEach(l => levelCounts[l.name] = 0);

  students.forEach(student => {
    const level = levels.find(l => l.id === student.levelId);
    if (level) {
      levelCounts[level.name] += (student.male + student.female);
    }
  });

  const totalStudents = Object.values(levelCounts).reduce((sum, count) => sum + count, 0);
  const labels = Object.keys(levelCounts);
  const data = Object.values(levelCounts);
  const percentages = data.map(count => totalStudents > 0 ? Math.round((count / totalStudents) * 100) : 0);

  // ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
  const studentLevelColors = {
    '‡∏õ‡∏ê‡∏°‡∏ß‡∏±‡∏¢': '#0288D1',
    '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤': '#26A69A',
    '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô': '#AED581',
    '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢': '#FFCA28',
    '‡∏Ç‡∏¢‡∏≤‡∏¢‡πÇ‡∏≠‡∏Å‡∏≤‡∏™': '#FF8A65'
  };

  const backgroundColors = labels.map(label => studentLevelColors[label] || '#999999');
  const borderColors = backgroundColors.map(color => color);

  chartInstances.studentLevelChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels.map((label, index) => `${label}`),
      datasets: [{
        data: data,
        backgroundColor: backgroundColors,
        borderColor: borderColors,
        borderWidth: 3,
        borderAlign: 'inner',
        hoverBackgroundColor: backgroundColors.map(color => Chart.helpers.color(color).lighten(0.2).rgbString()),
        hoverBorderColor: borderColors.map(color => Chart.helpers.color(color).darken(0.2).rgbString()),
        hoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              family: "'Kanit', sans-serif",
              size: 12,
              weight: '500'
            },
            color: '#4A2C6D',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const percentage = percentages[i];
                  return {
                    text: `${label}: ${value.toLocaleString()} ‡∏Ñ‡∏ô (${percentage}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor[i],
                    lineWidth: 2,
                    pointStyle: 'circle',
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(74, 44, 109, 0.9)',
          titleFont: {
            family: "'Kanit', sans-serif",
            size: 13,
            weight: '600'
          },
          bodyFont: {
            family: "'Kanit', sans-serif",
            size: 12,
            weight: '500'
          },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const percentage = percentages[context.dataIndex];
              return `${label}: ${value.toLocaleString()} ‡∏Ñ‡∏ô (${percentage}%)`;
            },
            afterLabel: function(context) {
              const level = context.label;
              const levelStudents = students.filter(s => {
                const levelObj = levels.find(l => l.name === level);
                return levelObj && s.levelId === levelObj.id;
              });
              
              if (levelStudents.length > 0) {
                const totalMale = levelStudents.reduce((sum, s) => sum + s.male, 0);
                const totalFemale = levelStudents.reduce((sum, s) => sum + s.female, 0);
                return [
                  `üë¶ ‡∏ä‡∏≤‡∏¢: ${totalMale.toLocaleString()} ‡∏Ñ‡∏ô`,
                  `üëß ‡∏´‡∏ç‡∏¥‡∏á: ${totalFemale.toLocaleString()} ‡∏Ñ‡∏ô`
                ];
              }
              return '';
            }
          }
        }
      },
      animation: {
        animateScale: true,
        animateRotate: true,
        duration: 1000,
        easing: 'easeOutQuart'
      },
      hover: {
        animationDuration: 300
      },
      elements: {
        arc: {
          borderWidth: 3,
          borderColor: '#ffffff',
          hoverBorderWidth: 4
        }
      }
    },
    plugins: [{
      id: 'centerText',
      afterDraw: function(chart) {
        const ctx = chart.ctx;
        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
        
        // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏≤‡∏á
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, 45, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(74, 44, 109, 0.2)';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.restore();

        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
        ctx.font = '600 14px "Kanit", sans-serif';
        ctx.fillStyle = '#4A2C6D';
        ctx.fillText('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', centerX, centerY - 25);
        
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        ctx.font = 'bold 20px "Kanit", sans-serif';
        ctx.fillStyle = '#4A2C6D';
        ctx.fillText(totalStudents.toLocaleString(), centerX, centerY);
        
        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤"
        ctx.font = '500 12px "Kanit", sans-serif';
        ctx.fillStyle = '#666';
        ctx.fillText('‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', centerX, centerY + 20);
        
        ctx.restore();
      }
    },
    {
      id: 'backgroundCircle',
      beforeDraw: function(chart) {
        const ctx = chart.ctx;
        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
        const radius = Math.min(
          (chart.chartArea.right - chart.chartArea.left) / 2,
          (chart.chartArea.bottom - chart.chartArea.top) / 2
        );
        
        // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(248, 249, 250, 0.8)';
        ctx.fill();
        ctx.restore();
      }
    }]
  });
}

function createStudentGenderStats(students, levels) {
  const container = document.getElementById('studentGenderStats');
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const totalMale = students.reduce((sum, s) => sum + s.male, 0);
  const totalFemale = students.reduce((sum, s) => sum + s.female, 0);
  const totalStudents = totalMale + totalFemale;
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
  const levelStats = {};
  levels.forEach(level => {
    const levelStudents = students.filter(s => s.levelId === level.id);
    const male = levelStudents.reduce((sum, s) => sum + s.male, 0);
    const female = levelStudents.reduce((sum, s) => sum + s.female, 0);
    const total = male + female;
    
    if (total > 0) {
      levelStats[level.name] = {
        male,
        female,
        total,
        malePercent: Math.round((male / total) * 100),
        femalePercent: Math.round((female / total) * 100)
      };
    }
  });

  let html = '';

  // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  html += `
    <div class="gender-total-section" style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h4 style="margin: 0 0 10px 0; font-size: 18px; font-weight: 600;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
          <div style="display: flex; gap: 30px; font-size: 14px;">
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <span style="color: #4FC3F7;">üë¶</span>
                <span>‡∏ä‡∏≤‡∏¢: ${totalMale.toLocaleString()} ‡∏Ñ‡∏ô</span>
              </div>
              <div style="font-size: 12px; opacity: 0.9;">
                ${Math.round((totalMale / totalStudents) * 100)}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </div>
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <span style="color: #F48FB1;">üëß</span>
                <span>‡∏´‡∏ç‡∏¥‡∏á: ${totalFemale.toLocaleString()} ‡∏Ñ‡∏ô</span>
              </div>
              <div style="font-size: 12px; opacity: 0.9;">
                ${Math.round((totalFemale / totalStudents) * 100)}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </div>
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                <span style="color: #AED581;">üë•</span>
                <span>‡∏£‡∏ß‡∏°: ${totalStudents.toLocaleString()} ‡∏Ñ‡∏ô</span>
              </div>
            </div>
          </div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;">${totalStudents.toLocaleString()}</div>
          <div style="font-size: 14px; opacity: 0.9;">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
      </div>
    </div>
  `;

  // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
  html += `<div class="gender-levels-section" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">`;

  Object.keys(levelStats).forEach(levelName => {
    const stats = levelStats[levelName];
    const maleWidth = stats.malePercent;
    const femaleWidth = stats.femalePercent;

    html += `
      <div class="gender-level-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #f0f0f0;">
        <h5 style="margin: 0 0 15px 0; color: #4A2C6D; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
          üìö ${levelName}
        </h5>
        
        <div style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="color: #0288D1;">üë¶</span>
              <span>‡∏ä‡∏≤‡∏¢: ${stats.male.toLocaleString()} ‡∏Ñ‡∏ô</span>
            </div>
            <span style="color: #666; font-weight: 500;">${stats.malePercent}%</span>
          </div>
          <div class="progress-bar-container" style="height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
            <div class="progress-bar-fill" style="height: 100%; background: linear-gradient(90deg, #0288D1, #4FC3F7); border-radius: 10px; width: ${maleWidth}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 11px; font-weight: 600;">
              ${stats.malePercent}%
            </div>
          </div>
        </div>

        <div style="margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="color: #D81B60;">üëß</span>
              <span>‡∏´‡∏ç‡∏¥‡∏á: ${stats.female.toLocaleString()} ‡∏Ñ‡∏ô</span>
            </div>
            <span style="color: #666; font-weight: 500;">${stats.femalePercent}%</span>
          </div>
          <div class="progress-bar-container" style="height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
            <div class="progress-bar-fill" style="height: 100%; background: linear-gradient(90deg, #D81B60, #F48FB1); border-radius: 10px; width: ${femaleWidth}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 11px; font-weight: 600;">
              ${stats.femalePercent}%
            </div>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #f0f0f0;">
          <div style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #4A2C6D;">
            <span>üë•</span>
            <span>‡∏£‡∏ß‡∏°: ${stats.total.toLocaleString()} ‡∏Ñ‡∏ô</span>
          </div>
          <div style="font-size: 12px; color: #666; background: #f8f9fa; padding: 4px 8px; border-radius: 6px;">
            ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô ${stats.male}:${stats.female}
          </div>
        </div>
      </div>
    `;
  });

  html += `</div>`;

  container.innerHTML = html;
}

 function createStudentRangeStats(schools, students) {
  const ranges = [
    { label: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', min: 0, max: 0, icon: 'üö´', color: '#9E9E9E' },
    { label: '‡∏ô‡∏£.1 - 20 ‡∏Ñ‡∏ô', min: 1, max: 20, icon: 'üè´', color: '#4CAF50' },
    { label: '‡∏ô‡∏£.21 - 40 ‡∏Ñ‡∏ô', min: 21, max: 40, icon: 'üè´', color: '#2196F3' },
    { label: '‡∏ô‡∏£.41 - 60 ‡∏Ñ‡∏ô', min: 41, max: 60, icon: 'üè´', color: '#FF9800' },
    { label: '‡∏ô‡∏£.61 - 80 ‡∏Ñ‡∏ô', min: 61, max: 80, icon: 'üè´', color: '#E91E63' },
    { label: '‡∏ô‡∏£.81 - 100 ‡∏Ñ‡∏ô', min: 81, max: 100, icon: 'üè´', color: '#9C27B0' },
    { label: '‡∏ô‡∏£.101 - 120 ‡∏Ñ‡∏ô', min: 101, max: 120, icon: 'üè´', color: '#F44336' },
    { label: '‡∏ô‡∏£.‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 120 ‡∏Ñ‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', min: 121, max: Infinity, icon: 'üè´', color: '#795548' }
  ];

  const rangeCounts = ranges.map(range => {
    let count = 0;
    schools.forEach(school => {
      const schoolStudents = students.filter(s => s.schoolId === school.id);
      const total = schoolStudents.reduce((sum, s) => sum + (s.male + s.female), 0);
      if (total >= range.min && total <= range.max) count++;
    });
    return count;
  });

  const totalSchools = schools.length || 1;

  let html = `
    <div class="range-stats-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #4A2C6D 0%, #6D4C9C 100%); border-radius: 15px; color: white;">
      <div>
        <h4 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
          üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
        </h4>
        <p style="margin: 0; opacity: 0.9; font-size: 14px;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
      </div>
      <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 15px 25px; border-radius: 10px;">
        <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;">${totalSchools}</div>
        <div style="font-size: 14px; opacity: 0.9;">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
    </div>
  `;

  html += `<div class="range-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">`;

  ranges.forEach((range, index) => {
    const count = rangeCounts[index];
    const percentage = Math.round((count / totalSchools) * 100);
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á progress bar
    const maxPercentage = Math.max(...rangeCounts.map((c, i) => Math.round((c / totalSchools) * 100)));
    const barWidth = maxPercentage > 0 ? (percentage / maxPercentage) * 100 : 0;

    html += `
      <div class="range-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; transition: all 0.3s ease; position: relative; overflow: hidden;">
        <!-- Background Icon -->
        <div style="position: absolute; top: 10px; right: 10px; opacity: 0.1; font-size: 40px; transform: rotate(15deg);">
          ${range.icon}
        </div>
        
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
          <div style="width: 40px; height: 40px; background: ${range.color}; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white;">
            ${range.icon}
          </div>
          <div style="flex: 1;">
            <h5 style="margin: 0 0 4px 0; color: #4A2C6D; font-size: 15px; font-weight: 600;">
              ${range.label}
            </h5>
            <div style="display: flex; gap: 15px; font-size: 12px; color: #666;">
              <span>${range.min === range.max ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤' : `${range.min} - ${range.max === Infinity ? '‚àû' : range.max} ‡∏Ñ‡∏ô`}</span>
            </div>
          </div>
        </div>

        <div class="progress-item" style="margin-bottom: 15px;">
          <div class="progress-label" style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #4A2C6D;">
            <span style="font-weight: 600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
            <span style="font-weight: 700; color: ${range.color};">
              <strong>${count}</strong> / ${percentage}%
            </span>
          </div>
          <div class="progress-bar-container" style="height: 16px; background: #f8f9fa; border-radius: 8px; overflow: hidden; position: relative;">
            <div class="progress-bar-fill" style="height: 100%; background: linear-gradient(90deg, ${range.color}, ${Chart.helpers.color(range.color).lighten(0.3).rgbString()}); border-radius: 8px; width: ${barWidth}%; transition: width 0.8s ease; position: relative;">
              <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: white; font-size: 10px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                ${percentage}%
              </div>
            </div>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px dashed #e0e0e0;">
          <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666;">
            <span>üìà</span>
            <span>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô: ${percentage}%</span>
          </div>
          <div style="font-size: 11px; color: #999; background: #f5f5f5; padding: 4px 8px; border-radius: 6px;">
            ${count === 0 ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ' : count === 1 ? '1 ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ' : `${count} ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ`}
          </div>
        </div>
      </div>
    `;
  });

  html += `</div>`;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
  const maxCount = Math.max(...rangeCounts);
  const mostCommonRange = ranges[rangeCounts.indexOf(maxCount)];
  
  html += `
    <div class="range-summary" style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #26A69A 0%, #4DB6AC 100%); border-radius: 12px; color: white;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 24px;">üéØ</div>
        <div>
          <h5 style="margin: 0 0 5px 0; font-size: 16px; font-weight: 600;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à</h5>
          <p style="margin: 0; font-size: 14px; opacity: 0.9;">
            ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <strong>"${mostCommonRange.label}"</strong> 
            ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${maxCount} ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</strong> 
            (${Math.round((maxCount / totalSchools) * 100)}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
          </p>
        </div>
      </div>
    </div>
  `;

  document.getElementById('studentRangeStats').innerHTML = html;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° effect ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  setTimeout(() => {
    const progressBars = document.querySelectorAll('.progress-bar-fill');
    progressBars.forEach(bar => {
      const width = bar.style.width;
      bar.style.width = '0%';
      setTimeout(() => {
        bar.style.width = width;
      }, 100);
    });
  }, 500);
}

  // School info page
  async function loadSchoolInfoPage() {
    const schools = await getData('schools');
    const select = document.getElementById('schoolSelect');
    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option>';
    schools.forEach(school => {
      select.innerHTML += `<option value="${school.id}">${school.name}</option>`;
    });
  }

  document.getElementById('schoolSelect').addEventListener('change', async (e) => {
  const schoolId = parseInt(e.target.value);
  if (!schoolId) {
    document.getElementById('schoolDetails').style.display = 'none';
    return;
  }

  showLoading(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

  try {
    const [schools, schoolSemesters, levels, sizes, semesters] = await Promise.all([
      getData('schools'),
      getData('schoolSemesters'),
      getData('levels'),
      getData('sizes'),
      getData('semesters')
    ]);

    const school = schools.find(s => s.id === schoolId);

    if (school) {
      document.getElementById('viewSchoolName').value = school.name || '';

      // Get current semester data for levels and size
      const currentSemester = semesters.find(s => s.isCurrent);
      let schoolSemester = null;

      if (currentSemester) {
        schoolSemester = schoolSemesters.find(ss => ss.schoolId === schoolId && ss.semesterId === currentSemester.id);
      }

      if (schoolSemester) {
        const levelNames = schoolSemester.levels ? schoolSemester.levels.map(lid => {
          const level = levels.find(l => l.id === lid);
          return level ? level.name : '';
        }).join(', ') : '';
        document.getElementById('viewSchoolLevels').value = levelNames;

        const size = sizes.find(s => s.id === schoolSemester.size);
        document.getElementById('viewSchoolSize').value = size ? size.name : '';
      } else {
        document.getElementById('viewSchoolLevels').value = '';
        document.getElementById('viewSchoolSize').value = '';
      }

      document.getElementById('viewSmis').value = school.smis || '';
      document.getElementById('viewMinistry').value = school.ministry || '';
      document.getElementById('viewNameTh').value = school.nameTh || '';
      document.getElementById('viewNameEn').value = school.nameEn || '';
      document.getElementById('viewMoo').value = school.moo || '';
      document.getElementById('viewRoad').value = school.road || '';
      document.getElementById('viewVillage').value = school.village || '';
      document.getElementById('viewSubdistrict').value = school.subdistrict || '';
      document.getElementById('viewDistrict').value = school.district || '';
      document.getElementById('viewProvince').value = school.province || '';
      document.getElementById('viewPostcode').value = school.postcode || '';
      document.getElementById('viewPhone').value = school.phone || '';
      document.getElementById('viewEmail').value = school.email || '';
      document.getElementById('viewWebsite').value = school.website || '';

      // Show/hide website button
      const websiteBtn = document.getElementById('websiteBtn');
      if (school.website && school.website.trim()) {
        websiteBtn.style.display = 'block';
      } else {
        websiteBtn.style.display = 'none';
      }

      const mapContainer = document.getElementById('mapContainer');
      if (school.mapLink) {
        mapContainer.innerHTML = `<iframe src="${school.mapLink}" allowfullscreen loading="lazy"></iframe>`;
      } else {
        mapContainer.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>';
      }

      document.getElementById('schoolDetails').style.display = 'block';
    }
  } catch (error) {
    console.error('Error loading school details:', error);
    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ'
    });
  } finally {
    hideLoading(); // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  }
});

  // Teacher info page
  async function loadTeacherInfoPage() {
    await loadSemesterSelects();

    // Set current semester as default
    const semesters = await getData('semesters');
    const currentSemester = semesters.find(s => s.isCurrent);
    if (currentSemester) {
      document.getElementById('teacherSemester').value = currentSemester.id;
    }

    const schools = await getData('schools');
    const select = document.getElementById('teacherSchoolSelect');
    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option>';
    schools.forEach(school => {
      select.innerHTML += `<option value="${school.id}">${school.name}</option>`;
    });
  }

  async function loadTeachersBySchoolAndSemester() {
  const schoolId = parseInt(document.getElementById('teacherSchoolSelect').value);
  const semesterId = parseInt(document.getElementById('teacherSemester').value);

  if (!schoolId) {
    document.getElementById('teacherTableContainer').style.display = 'none';
    return;
  }

  showLoading(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

  try {
    const [teachersData, positions] = await Promise.all([
      getData('teachers'),
      getData('positions')
    ]);

    let schoolTeachers = teachersData.filter(t => t.schoolId === schoolId);
    if (semesterId) {
      schoolTeachers = schoolTeachers.filter(t => t.semesterId === semesterId);
    }

    // Sort teachers by position hierarchy and academic rank
    schoolTeachers = sortTeachers(schoolTeachers, positions);

    const tbody = document.getElementById('teacherTableBody');
    tbody.innerHTML = '';

    schoolTeachers.forEach((teacher, index) => {
      const position = positions.find(p => p.id === teacher.positionId);
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${teacher.fullName}</td>
          <td><span class="badge badge-info">${position ? position.name : '-'}</span></td>
          <td>${teacher.academicRank || '-'}</td>
        </tr>
      `;
    });

    tbody.innerHTML += `
      <tr style="background: #f0f0f0; font-weight: 600;">
        <td colspan="3">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
        <td>${schoolTeachers.length} ‡∏Ñ‡∏ô</td>
      </tr>
    `;

    document.getElementById('teacherTableContainer').style.display = 'block';
  } catch (error) {
    console.error('Error loading teachers data:', error);
    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÑ‡∏î‡πâ'
    });
  } finally {
    hideLoading(); // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  }
}

  document.getElementById('teacherSchoolSelect').addEventListener('change', loadTeachersBySchoolAndSemester);
  document.getElementById('teacherSemester').addEventListener('change', loadTeachersBySchoolAndSemester);

  // Student info page
  async function loadStudentInfoPage() {
    await loadSemesterSelects();

    // Set current semester as default
    const semesters = await getData('semesters');
    const currentSemester = semesters.find(s => s.isCurrent);
    if (currentSemester) {
      document.getElementById('studentSemester').value = currentSemester.id;
    }

    const schools = await getData('schools');
    const select = document.getElementById('studentSchoolSelect');
    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option>';
    schools.forEach(school => {
      select.innerHTML += `<option value="${school.id}">${school.name}</option>`;
    });
  }

  async function loadStudentsBySchoolAndSemester() {
  const schoolId = parseInt(document.getElementById('studentSchoolSelect').value);
  const semesterId = parseInt(document.getElementById('studentSemester').value);

  if (!schoolId) {
    document.getElementById('studentTableContainer').style.display = 'none';
    return;
  }

  showLoading(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

  try {
    const [studentsData, levels] = await Promise.all([
      getData('students'),
      getData('levels')
    ]);

    let schoolStudents = studentsData.filter(s => s.schoolId === schoolId);
    if (semesterId) {
      schoolStudents = schoolStudents.filter(s => s.semesterId === semesterId);
    }

    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = '';

    let totalCount = 0;
    let totalMale = 0;
    let totalFemale = 0;

    schoolStudents.forEach((student, index) => {
      const level = levels.find(l => l.id === student.levelId);
      const count = student.male + student.female;
      totalMale += student.male;
      totalFemale += student.female;
      totalCount += count;
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td><span class="badge badge-success">${level ? level.name : '-'}</span></td>
          <td>${student.male} ‡∏Ñ‡∏ô</td>
          <td>${student.female} ‡∏Ñ‡∏ô</td>
          <td>${count} ‡∏Ñ‡∏ô</td>
        </tr>
      `;
    });

    tbody.innerHTML += `
      <tr style="background: #f0f0f0; font-weight: 600;">
        <td colspan="2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
        <td>${totalMale} ‡∏Ñ‡∏ô</td>
        <td>${totalFemale} ‡∏Ñ‡∏ô</td>
        <td>${totalCount} ‡∏Ñ‡∏ô</td>
      </tr>
    `;

    document.getElementById('studentTableContainer').style.display = 'block';
  } catch (error) {
    console.error('Error loading students data:', error);
    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ'
    });
  } finally {
    hideLoading(); // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  }
}

  document.getElementById('studentSchoolSelect').addEventListener('change', loadStudentsBySchoolAndSemester);
  document.getElementById('studentSemester').addEventListener('change', loadStudentsBySchoolAndSemester);

  // Admin settings
  async function loadAdminSettings() {
    const settings = await getSystemSettings();
    document.getElementById('networkNameInput').value = settings.networkName;
    document.getElementById('affiliationInput').value = settings.affiliation || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
    document.getElementById('logoInput').value = settings.logo;

    // Update logo preview
    const logoPreview = document.getElementById('logoPreview');
    if (settings.logoImage) {
      logoPreview.innerHTML = `<img src="${settings.logoImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
    } else {
      logoPreview.textContent = settings.logo;
    }
  }

  function previewLogo() {
    const fileInput = document.getElementById('logoFileInput');
    const logoPreview = document.getElementById('logoPreview');
    const logoInput = document.getElementById('logoInput');

    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        logoPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        logoInput.value = ''; // Clear emoji input when image is selected
      };
      reader.readAsDataURL(fileInput.files[0]);
    }
  }

  // Update logo input to clear file when emoji is entered
  document.addEventListener('DOMContentLoaded', () => {
    const logoInput = document.getElementById('logoInput');
    if (logoInput) {
      logoInput.addEventListener('input', () => {
        if (logoInput.value) {
          document.getElementById('logoFileInput').value = '';
          document.getElementById('logoPreview').innerHTML = logoInput.value;
        }
      });
    }
  });

  async function saveSystemSettings() {
    showLoading();

    const networkName = document.getElementById('networkNameInput').value;
    const affiliation = document.getElementById('affiliationInput').value;
    const logo = document.getElementById('logoInput').value;
    const fileInput = document.getElementById('logoFileInput');

    if (!networkName) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢'
      });
      return;
    }

    if (!affiliation) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î'
      });
      return;
    }

    const settings = await getSystemSettings();

    const newSettings = {
      networkName,
      affiliation,
      logo: logo || settings.logo,
      logoImage: settings.logoImage
    };

    // Handle image upload
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      const uploadPromise = new Promise((resolve) => {
        reader.onload = async (e) => {
          const base64 = e.target.result.split(',')[1];
          const mimeType = fileInput.files[0].type;
          const fileName = fileInput.files[0].name;
          newSettings.logoImage = await uploadLogo(base64, mimeType, fileName);
          newSettings.logo = ''; // Clear emoji when image is used
          resolve();
        };
        reader.readAsDataURL(fileInput.files[0]);
      });
      await uploadPromise;
    } else if (logo) {
      newSettings.logoImage = '';
    }

    await setSystemSettings(newSettings);
    await loadSystemSettings();

    hideLoading();
    Swal.fire({
      icon: 'success',
      title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  // Admin users management
  async function loadAdminUsers() {
    const users = await getData('adminUsers');
    const tbody = document.getElementById('adminUsersTableBody');
    tbody.innerHTML = '';

    users.forEach((user, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${user.username}</td>
          <td>${user.fullName}</td>
          <td>
            <button class="btn btn-warning" onclick="editAdminUser(${user.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteAdminUser(${user.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  function openAddAdminModal() {
    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <input type="text" id="adminUsername" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
      </div>
      <div class="form-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="adminPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="adminFullName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <button class="btn btn-success" onclick="saveAdminUser()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function saveAdminUser() {
    showLoading();

    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const fullName = document.getElementById('adminFullName').value;

    if (!username || !password || !fullName) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
      return;
    }

    const [adminUsers, schoolAdmins] = await Promise.all([
      getData('adminUsers'),
      getData('schoolAdmins')
    ]);

    const isDuplicateAdmin = adminUsers.some(u => u.username === username);
    const isDuplicateSchoolAdmin = schoolAdmins.some(s => s.username === username);

    if (isDuplicateAdmin || isDuplicateSchoolAdmin) {
      hideLoading();
      Swal.fire({
        icon: 'error',
        title: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥',
        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô'
      });
      return;
    }

    await addItem('adminUsers', {username, password, fullName});

    closeModal();
    await loadAdminUsers();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function editAdminUser(id) {
    const adminUsers = await getData('adminUsers');
    const user = adminUsers.find(u => u.id === id);
    if (!user) return;

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <input type="text" id="adminUsername" value="${user.username}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
      </div>
      <div class="form-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="adminPassword" value="${user.password}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="adminFullName" value="${user.fullName}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <button class="btn btn-success" onclick="updateAdminUser(${id})" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function updateAdminUser(id) {
    showLoading();

    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const fullName = document.getElementById('adminFullName').value;

    if (!username || !password || !fullName) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
      return;
    }

    const [adminUsers, schoolAdmins] = await Promise.all([
      getData('adminUsers'),
      getData('schoolAdmins')
    ]);

    const isDuplicateAdmin = adminUsers.some(u => u.username === username && u.id !== id);
    const isDuplicateSchoolAdmin = schoolAdmins.some(s => s.username === username);

    if (isDuplicateAdmin || isDuplicateSchoolAdmin) {
      hideLoading();
      Swal.fire({
        icon: 'error',
        title: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥',
        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô'
      });
      return;
    }

    await updateItem('adminUsers', id, {username, password, fullName});

    closeModal();
    await loadAdminUsers();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deleteAdminUser(id) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        await deleteItem('adminUsers', id);
        await loadAdminUsers();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  }

  // School admins management
  async function loadSchoolAdmins() {
    const [admins, schools] = await Promise.all([
      getData('schoolAdmins'),
      getData('schools')
    ]);
    const tbody = document.getElementById('schoolAdminsTableBody');
    tbody.innerHTML = '';

    admins.forEach((admin, index) => {
      const school = schools.find(s => s.id === admin.schoolId);
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${admin.username}</td>
          <td>${school ? school.name : '-'}</td>
          <td>
            <button class="btn btn-warning" onclick="editSchoolAdmin(${admin.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteSchoolAdmin(${admin.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  function openAddSchoolAdminModal() {
    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <input type="text" id="schoolAdminUsername" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
      </div>
      <div class="form-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <input type="password" id="schoolAdminPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
        <input type="text" id="schoolAdminSchoolName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">
      </div>
      <button class="btn btn-success" onclick="saveSchoolAdmin()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function saveSchoolAdmin() {
    showLoading();

    const username = document.getElementById('schoolAdminUsername').value;
    const password = document.getElementById('schoolAdminPassword').value;
    const schoolName = document.getElementById('schoolAdminSchoolName').value;

    if (!username || !password || !schoolName) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
      return;
    }

    const [adminUsers, schoolAdmins] = await Promise.all([
      getData('adminUsers'),
      getData('schoolAdmins')
    ]);

    const isDuplicateAdmin = adminUsers.some(u => u.username === username);
    const isDuplicateSchoolAdmin = schoolAdmins.some(s => s.username === username);

    if (isDuplicateAdmin || isDuplicateSchoolAdmin) {
      hideLoading();
      Swal.fire({
        icon: 'error',
        title: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥',
        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô'
      });
      return;
    }

    // Create school first
    const newSchool = await addItem('schools', {name: schoolName});

    // Create school admin
    await addItem('schoolAdmins', {username, password, schoolId: newSchool.id, schoolName});

    closeModal();
    await loadSchoolAdmins();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  function editSchoolAdmin(id, fromSchoolUserPage = false) {
    (async () => {
      const schoolAdmins = await getData('schoolAdmins');
      const admin = schoolAdmins.find(a => a.id === id);
      if (!admin) return;

      const modalTitle = fromSchoolUserPage ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏Å' : '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
      const updateFunction = fromSchoolUserPage ? `updateSchoolAdminFromUserPage(${id})` : `updateSchoolAdmin(${id})`;

      document.getElementById('modalTitle').textContent = modalTitle;
      document.getElementById('modalBody').innerHTML = `
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
          <input type="text" id="schoolAdminUsername" value="${admin.username}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        </div>
        <div class="form-group">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input type="password" id="schoolAdminPassword" value="${admin.password}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
          <input type="text" id="schoolAdminSchoolName" value="${admin.schoolName}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ" ${fromSchoolUserPage ? 'readonly' : ''}>
        </div>
        <button class="btn btn-success" onclick="${updateFunction}" style="width: 100%; margin-top: 20px;">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        </button>
      `;
      document.getElementById('genericModal').classList.add('active');
    })();
  }

  async function updateSchoolAdmin(id) {
    showLoading();

    const username = document.getElementById('schoolAdminUsername').value;
    const password = document.getElementById('schoolAdminPassword').value;
    const schoolName = document.getElementById('schoolAdminSchoolName').value;

    if (!username || !password || !schoolName) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
      return;
    }

    const [adminUsers, schoolAdmins] = await Promise.all([
      getData('adminUsers'),
      getData('schoolAdmins')
    ]);

    const isDuplicateAdmin = adminUsers.some(u => u.username === username);
    const isDuplicateSchoolAdmin = schoolAdmins.some(s => s.username === username && s.id !== id);

    if (isDuplicateAdmin || isDuplicateSchoolAdmin) {
      hideLoading();
      Swal.fire({
        icon: 'error',
        title: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥',
        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô'
      });
      return;
    }

    const schoolAdmin = schoolAdmins.find(a => a.id === id);
    if (schoolAdmin) {
      const schoolId = schoolAdmin.schoolId;
      await updateItem('schoolAdmins', id, {username, password, schoolName});
      await updateItem('schools', schoolId, {name: schoolName});
    }

    closeModal();
    await loadSchoolAdmins();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deleteSchoolAdmin(id) {
    const schoolAdmins = await getData('schoolAdmins');
    const admin = schoolAdmins.find(a => a.id === id);
    if (!admin) return;

    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ?',
      html: `
        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ <strong>"${admin.schoolName}"</strong> ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <p style="color: #EF5350; font-weight: 600; margin-top: 15px;">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ</p>
        <p style="color: #666; font-size: 14px; margin-top: 10px;">‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ, ‡∏Ñ‡∏£‡∏π-‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£, ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤, ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      `,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350',
      cancelButtonColor: '#6c757d'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        const schoolId = admin.schoolId;
        await deleteSchool(schoolId);
        await loadSchoolAdmins();
        hideLoading();

        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          text: `‡∏•‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ "${admin.schoolName}" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          timer: 2000
        });
      }
    });
  }

  // Levels management
  async function loadLevels() {
    const levels = await getData('levels');
    const tbody = document.getElementById('levelsTableBody');
    tbody.innerHTML = '';

    levels.forEach((level, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${level.name}</td>
          <td>
            <button class="btn btn-warning" onclick="editLevel(${level.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteLevel(${level.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  function openAddLevelModal() {
    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
        <input type="text" id="levelName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö">
      </div>
      <button class="btn btn-success" onclick="saveLevel()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function saveLevel() {
    showLoading();

    const name = document.getElementById('levelName').value;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö'
      });
      return;
    }

    await addItem('levels', {name});

    closeModal();
    await loadLevels();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function editLevel(id) {
    const levels = await getData('levels');
    const level = levels.find(l => l.id === id);
    if (!level) return;

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏î‡∏±‡∏ö';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
        <input type="text" id="levelName" value="${level.name}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö">
      </div>
      <button class="btn btn-success" onclick="updateLevel(${id})" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function updateLevel(id) {
    showLoading();

    const name = document.getElementById('levelName').value;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö'
      });
      return;
    }

    await updateItem('levels', id, {name});

    closeModal();
    await loadLevels();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deleteLevel(id) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        await deleteItem('levels', id);
        await loadLevels();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  }

  // Sizes management
  async function loadSizes() {
    const sizes = await getData('sizes');
    const tbody = document.getElementById('sizesTableBody');
    tbody.innerHTML = '';

    sizes.forEach((size, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${size.name}</td>
          <td>
            <button class="btn btn-warning" onclick="editSize(${size.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteSize(${size.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  function openAddSizeModal() {
    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
        <input type="text" id="sizeName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">
      </div>
      <button class="btn btn-success" onclick="saveSize()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function saveSize() {
    showLoading();

    const name = document.getElementById('sizeName').value;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ'
      });
      return;
    }

    await addItem('sizes', {name});

    closeModal();
    await loadSizes();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function editSize(id) {
    const sizes = await getData('sizes');
    const size = sizes.find(s => s.id === id);
    if (!size) return;

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
        <input type="text" id="sizeName" value="${size.name}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">
      </div>
      <button class="btn btn-success" onclick="updateSize(${id})" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function updateSize(id) {
    showLoading();

    const name = document.getElementById('sizeName').value;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ'
      });
      return;
    }

    await updateItem('sizes', id, {name});

    closeModal();
    await loadSizes();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deleteSize(id) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        await deleteItem('sizes', id);
        await loadSizes();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  }

  // Positions management
  async function loadPositions() {
    const positions = await getData('positions');
    const tbody = document.getElementById('positionsTableBody');
    tbody.innerHTML = '';

    positions.forEach((position, index) => {
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${position.name}</td>
          <td>
            <button class="btn btn-warning" onclick="editPosition(${position.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deletePosition(${position.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  function openAddPositionModal() {
    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <input type="text" id="positionName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
      </div>
      <button class="btn btn-success" onclick="savePosition()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function savePosition() {
    showLoading();

    const name = document.getElementById('positionName').value;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
      });
      return;
    }

    await addItem('positions', {name});

    closeModal();
    await loadPositions();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function editPosition(id) {
    const positions = await getData('positions');
    const position = positions.find(p => p.id === id);
    if (!position) return;

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <input type="text" id="positionName" value="${position.name}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
      </div>
      <button class="btn btn-success" onclick="updatePosition(${id})" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function updatePosition(id) {
    showLoading();

    const name = document.getElementById('positionName').value;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
      });
      return;
    }

    await updateItem('positions', id, {name});

    closeModal();
    await loadPositions();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deletePosition(id) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        await deleteItem('positions', id);
        await loadPositions();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  }

  // School general page
  async function loadSchoolGeneral() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.type !== 'school') return;

    // Load semester dropdown
    const semesters = await getData('semesters');
    const semesterSelect = document.getElementById('schoolGeneralSemester');
    semesterSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';

    const currentSemester = semesters.find(s => s.isCurrent);
    semesters.forEach(semester => {
      const selected = semester.isCurrent ? 'selected' : '';
      semesterSelect.innerHTML += `<option value="${semester.id}" ${selected}>${semester.name}</option>`;
    });

    // Load data if current semester is selected
    if (currentSemester) {
      await loadSchoolGeneralBySemester();
    }
  }

  async function loadSchoolGeneralBySemester() {
    const semesterId = parseInt(document.getElementById('schoolGeneralSemester').value);
    if (!semesterId) {
      document.getElementById('schoolGeneralForm').style.display = 'none';
      return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const [schools, schoolSemesters, sizes, levels] = await Promise.all([
      getData('schools'),
      getData('schoolSemesters'),
      getData('sizes'),
      getData('levels')
    ]);

    let school = schools.find(s => s.id === currentUser.data.schoolId);

    if (!school) {
      school = await addItem('schools', {
        name: `‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ ${currentUser.data.schoolId}`,
        smis: '',
        ministry: '',
        nameTh: '',
        nameEn: '',
        moo: '',
        road: '',
        village: '',
        subdistrict: '',
        district: '',
        province: '',
        postcode: '',
        phone: '',
        email: '',
        website: '',
        mapLink: ''
      });
    }

    let schoolSemester = schoolSemesters.find(ss => ss.schoolId === currentUser.data.schoolId && ss.semesterId === semesterId);

    if (!schoolSemester) {
      schoolSemester = await addItem('schoolSemesters', {
        schoolId: currentUser.data.schoolId,
        semesterId: semesterId,
        levels: [],
        size: null
      });
    }

    const sizeSelect = document.getElementById('editSchoolSize');
    sizeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ --</option>';
    sizes.forEach(size => {
      sizeSelect.innerHTML += `<option value="${size.id}">${size.name}</option>`;
    });

    // Load general school data
    document.getElementById('editSchoolName').value = school.name || '';
    document.getElementById('editSmis').value = school.smis || '';
    document.getElementById('editMinistry').value = school.ministry || '';
    document.getElementById('editNameTh').value = school.nameTh || '';
    document.getElementById('editNameEn').value = school.nameEn || '';
    document.getElementById('editMoo').value = school.moo || '';
    document.getElementById('editRoad').value = school.road || '';
    document.getElementById('editVillage').value = school.village || '';
    document.getElementById('editSubdistrict').value = school.subdistrict || '';
    document.getElementById('editDistrict').value = school.district || '';
    document.getElementById('editProvince').value = school.province || '';
    document.getElementById('editPostcode').value = school.postcode || '';
    document.getElementById('editPhone').value = school.phone || '';
    document.getElementById('editEmail').value = school.email || '';
    document.getElementById('editWebsite').value = school.website || '';
    document.getElementById('editMapLink').value = school.mapLink || '';

    // Load semester-specific data
    document.getElementById('editSchoolSize').value = schoolSemester.size || '';
    loadLevelMultiSelect(schoolSemester.levels || [], levels);

    document.getElementById('schoolGeneralForm').style.display = 'block';
  }

  function loadLevelMultiSelect(selectedLevels, levels) {
    const dropdown = document.getElementById('levelDropdown');
    dropdown.innerHTML = '';

    levels.forEach(level => {
      const checked = selectedLevels.includes(level.id) ? 'checked' : '';
      dropdown.innerHTML += `
        <div class="multi-select-option">
          <input type="checkbox" value="${level.id}" ${checked} onchange="updateLevelDisplay()">
          ${level.name}
        </div>
      `;
    });

    updateLevelDisplay();
  }

  function toggleLevelDropdown() {
    document.getElementById('levelDropdown').classList.toggle('active');
  }

  function updateLevelDisplay() {
    const checkboxes = document.querySelectorAll('#levelDropdown input[type="checkbox"]');
    const display = document.getElementById('levelMultiSelect');

    const selected = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => parseInt(cb.value));

    if (selected.length === 0) {
      display.innerHTML = '<span style="color: #999;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö...</span>';
    } else {
      display.innerHTML = '';
      selected.forEach(levelId => {
        // Note: levels not available here, but since display tag, can use temp name or something, but to simple, use id, but original uses name
        // To fix, make levels global or pass
        // For simplicity, assume levels is global, but better to fetch name
        // Original uses find, but since async, assume we have levels from load
        // For this, use placeholder, or assume.
        // To make, let's assume levels is passed or global.
        // For now, use levelId as text, but to fix, change to async if needed.
        // Original has levels from local, so here, since loadSchoolGeneralBySemester has levels, but function is separate.
        // To simplify, display the name if available, but since not, use the option text.
        const option = document.querySelector(`#levelDropdown input[value="${levelId}"]`).nextSibling.textContent.trim();
        display.innerHTML += `
          <span class="multi-select-tag">
            ${option}
            <button onclick="removeLevelTag(${levelId}); event.stopPropagation();">√ó</button>
          </span>
        `;
      });
    }
  }

  function removeLevelTag(levelId) {
    const checkbox = document.querySelector(`#levelDropdown input[value="${levelId}"]`);
    if (checkbox) {
      checkbox.checked = false;
      updateLevelDisplay();
    }
  }

  async function saveSchoolGeneral() {
    showLoading();

    const semesterId = parseInt(document.getElementById('schoolGeneralSemester').value);
    if (!semesterId) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
      });
      return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const [schools, schoolSemesters] = await Promise.all([
      getData('schools'),
      getData('schoolSemesters')
    ]);

    const school = schools.find(s => s.id === currentUser.data.schoolId);
    const schoolSemester = schoolSemesters.find(ss => ss.schoolId === currentUser.data.schoolId && ss.semesterId === semesterId);

    const checkboxes = document.querySelectorAll('#levelDropdown input[type="checkbox"]');
    const selectedLevels = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => parseInt(cb.value));

    if (school) {
      const updatedSchool = {
        smis: document.getElementById('editSmis').value,
        ministry: document.getElementById('editMinistry').value,
        nameTh: document.getElementById('editNameTh').value,
        nameEn: document.getElementById('editNameEn').value,
        moo: document.getElementById('editMoo').value,
        road: document.getElementById('editRoad').value,
        village: document.getElementById('editVillage').value,
        subdistrict: document.getElementById('editSubdistrict').value,
        district: document.getElementById('editDistrict').value,
        province: document.getElementById('editProvince').value,
        postcode: document.getElementById('editPostcode').value,
        phone: document.getElementById('editPhone').value,
        email: document.getElementById('editEmail').value,
        website: document.getElementById('editWebsite').value,
        mapLink: document.getElementById('editMapLink').value
      };
      await updateItem('schools', school.id, updatedSchool);
    }

    if (schoolSemester) {
      const updatedSemester = {
        levels: selectedLevels,
        size: parseInt(document.getElementById('editSchoolSize').value) || null
      };
      await updateItem('schoolSemesters', schoolSemester.id, updatedSemester);
    }

    hideLoading();
    Swal.fire({
      icon: 'success',
      title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  // School students page
  async function loadSchoolStudents() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.type !== 'school') return;

    // Load semester dropdown
    const semesters = await getData('semesters');
    const semesterSelect = document.getElementById('schoolStudentSemester');
    semesterSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';

    const currentSemester = semesters.find(s => s.isCurrent);
    semesters.forEach(semester => {
      const selected = semester.isCurrent ? 'selected' : '';
      semesterSelect.innerHTML += `<option value="${semester.id}" ${selected}>${semester.name}</option>`;
    });

    // Load data if current semester is selected
    if (currentSemester) {
      await loadSchoolStudentsBySemester();
    }
  }

  async function loadSchoolStudentsBySemester() {
    const semesterId = parseInt(document.getElementById('schoolStudentSemester').value);
    if (!semesterId) {
      document.getElementById('studentLevelForms').innerHTML = '';
      document.getElementById('saveStudentBtn').style.display = 'none';
      return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const schoolSemesters = await getData('schoolSemesters');
    const schoolSemester = schoolSemesters.find(ss => ss.schoolId === currentUser.data.schoolId && ss.semesterId === semesterId);

    if (!schoolSemester || !schoolSemester.levels || schoolSemester.levels.length === 0) {
      document.getElementById('studentLevelForms').innerHTML = '<p style="text-align: center; color: #999;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô</p>';
      document.getElementById('saveStudentBtn').style.display = 'none';
      return;
    }

    const [levels, students] = await Promise.all([
      getData('levels'),
      getData('students')
    ]);

    let html = '';
    schoolSemester.levels.forEach(levelId => {
      const level = levels.find(l => l.id === levelId);
      if (!level) return;

      const studentData = students.find(s => s.schoolId === currentUser.data.schoolId && s.levelId === levelId && s.semesterId === semesterId);
      const male = studentData ? studentData.male : 0;
      const female = studentData ? studentData.female : 0;

      html += `
        <div class="form-section" style="margin-bottom: 20px;">
          <h4 style="color: #4A2C6D; margin-bottom: 15px;">üìö ${level.name}</h4>
          <div class="form-row">
            <div class="form-group">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏≤‡∏¢</label>
              <input type="number" id="male_${levelId}" value="${male}" min="0">
            </div>
            <div class="form-group">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏ç‡∏¥‡∏á</label>
              <input type="number" id="female_${levelId}" value="${female}" min="0">
            </div>
          </div>
        </div>
      `;
    });

    document.getElementById('studentLevelForms').innerHTML = html;
    document.getElementById('saveStudentBtn').style.display = 'block';
  }

  async function saveStudentCounts() {
    showLoading();

    const semesterId = parseInt(document.getElementById('schoolStudentSemester').value);
    if (!semesterId) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
      });
      return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const schoolSemesters = await getData('schoolSemesters');
    const schoolSemester = schoolSemesters.find(ss => ss.schoolId === currentUser.data.schoolId && ss.semesterId === semesterId);
    let students = await getData('students');

    if (!schoolSemester || !schoolSemester.levels) {
      hideLoading();
      return;
    }

    for (let levelId of schoolSemester.levels) {
      const male = parseInt(document.getElementById(`male_${levelId}`).value) || 0;
      const female = parseInt(document.getElementById(`female_${levelId}`).value) || 0;

      const existing = students.find(s => s.schoolId === currentUser.data.schoolId && s.levelId === levelId && s.semesterId === semesterId);

      if (existing) {
        await updateItem('students', existing.id, {male, female});
      } else {
        await addItem('students', {
          schoolId: currentUser.data.schoolId,
          levelId,
          semesterId,
          male,
          female
        });
      }
    }

    hideLoading();
    Swal.fire({
      icon: 'success',
      title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  // Semesters management
  async function loadSemesters() {
    const semesters = await getData('semesters');
    const tbody = document.getElementById('semestersTableBody');
    tbody.innerHTML = '';

    semesters.forEach((semester, index) => {
      const statusBadge = semester.isCurrent ?
        '<span class="badge badge-success">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>' :
        '<span class="badge badge-info">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>';

      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${semester.name}</td>
          <td>${statusBadge}</td>
          <td>
            ${!semester.isCurrent ? `<button class="btn btn-success" onclick="setCurrentSemester(${semester.id})">‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>` : ''}
            <button class="btn btn-warning" onclick="editSemester(${semester.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteSemester(${semester.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  function openAddSemesterModal() {
    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
        <input type="text" id="semesterName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1/2568">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="semesterIsCurrent"> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        </label>
      </div>
      <button class="btn btn-success" onclick="saveSemester()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function saveSemester() {
    showLoading();

    const name = document.getElementById('semesterName').value;
    const isCurrent = document.getElementById('semesterIsCurrent').checked;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'
      });
      return;
    }

    let semesters = await getData('semesters');

    if (isCurrent) {
      semesters.forEach(s => s.isCurrent = false);
      await setData('semesters', semesters);
    }

    await addItem('semesters', {name, isCurrent});

    closeModal();
    await loadSemesters();
    await loadSemesterSelects();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function setCurrentSemester(id) {
    showLoading();

    let semesters = await getData('semesters');
    semesters.forEach(s => s.isCurrent = s.id === id);
    await setData('semesters', semesters);

    await loadSemesters();
    await loadSemesterSelects();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function editSemester(id) {
    const semesters = await getData('semesters');
    const semester = semesters.find(s => s.id === id);
    if (!semester) return;

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
        <input type="text" id="semesterName" value="${semester.name}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà 1/2568">
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="semesterIsCurrent" ${semester.isCurrent ? 'checked' : ''}> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        </label>
      </div>
      <button class="btn btn-success" onclick="updateSemester(${id})" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function updateSemester(id) {
    showLoading();

    const name = document.getElementById('semesterName').value;
    const isCurrent = document.getElementById('semesterIsCurrent').checked;

    if (!name) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'
      });
      return;
    }

    let semesters = await getData('semesters');

    if (isCurrent) {
      semesters.forEach(s => s.isCurrent = false);
      await setData('semesters', semesters);
    }

    await updateItem('semesters', id, {name, isCurrent});

    closeModal();
    await loadSemesters();
    await loadSemesterSelects();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deleteSemester(id) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        await deleteItem('semesters', id);
        await loadSemesters();
        await loadSemesterSelects();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  }

  async function loadSemesterSelects() {
    const semesters = await getData('semesters');
    const currentSemester = semesters.find(s => s.isCurrent);

    // Update home page
    const homeSelect = document.getElementById('homeSemester');
    homeSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';
    semesters.forEach(semester => {
      const selected = semester.isCurrent ? 'selected' : '';
      homeSelect.innerHTML += `<option value="${semester.id}" ${selected}>${semester.name}</option>`;
    });

    // Update teacher page
    const teacherSelect = document.getElementById('teacherSemester');
    teacherSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';
    semesters.forEach(semester => {
      const selected = semester.isCurrent ? 'selected' : '';
      teacherSelect.innerHTML += `<option value="${semester.id}" ${selected}>${semester.name}</option>`;
    });

    // Update student page
    const studentSelect = document.getElementById('studentSemester');
    studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';
    semesters.forEach(semester => {
      const selected = semester.isCurrent ? 'selected' : '';
      studentSelect.innerHTML += `<option value="${semester.id}" ${selected}>${semester.name}</option>`;
    });
  }

  // School teachers page
  async function loadSchoolTeachers() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.type !== 'school') return;

    // Load semester dropdown
    const semesters = await getData('semesters');
    const semesterSelect = document.getElementById('schoolTeacherSemester');
    semesterSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';

    const currentSemester = semesters.find(s => s.isCurrent);
    semesters.forEach(semester => {
      const selected = semester.isCurrent ? 'selected' : '';
      semesterSelect.innerHTML += `<option value="${semester.id}" ${selected}>${semester.name}</option>`;
    });

    // Load data if current semester is selected
    if (currentSemester) {
      await loadSchoolTeachersBySemester();
    }
  }

  async function loadSchoolTeachersBySemester() {
    const semesterId = parseInt(document.getElementById('schoolTeacherSemester').value);
    if (!semesterId) {
      document.getElementById('teacherActionButtons').style.display = 'none';
      document.getElementById('schoolTeachersTableContainer').style.display = 'none';
      return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const [teachersData, positions] = await Promise.all([
      getData('teachers'),
      getData('positions')
    ]);
    let schoolTeachers = teachersData.filter(t => t.schoolId === currentUser.data.schoolId && t.semesterId === semesterId);

    // Sort teachers by position hierarchy and academic rank
    schoolTeachers = sortTeachers(schoolTeachers, positions);

    const tbody = document.getElementById('schoolTeachersTableBody');
    tbody.innerHTML = '';

    schoolTeachers.forEach((teacher, index) => {
      const position = positions.find(p => p.id === teacher.positionId);
      tbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${teacher.fullName}</td>
          <td><span class="badge badge-info">${position ? position.name : '-'}</span></td>
          <td>${teacher.academicRank || '-'}</td>
          <td>
            <button class="btn btn-warning" onclick="editTeacher(${teacher.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteTeacher(${teacher.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });

    document.getElementById('teacherActionButtons').style.display = 'block';
    document.getElementById('schoolTeachersTableContainer').style.display = 'block';
  }

  function sortTeachers(teachers, positions) {
    // Position hierarchy (higher number = higher position)
    const positionHierarchy = {
      '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£': 4,
      '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£': 3,
      '‡∏Ñ‡∏£‡∏π': 2,
      '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢': 1
    };

    // Academic rank hierarchy (higher number = higher rank)
    const rankHierarchy = {
      '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©': 12,
      '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç': 11,
      '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©': 10,
      '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£': 9,
      '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç': 8,
      '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©': 7,
      '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£': 6,
      '‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©': 5,
      '‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç': 4,
      '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©': 3,
      '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£': 2,
      '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞': 1,
      '': 0
    };

    return teachers.sort((a, b) => {
      const positionA = positions.find(p => p.id === a.positionId);
      const positionB = positions.find(p => p.id === b.positionId);

      const positionRankA = positionHierarchy[positionA?.name] || 0;
      const positionRankB = positionHierarchy[positionB?.name] || 0;

      // First sort by position (higher position first)
      if (positionRankA !== positionRankB) {
        return positionRankB - positionRankA;
      }

      // Then sort by academic rank (higher rank first)
      const academicRankA = rankHierarchy[a.academicRank || ''] || 0;
      const academicRankB = rankHierarchy[b.academicRank || ''] || 0;

      return academicRankB - academicRankA;
    });
  }

  async function openAddTeacherModal() {
    const positions = await getData('positions');
    let positionOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
    positions.forEach(position => {
      positionOptions += `<option value="${position.id}">${position.name}</option>`;
    });

    const rankOptions = `
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞ --</option>
      <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</option>
      <option value="‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£">‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç">‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
      <option value="‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç">‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
    `;

    document.getElementById('modalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="teacherFullName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <div class="form-group">
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <select id="teacherPosition">${positionOptions}</select>
      </div>
      <div class="form-group">
        <label>‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</label>
        <select id="teacherRank">${rankOptions}</select>
      </div>
      <button class="btn btn-success" onclick="saveTeacher()" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function saveTeacher() {
    showLoading();

    const fullName = document.getElementById('teacherFullName').value;
    const positionId = parseInt(document.getElementById('teacherPosition').value);
    const academicRank = document.getElementById('teacherRank').value;
    const semesterId = parseInt(document.getElementById('schoolTeacherSemester').value);

    if (!fullName || !positionId || !semesterId) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'
      });
      return;
    }

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    await addItem('teachers', {
      schoolId: currentUser.data.schoolId,
      semesterId: semesterId,
      fullName,
      positionId,
      academicRank: academicRank || ''
    });

    closeModal();
    await loadSchoolTeachersBySemester();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function editTeacher(id) {
    const [teachers, positions] = await Promise.all([
      getData('teachers'),
      getData('positions')
    ]);
    const teacher = teachers.find(t => t.id === id);
    if (!teacher) return;

    let positionOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
    positions.forEach(position => {
      const selected = position.id === teacher.positionId ? 'selected' : '';
      positionOptions += `<option value="${position.id}" ${selected}>${position.name}</option>`;
    });

    const rankOptions = `
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞ --</option>
      <option value="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞" ${teacher.academicRank === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</option>
      <option value="‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£" ${teacher.academicRank === '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©" ${teacher.academicRank === '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©' ? 'selected' : ''}>‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç" ${teacher.academicRank === '‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç' ? 'selected' : ''}>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
      <option value="‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©" ${teacher.academicRank === '‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©' ? 'selected' : ''}>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£" ${teacher.academicRank === '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©" ${teacher.academicRank === '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©' ? 'selected' : ''}>‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç" ${teacher.academicRank === '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç' ? 'selected' : ''}>‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£" ${teacher.academicRank === '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©" ${teacher.academicRank === '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©' ? 'selected' : ''}>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç" ${teacher.academicRank === '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç' ? 'selected' : ''}>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</option>
      <option value="‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©" ${teacher.academicRank === '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©' ? 'selected' : ''}>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
    `;

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£';
    document.getElementById('modalBody').innerHTML = `
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="teacherFullName" value="${teacher.fullName}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <div class="form-group">
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
        <select id="teacherPosition">${positionOptions}</select>
      </div>
      <div class="form-group">
        <label>‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</label>
        <select id="teacherRank">${rankOptions}</select>
      </div>
      <button class="btn btn-success" onclick="updateTeacher(${id})" style="width: 100%; margin-top: 20px;">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    `;
    document.getElementById('genericModal').classList.add('active');
  }

  async function updateTeacher(id) {
    showLoading();

    const fullName = document.getElementById('teacherFullName').value;
    const positionId = parseInt(document.getElementById('teacherPosition').value);
    const academicRank = document.getElementById('teacherRank').value;

    if (!fullName || !positionId) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
      return;
    }

    await updateItem('teachers', id, {fullName, positionId, academicRank: academicRank || ''});

    closeModal();
    await loadSchoolTeachersBySemester();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  async function deleteTeacher(id) {
    Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#EF5350'
    }).then(async (result) => {
      if (result.isConfirmed) {
        showLoading();
        await deleteItem('teachers', id);
        await loadSchoolTeachersBySemester();
        hideLoading();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500
        });
      }
    });
  }

  // School users page
  async function loadSchoolUsers() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.type !== 'school') return;

    const [schoolUsersData, schoolAdmins] = await Promise.all([
      getData('schoolUsers'),
      getData('schoolAdmins')
    ]);

    const currentSchoolUsers = schoolUsersData.filter(u => u.schoolId === currentUser.data.schoolId);

    const currentSchoolAdmin = schoolAdmins.find(a => a.schoolId === currentUser.data.schoolId);

    const tbody = document.getElementById('schoolUsersTableBody');
    tbody.innerHTML = '';

    let index = 0;

    if (currentSchoolAdmin) {
      tbody.innerHTML += `
        <tr style="background: #f8f9fa;">
          <td>${++index}</td>
          <td>${currentSchoolAdmin.username}</td>
          <td>${currentSchoolAdmin.schoolName} (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏Å)</td>
          <td>
            <span class="badge badge-info">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Admin ‡∏£‡∏∞‡∏ö‡∏ö</span>
            <button class="btn btn-warning" onclick="editSchoolAdmin(${currentSchoolAdmin.id}, true)">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </td>
        </tr>
      `;
    }

    currentSchoolUsers.forEach((user) => {
      tbody.innerHTML += `
        <tr>
          <td>${++index}</td>
          <td>${user.username}</td>
          <td>${user.fullName}</td>
          <td>
            <span class="badge badge-success">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
            <button class="btn btn-warning" onclick="editSchoolUser(${user.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger" onclick="deleteSchoolUser(${user.id})">üóëÔ∏è ‡∏•‡∏ö</button>
          </td>
        </tr>
      `;
    });
  }

  async function updateSchoolAdminFromUserPage(id) {
    showLoading();

    const username = document.getElementById('schoolAdminUsername').value;
    const password = document.getElementById('schoolAdminPassword').value;
    const schoolName = document.getElementById('schoolAdminSchoolName').value;

    if (!username || !password || !schoolName) {
      hideLoading();
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
      return;
    }

    const [adminUsers, schoolAdmins, schoolUsersData] = await Promise.all([
      getData('adminUsers'),
      getData('schoolAdmins'),
      getData('schoolUsers')
    ]);

    const isDuplicateAdmin = adminUsers.some(u => u.username === username);
    const isDuplicateSchoolAdmin = schoolAdmins.some(s => s.username === username && s.id !== id);
    const isDuplicateSchoolUser = schoolUsersData.some(s => s.username === username);

    if (isDuplicateAdmin || isDuplicateSchoolAdmin || isDuplicateSchoolUser) {
      hideLoading();
      Swal.fire({
        icon: 'error',
        title: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥',
        text: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô'
      });
      return;
    }

    const schoolAdmin = schoolAdmins.find(a => a.id === id);
    if (schoolAdmin) {
      const schoolId = schoolAdmin.schoolId;
      await updateItem('schoolAdmins', id, {username, password, schoolName});
      await updateItem('schools', schoolId, {name: schoolName});
    }

    closeModal();
    await loadSchoolUsers();
    hideLoading();

    Swal.fire({
      icon: 'success',
      title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 1500
    });
  }

  // Modal functions
  function closeModal() {
    document.getElementById('genericModal').classList.remove('active');
  }

  // Close modal when clicking outside
  document.getElementById('genericModal').addEventListener('click', (e) => {
    if (e.target.id === 'genericModal') {
      closeModal();
    }
  });

  // Website opening function
  function openWebsite() {
    const website = document.getElementById('viewWebsite').value;
    if (website && website.trim()) {
      let url = website.trim();
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      window.open(url, '_blank', 'noopener,noreferrer');
    }
  }

  // Initialize on load
  document.addEventListener('DOMContentLoaded', async () => {
    await loadSystemSettings();

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (currentUser) {
      updateUIForUser(currentUser.type);
      if (currentUser.type === 'admin') {
        await navigateToPage('admin-settings');
      } else if (currentUser.type === 'school') {
        await navigateToPage('school-general');
      }
    } else {
      updateUIForUser(null);
      await navigateToPage('home');
    }

    // Load semester selects
    await loadSemesterSelects();
  });
</script></body>
</html>
