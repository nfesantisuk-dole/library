<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç</title>
  
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* =========================================
       CORE & LAYOUT
       ========================================= */
    body {
        box-sizing: border-box;
        font-family: 'Sarabun', sans-serif;
        background: linear-gradient(135deg, #e8f5e9 0%, #fff3e0 100%);
        color: #333;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
    }
    * { margin: 0; padding: 0; box-sizing: border-box;
    }
    html, body { height: 100%; width: 100%;
    }

    .main-wrapper {
        width: 100%; max-width: 1200px; margin: 0 auto;
        padding: 15px; padding-bottom: 90px;
    }

    /* =========================================
       HEADER
       ========================================= */
    .app-header {
        background: linear-gradient(135deg, #66bb6a 0%, #ffb74d 100%);
        padding: 20px; border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center; margin-bottom: 20px; position: relative;
    }
    .app-header h1 { color: #1b5e20; font-size: 1.8em; font-weight: 700; margin-bottom: 5px; line-height: 1.3;
    }
    .app-header p { color: #2e7d32; font-size: 1em; opacity: 0.9;
    }

    .login-btn {
        position: absolute; top: 15px; right: 15px;
        background: rgba(255, 255, 255, 0.9); padding: 6px 12px;
        border-radius: 20px; font-size: 0.8em; font-weight: bold;
        color: #2e7d32; border: none; cursor: pointer;
        z-index: 10;
    }

    .connection-status {
        display: inline-block; padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em; font-weight: 600; margin-top: 10px;
        background: rgba(255,255,255,0.8);
    }
    .status-connected { color: #2e7d32; background: #c8e6c9;
    }
    .status-disconnected { color: #c62828; background: #ffcdd2; }
    .status-syncing { color: #f57f17; background: #fff9c4;
    }

    /* =========================================
       NAVIGATION
       ========================================= */
    .nav-container { display: flex;
        gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .nav-button {
        flex: 1;
        min-width: 120px; padding: 12px;
        background: white; border: 1px solid #e0e0e0; border-radius: 12px;
        font-size: 0.95em; font-weight: 600; color: #555;
        cursor: pointer;
        transition: all 0.2s; font-family: 'Sarabun';
    }
    .nav-button.active {
        background: linear-gradient(135deg, #81c784 0%, #ffcc80 100%);
        color: #1b5e20; border: none;
    }
    .admin-only { display: none !important;
    }
    .show-admin .admin-only { display: block !important; }
    .show-admin .nav-button.admin-only { display: block !important;
    }

    /* =========================================
       DASHBOARD & CARDS
       ========================================= */
    .content-section { display: none;
        animation: fadeIn 0.3s ease; }
    .content-section.active { display: block;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0);
    } }

    .dashboard-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 15px; margin-bottom: 20px;
    }
    .dashboard-card {
        background: white;
        padding: 20px; border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center;
    }
    .dashboard-card .stat-number { font-size: 2em;
        font-weight: 700; color: #1b5e20; }
    .card-container {
        background: white;
        padding: 20px; border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px;
    }
    .card-container h2 {
        color: #1b5e20; margin-bottom: 15px; font-size: 1.3em;
        border-bottom: 2px solid #e8f5e9; padding-bottom: 10px;
    }

    /* =========================================
       FORMS & BUTTONS
       ========================================= */
    .form-layout {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px; margin-bottom: 20px;
    }
    .input-group { display: flex; flex-direction: column;
    }
    .input-group label { color: #2e7d32; font-weight: 600; margin-bottom: 6px; font-size: 0.95em;
    }
    .input-group input, .input-group select, .input-group textarea {
        padding: 12px;
        border: 2px solid #c8e6c9; border-radius: 10px;
        font-size: 1em; font-family: 'Sarabun'; background: #fafafa; width: 100%;
    }
    .button-primary {
        background: linear-gradient(135deg, #66bb6a 0%, #ffb74d 100%);
        color: #1b5e20; padding: 12px 25px; border: none; border-radius: 10px;
        font-weight: 600; cursor: pointer; font-size: 1em; width: 100%; font-family: 'Sarabun';
    }
    .button-secondary, .button-danger, .button-success {
        padding: 8px 16px; border-radius: 8px;
        border: none; font-weight: 600; cursor: pointer; font-family: 'Sarabun';
    }
    .button-secondary { background: #e8f5e9; color: #2e7d32;
    }
    .button-danger { background: #ffcdd2; color: #c62828; }
    .button-success { background: #c8e6c9; color: #2e7d32;
    }

    /* =========================================
       TABLES (Standard View)
       ========================================= */
    .data-table-wrapper {
        background: white;
        border-radius: 16px; padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow-x: auto;
    }
    .data-table { width: 100%;
        border-collapse: collapse; min-width: 800px; }
    .data-table th, .data-table td { padding: 12px; font-size: 0.95em; text-align: left;
        border-bottom: 1px solid #eee; }
    .data-table th { background-color: #f1f8e9; color: #33691e; white-space: nowrap;
    }

    /* =========================================
       MOBILE CARD TABLE TRANSFORM (Magic CSS) 
       ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
       ========================================= */
    @media (max-width: 768px) {
        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏≥‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        .data-table, .data-table thead, .data-table tbody, .data-table th, .data-table td, .data-table tr {
            display: block;
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Accessibility) */
        .data-table thead tr {
            position: absolute;
            top: -9999px; left: -9999px;
        }

        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ñ‡∏ß (tr) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î */
        .data-table tr {
            border: 2px solid #e8f5e9;
            border-radius: 12px;
            margin-bottom: 15px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 10px;
        }

        /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå (td) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Label ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö Value */
        .data-table td {
            border: none;
            border-bottom: 1px dashed #eee;
            position: relative;
            padding-left: 45% !important; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ Label */
            padding-top: 8px !important;
            padding-bottom: 8px !important;
            text-align: right !important; /* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ */
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-word; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
        }

        /* ‡∏™‡∏£‡πâ‡∏≤‡∏á Label ‡∏à‡∏≤‡∏Å attribute 'data-label' */
        .data-table td:before {
            position: absolute;
            top: 8px;
            left: 10px;
            width: 40%;
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 700;
            color: #2e7d32;
            content: attr(data-label);
            /* ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å HTML ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á */
        }

        /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô‡∏≠‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */
        .data-table td:last-child {
            border-bottom: 0;
            padding-left: 0 !important;
            display: flex;
            justify-content: center; /* ‡∏õ‡∏∏‡πà‡∏° Action ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            margin-top: 10px;
            background: #f9fbe7;
            border-radius: 8px;
            padding: 10px !important;
        }
        
        .data-table td:last-child:before { content: none;
        } /* ‡∏ã‡πà‡∏≠‡∏ô Label ‡∏ï‡∏£‡∏á‡∏õ‡∏∏‡πà‡∏° */

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
        .action-button-group { width: 100%;
            justify-content: center; gap: 10px; }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö Data Table Wrapper ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà Scroll ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Card */
        .data-table-wrapper { overflow-x: visible;
            padding: 0; background: transparent; box-shadow: none; }
        .data-table { min-width: 100%;
        }
    }

    /* =========================================
       OTHER UTILS
       ========================================= */
    .book-card { background: white;
        padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; border: 1px solid #eee;
    }
    .book-card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .book-card-title { font-size: 1.1em;
        font-weight: 600; color: #1b5e20; }
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600;
    }
    .status-available { background: #c8e6c9; color: #2e7d32; }
    .status-borrowed { background: #fff9c4; color: #f57f17;
    }
    .status-overdue { background: #ffcdd2; color: #c62828; }
    .status-returned { background: #b3e5fc; color: #01579b;
    }

    .chart-wrapper {
        background: white; padding: 20px; border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); margin-bottom: 30px;
        height: 350px !important; position: relative !important;
        overflow: hidden !important;
        display: block;
    }
    .chart-wrapper canvas { width: 100% !important; height: 100% !important; max-height: 310px;
    }

    .search-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;
    }
    .search-input { flex: 1; padding: 10px; border: 2px solid #c8e6c9; border-radius: 10px; font-family: 'Sarabun';
    }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex;
        align-items: center; justify-content: center; z-index: 9998; padding: 20px; }
    .modal-content { background: white; padding: 25px; border-radius: 15px;
        max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    
    .loading-overlay { position: fixed;
        top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;
    }
    .loading-spinner { width: 50px; height: 50px; border: 5px solid #e8f5e9; border-top-color: #66bb6a; border-radius: 50%;
        animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);
    } }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; color: white;
        font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9999; animation: slideIn 0.3s ease-out; background: #66bb6a;
    }
/* =========================================
       MOBILE QUERY (‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏ô + ‡πÅ‡∏Å‡πâ‡∏•‡πâ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö 100%)
       ========================================= */
    @media (max-width: 768px) {
        /* --- 1. ‡∏õ‡∏£‡∏±‡∏ö Header ‡πÅ‡∏•‡∏∞ Login --- */
        .app-header {
            padding: 15px; border-radius: 0 0 20px 20px;
            margin: -15px -15px 15px -15px;
            display: flex; flex-direction: column; align-items: center;
        }
        .app-header h1 { font-size: 1.4em; }
        .login-btn {
            position: relative !important; top: auto !important; right: auto !important;
            margin-bottom: 10px; display: inline-block; width: auto;
        }

        /* --- 2. ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (Grid 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå) --- */
        .nav-container {
            position: static !important; width: 100%;
            background: transparent; box-shadow: none; border-top: none;
            padding: 0; margin-bottom: 20px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
        }
        .nav-button {
            padding: 10px 5px; border-radius: 12px;
            background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-label { font-size: 0.75rem; font-weight: 600; }
        .nav-button.admin-only { display: none !important; }
        .show-admin .nav-button.admin-only { display: flex !important; }

        /* --- 3. ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡πâ‡∏ô‡∏à‡∏≠ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!) --- */
        .main-wrapper { padding-bottom: 20px !important; overflow-x: hidden; }
        
        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Grid ‡πÄ‡∏õ‡πá‡∏ô Flex ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Input ‡∏î‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á */
        .form-layout {
            display: flex !important;
            flex-direction: column !important;
            gap: 15px !important;
        }
        
        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Input Group ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏° ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
        .input-group {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏ß Input/Date ‡πÉ‡∏´‡πâ‡∏´‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á (Box Sizing) */
        .input-group input, 
        .input-group select, 
        .input-group textarea {
            width: 100% !important;
            min-width: 0 !important;
            max-width: 100% !important;
            box-sizing: border-box !important; /* ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        }

        /* ‡∏•‡∏î Padding ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
        .card-container, .dashboard-card { padding: 15px !important; }
        .chart-wrapper { height: 280px !important; }
    }
        .dashboard-grid { grid-template-columns: 1fr 1fr;
        }
        .form-layout { grid-template-columns: 1fr;
        }
        .search-filters { flex-direction: column;
        }
        .chart-wrapper { height: 280px !important;
        }
    }
  </style>
  <style>@view-transition { navigation: auto;
  }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="main-wrapper" id="mainWrapper">
   <header class="app-header">
    <button id="adminLoginBtn" class="login-btn" onclick="showLoginModal()">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    <button id="adminLogoutBtn" class="login-btn" onclick="logout()" style="display: none; background: #ffcdd2; color: #c62828;">üîì ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    
    <h1 id="headerTitle">üìö ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç</h1>
    <p id="headerSubtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    <div class="connection-status" id="connectionStatus"><span id="statusIcon">üîå</span> <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span></div>
   </header>
   
   <nav class="nav-container">
       <button class="nav-button active" onclick="navigateTo('dashboard')">
           <div class="nav-icon">üè†</div>
           <span class="nav-label">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
       </button>
       
       <button class="nav-button admin-only" onclick="navigateTo('borrow')">
           <div class="nav-icon">üìñ</div>
           <span class="nav-label">‡∏¢‡∏∑‡∏°</span>
       </button>
 
       <button class="nav-button admin-only" onclick="navigateTo('return')">
           <div class="nav-icon">üì•</div>
           <span class="nav-label">‡∏Ñ‡∏∑‡∏ô</span>
       </button>
       
       <button class="nav-button admin-only" onclick="navigateTo('books')">
           <div class="nav-icon">üìö</div>
           <span class="nav-label">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</span>
       </button>
       
       <button class="nav-button admin-only" onclick="navigateTo('members')">
           <div class="nav-icon">üë•</div>
           <span class="nav-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
       </button>
       
       <button class="nav-button admin-only" onclick="navigateTo('history')">
           <div class="nav-icon">üìã</div>
           <span class="nav-label">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
       </button>
   </nav>

   <div id="dashboard" class="content-section active">
    <div class="dashboard-grid">
     <div class="dashboard-card"><h3>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="stat-number" id="totalBooks">0</div><div class="stat-label">‡πÄ‡∏•‡πà‡∏°</div></div>
     <div class="dashboard-card"><h3>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</h3><div class="stat-number" id="availableBooks">0</div><div class="stat-label">‡πÄ‡∏•‡πà‡∏°</div></div>
     <div class="dashboard-card"><h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</h3><div class="stat-number" id="borrowedBooks">0</div><div class="stat-label">‡πÄ‡∏•‡πà‡∏°</div></div>
     
     <div class="dashboard-card admin-only"><h3>‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</h3><div class="stat-number" id="overdueBooks">0</div><div class="stat-label">‡πÄ‡∏•‡πà‡∏°</div></div>
     <div class="dashboard-card admin-only"><h3>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><div class="stat-number" id="totalMembers">0</div><div class="stat-label">‡∏Ñ‡∏ô</div></div>
     <div class="dashboard-card admin-only"><h3>‡∏¢‡∏∑‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3><div class="stat-number" id="todayBorrows">0</div><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
    </div>
    
    <div class="card-container">
     <h2>üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î</h2>
     <div class="search-filters">
        <input type="text" class="search-input" id="searchAvailableBooksPublic" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠..." oninput="searchAvailableBooksPublic()"> 
        <select class="search-input" id="filterCategoryPublic" onchange="searchAvailableBooksPublic()"> 
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option> <option value="‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢">‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</option> <option value="‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô">‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</option> <option value="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</option> <option 
            value="‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option> <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option> 
        </select>
     </div>
     <div id="availableBooksListPublic"></div>
    </div>

    <div class="chart-wrapper"><h2>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h2><canvas id="borrowChart"></canvas></div>
    <div class="chart-wrapper"><h2>üìö ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2><canvas id="popularChart"></canvas></div>
    <div class="card-container"><h2>‚ö†Ô∏è ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</h2><div id="overdueList"></div></div>
   </div>

   <div id="borrow" class="content-section">
    <div class="card-container">
     <h2>üìñ ‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)</h2>
     <form id="borrowForm" onsubmit="handleBorrow(event)">
      <div class="form-layout">
       <div class="input-group" style="grid-column: 1 / -1;">
           <label for="borrowMemberId">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™) *</label> 
           <input type="text" id="borrowMemberId" list="memberOptions" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
           <datalist id="memberOptions"></datalist>
       </div>
<div class="input-group" style="grid-column: 1 / -1;">
           <label for="borrowDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label> 
           <input type="date" id="borrowDate" required>
       </div>
<div class="input-group" style="grid-column: 1 / -1;">
           <label for="dueDate">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô (180 ‡∏ß‡∏±‡∏ô) *</label> 
           <input type="date" id="dueDate" required>
       </div>
       <div class="input-group" style="grid-column: 1 / -1; border-top: 1px dashed #c8e6c9; padding-top: 20px;">
           <label style="color: #1b5e20; font-size: 1.1em;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</label>
           <div style="display: flex; gap: 10px; margin-bottom: 10px;">
               <input type="text" id="borrowBookIdInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô B001)" style="flex:1; border: 2px solid #66bb6a;">
               <button type="button" class="button-secondary" onclick="addToCart()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
           </div>
       </div>

       <div class="input-group" style="grid-column: 1 / -1;">
           <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (Cart)</label>
           <div class="data-table-wrapper" style="padding: 0; box-shadow: none; border: 1px solid #c8e6c9;">
               <table class="data-table">
                   <thead style="background: #f1f8e9;"><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th style="text-align: center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                   <tbody id="borrowCartTableBody"><tr><td colspan="3" style="text-align:center; color: #aaa; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</td></tr></tbody>
               </table>
           </div>
       </div>
       <div class="input-group" style="grid-column: 1 / -1;"><label for="borrowNotes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label> <textarea id="borrowNotes" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea></div>
      </div>
      <button type="submit" class="button-primary" id="borrowSubmitBtn" style="margin-top: 10px;"> üìñ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î </button>
     </form>
    </div>
    <div class="card-container">
     <h2>üìö ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</h2>
     <div class="search-filters"><input type="text" class="search-input" id="searchAvailableBooks" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠..." oninput="searchAvailableBooks()"> </div>
     <div id="availableBooksList"></div>
    </div>
   </div>

   <div id="return" class="content-section">
    <div class="card-container">
     <h2>üì• ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
     <div class="search-filters"><input type="text" class="search-input" id="searchBorrowed" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°, ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠..." oninput="searchBorrowedBooks()"></div>
     <div id="borrowedBooksList"></div>
    </div>
   </div>

   <div id="books" class="content-section">
    <div class="card-container">
     <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</h2>
     <form id="bookForm" onsubmit="handleAddBook(event)">
      <div class="form-layout">
       <div class="input-group"><label 
        for="bookId">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ *</label> <input type="text" id="bookId" required placeholder="B001"></div>
       <div class="input-group"><label for="bookTitle">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ *</label> <input type="text" id="bookTitle" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠"></div>
       <div class="input-group"><label for="bookAuthor">‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á *</label> <input type="text" id="bookAuthor" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á"></div>
       <div class="input-group"><label for="bookCategory">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *</label> <select id="bookCategory" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option> <option value="‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢">‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</option> <option value="‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô">‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô</option> <option value="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï">‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option> <option value="‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option> <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option> </select></div>
       <div class="input-group"><label for="bookISBN">ISBN</label> <input type="text" id="bookISBN" placeholder="978-xxx-xxx"></div>
       <div class="input-group"><label for="bookQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label> <input type="number" id="bookQuantity" required min="1" value="1"></div>
 
      </div><button type="submit" class="button-primary"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ </button>
     </form>
    </div>
    <div class="data-table-wrapper">
     <h2 style="margin-bottom: 20px;">üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
     <div class="search-filters"><input type="text" class="search-input" id="searchBooks" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠..." oninput="searchBooks()"></div>
     <table class="data-table">
      <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th>‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á</th><th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th>ISBN</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody id="booksTableBody"></tbody>
     </table>
    </div>
   </div>

   <div id="members" class="content-section">
    <div class="card-container">
     <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
     <form id="memberForm" onsubmit="handleAddMember(event)">
  
      <div class="form-layout">
       <div class="input-group"><label for="memberId">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å *</label> <input type="text" id="memberId" required placeholder="M001"></div>
       <div class="input-group"><label for="memberName">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label> <input type="text" id="memberName" required placeholder="‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ"></div>
       <div class="input-group"><label for="memberEmail">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input type="email" id="memberEmail" placeholder="example@mail.com"></div>
       <div class="input-group"><label for="memberPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label> <input type="tel" id="memberPhone" required placeholder="08x-xxx-xxxx"></div>
       <div class="input-group"><label for="memberType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label> <select id="memberType" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option> <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢</option> <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏£‡∏π</option> <option value="‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> </select></div>
     
      </div><button type="submit" class="button-primary"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å </button>
     </form>
    </div>
    <div class="data-table-wrapper">
     <h2 style="margin-bottom: 20px;">üë• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
     <div class="search-filters">
        <input type="text" class="search-input" id="searchMembers" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." oninput="searchMembers()"> 
        <select class="search-input" id="filterMemberType" onchange="searchMembers()"> <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option> <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô</option> <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢</option> <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏£‡∏π</option> <option value="‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</option> <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option> </select>
     </div>
     <table class="data-table">
      <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody id="membersTableBody"></tbody>
 
     </table>
    </div>
   </div>

   <div id="history" class="content-section">
    <div class="data-table-wrapper">
     <h2 style="margin-bottom: 20px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
     <div class="search-filters"><input type="text" class="search-input" id="searchHistory" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™..." oninput="searchHistory()"> <select class="search-input" id="filterStatus" onchange="searchHistory()"> <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option> <option value="borrowed">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</option> <option value="returned">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option> <option value="overdue">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option> </select> <button class="button-secondary" onclick="exportHistory()">üì• Export CSV</button></div>
     <table class="data-table">
      <thead><tr><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th><th>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody id="historyTableBody"></tbody>
     </table>
    </div>
   </div>
   
   <footer class="bg-white mt-10 
    border-t"><div class="container mx-auto py-6 text-center text-gray-500 text-sm"><p class="mb-1">¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç</p></div></footer>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRS1iie8d2Bj-jxh6n2Y7XcZBoVWOoNxtXIvA6p3rjyx_DnhUyUWR3TqmL7GYwD5Ybiw/exec';
    const ADMIN_PASSWORD = "admin1250240004"; 
    const LOAN_DAYS = 180; 
    
    let books = [], members = [], borrowRecords = [], borrowCart = [], charts = {};
    let isConnected = false, isAdmin = false;

    const defaultConfig = {
      library_name: "üìö ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç",
      admin_name: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
      contact_info: "@2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏®‡∏Å‡∏£.‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç",
    };
    function showLoginModal() {
        const overlay = document.createElement('div'); overlay.className = 'modal-overlay'; overlay.id = 'loginOverlay';
        overlay.innerHTML = `<div class="modal-content login-container" style="text-align: center;"><div class="modal-header">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</p><form onsubmit="handleLogin(event)"><input type="password" id="adminPassword" class="search-input" style="width:100%; text-align:center; margin: 15px 0;"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required><div class="modal-buttons" style="justify-content: center; margin-top: 20px;"><button type="button" class="button-secondary" onclick="document.getElementById('loginOverlay').remove()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="button-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div></form></div>`;
        document.body.appendChild(overlay); setTimeout(() => document.getElementById('adminPassword').focus(), 100);
    }
    function handleLogin(e) {
        e.preventDefault(); const pwd = document.getElementById('adminPassword').value;
        if (pwd === ADMIN_PASSWORD) { isAdmin = true; document.getElementById('mainWrapper').classList.add('show-admin'); document.getElementById('adminLoginBtn').style.display = 'none'; document.getElementById('adminLogoutBtn').style.display = 'block'; document.getElementById('loginOverlay').remove(); showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); updateAllViews();
        } else { showToast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
    }
    function logout() { isAdmin = false; document.getElementById('mainWrapper').classList.remove('show-admin');
    document.getElementById('adminLoginBtn').style.display = 'block'; document.getElementById('adminLogoutBtn').style.display = 'none'; navigateTo('dashboard'); showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success'); }

    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connectionStatus'), iconEl = document.getElementById('statusIcon'), textEl = document.getElementById('statusText');
      statusEl.className = 'connection-status';
      if (status === 'connected') { statusEl.classList.add('status-connected'); iconEl.textContent = '‚úÖ'; textEl.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß'; isConnected = true;
      }
      else if (status === 'syncing') { statusEl.classList.add('status-syncing'); iconEl.textContent = 'üîÑ'; textEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      }
      else { statusEl.classList.add('status-disconnected'); iconEl.textContent = '‚ùå'; textEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ'; isConnected = false;
      }
    }
    
    function showLoading() { const overlay = document.createElement('div');
        overlay.className = 'loading-overlay'; overlay.id = 'loadingOverlay'; overlay.innerHTML = '<div class="loading-spinner"></div>'; document.body.appendChild(overlay);
    }
    function hideLoading() { const overlay = document.getElementById('loadingOverlay'); if (overlay) overlay.remove();
    }
    
    function scriptRequest(params) {
      return new Promise((resolve, reject) => {
        const formData = new FormData(); Object.keys(params).forEach(key => formData.append(key, params[key]));
        fetch(SCRIPT_URL, { method: 'POST', body: formData }).then(r => { if (!r.ok) throw new Error(r.status); return r.json(); }).then(d => { if (d && d.success === false) reject(new Error(d.error)); else resolve(d); }).catch(e => { console.error("Script Error:", e); reject(e); });
      });
    }

    async function loadDataFromSheets() {
      if (isConnected) return; showLoading(); updateConnectionStatus('syncing');
      try { const r = await scriptRequest({ action: 'getData' }); if (r && r.success) { books = r.books || [];
      members = r.members || []; borrowRecords = r.borrowRecords || []; updateConnectionStatus('connected'); updateAllViews(); hideLoading(); showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); return true;
      } else { throw new Error(r?.error); } } catch (e) { updateConnectionStatus('disconnected'); hideLoading(); showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error'); return false;
      }
    }

    async function saveToSheets(sheet, data) { try { updateConnectionStatus('syncing');
      const r = await scriptRequest({ action: 'saveData', sheet: sheet, data: JSON.stringify(data) }); if (r && r.success) { updateConnectionStatus('connected'); return true;
      } else { throw new Error(r?.error); } } catch (e) { updateConnectionStatus('disconnected'); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); return false;
      } }
    async function deleteFromSheets(sheet, id) { try { updateConnectionStatus('syncing');
      const r = await scriptRequest({ action: 'deleteData', sheet: sheet, id: id }); if (r && r.success) { updateConnectionStatus('connected'); return true;
      } else { throw new Error(r?.error); } } catch (e) { updateConnectionStatus('disconnected'); showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); return false;
      } }

    function showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast toast-${type}`;
      toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); }
    function showConfirmModal(title, message, onConfirm) { const overlay = document.createElement('div');
      overlay.className = 'modal-overlay'; overlay.innerHTML = `<div class="modal-content"><div class="modal-header">${title}</div><div class="modal-body">${message}</div><div class="modal-buttons"><button class="button-secondary" onclick="this.closest('.modal-overlay').remove()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="button-danger" id="confirmBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div>`; document.body.appendChild(overlay);
      document.getElementById('confirmBtn').onclick = () => { onConfirm(); overlay.remove(); }; overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    }
    function findItem(array, id) { return array.find(item => item.id === id);
    }

    function showEditModal(title, formHtml, onSave) {
      const existing = document.getElementById('genericModalOverlay');
      if (existing) existing.remove();
      const overlay = document.createElement('div'); overlay.className = 'modal-overlay'; overlay.id = 'genericModalOverlay';
      overlay.innerHTML = `<div class="modal-content"><div class="modal-header">${title}</div><form id="editForm"><div class="modal-body" style="margin-bottom: 0;">${formHtml}</div><div class="modal-buttons" style="margin-top: 20px;"><button type="button" class="button-secondary" onclick="this.closest('.modal-overlay').remove()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="button-primary" id="saveEditBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div>`;
      document.body.appendChild(overlay);
      document.getElementById('editForm').onsubmit = async (e) => { e.preventDefault(); const btn = document.getElementById('saveEditBtn'); btn.disabled = true; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; await onSave(); overlay.remove();
      };
      overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    }

    function navigateTo(sectionId) {
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); document.getElementById(sectionId).classList.add('active');
      document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
      const target = event.target.closest('.nav-button'); if (target) target.classList.add('active');
      if (sectionId === 'books') updateBooksTable(); if (sectionId === 'members') updateMembersTable();
      if (sectionId === 'history') updateHistoryTable();
      if (sectionId === 'borrow') { updateAvailableBooksList(); const t = new Date();
      const d = new Date(); d.setDate(d.getDate()+LOAN_DAYS); document.getElementById('borrowDate').value = t.toISOString().split('T')[0]; document.getElementById('dueDate').value = d.toISOString().split('T')[0];
      }
      if (sectionId === 'return') updateBorrowedBooksList(); if (sectionId === 'dashboard') updateAvailableBooksListPublic();
    }
    function updateMemberOptions() { const dl = document.getElementById('memberOptions'); if(dl) dl.innerHTML = members.map(m => `<option value="${m.id} : ${m.name}">`).join('');
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏¢‡πâ‡∏≤‡∏¢ updateCharts ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å if(isAdmin) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    function updateAllViews() {
      updateDashboardStats(); 
      updateAvailableBooksListPublic(); 
      updateMemberOptions();
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      updateCharts();

      if (isAdmin) { 
          updateBooksTable();
          updateMembersTable(); 
          updateHistoryTable(); 
          updateAvailableBooksList(); 
          updateBorrowedBooksList(); 
      }
    }

    function updateDashboardStats() {
      const totalAvailable = books.reduce((s, b) => s + parseInt(b.available), 0);
      const totalBorrowed = borrowRecords.filter(b => b.status === 'borrowed').length;
      const now = new Date(); const todayString = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      const todayBorrows = borrowRecords.filter(b => b.borrowDate === todayString && b.status === 'borrowed').length;
      const overdue = borrowRecords.filter(b => b.status === 'borrowed' && new Date(b.dueDate) < new Date());

      document.getElementById('totalBooks').textContent = books.length; document.getElementById('availableBooks').textContent = totalAvailable;
      document.getElementById('borrowedBooks').textContent = totalBorrowed;
      document.getElementById('overdueBooks').textContent = overdue.length; document.getElementById('totalMembers').textContent = members.length; document.getElementById('todayBorrows').textContent = todayBorrows;
      
      const overdueList = document.getElementById('overdueList');
      if (overdue.length === 0) { overdueList.innerHTML = '<p style="color: #66bb6a; text-align: center; padding: 20px;">üéâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</p>';
      } else {
        overdueList.innerHTML = overdue.map(item => {
          const book = books.find(b => b.id === item.bookId); const member = members.find(m => m.id === item.memberId);
          const daysOverdue = Math.floor((new Date() - new Date(item.dueDate)) / (1000 * 60 * 60 * 24));
          return `<div class="book-card"><div class="book-card-header"><div><div class="book-card-title">${book ? book.title : item.bookId}</div><div class="book-card-author">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${member ? member.name : item.memberId}</div></div><span class="status-badge status-overdue">‡πÄ‡∏Å‡∏¥‡∏ô ${daysOverdue} ‡∏ß‡∏±‡∏ô</span></div><div class="book-card-info"><div class="book-card-info-item"><span class="book-card-info-label">‡∏£‡∏´‡∏±‡∏™:</span> ${item.bookId}</div><div class="book-card-info-item"><span class="book-card-info-label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</span> ${item.dueDate}</div></div></div>`;
 
        }).join('');
      }
    }
    
    function updateAvailableBooksListPublic() {
        const term = document.getElementById('searchAvailableBooksPublic')?.value.toLowerCase() ||
        '';
        const cat = document.getElementById('filterCategoryPublic')?.value || '';
        let list = books.filter(b => parseInt(b.available) > 0 && (b.id.toLowerCase().includes(term) || b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term)) && (!cat || b.category === cat));
        const container = document.getElementById('availableBooksListPublic');
        if (list.length === 0) { container.innerHTML = '<div class="empty-message"><div class="empty-icon">üìñ</div><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h3></div>'; return;
        }
        container.innerHTML = list.map(b => `<div class="book-card"><div class="book-card-header"><div><div class="book-card-title">${b.title}</div><div class="book-card-author">‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á: ${b.author}</div></div><span class="status-badge status-available">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${b.available}</span></div><div class="book-card-info"><div class="book-card-info-item"><span class="book-card-info-label">‡∏£‡∏´‡∏±‡∏™:</span> ${b.id}</div><div class="book-card-info-item"><span class="book-card-info-label">‡∏´‡∏°‡∏ß‡∏î:</span> ${b.category}</div></div></div>`).join('');
    }
    function searchAvailableBooksPublic() { updateAvailableBooksListPublic(); }

    async function handleAddBook(event) {
      event.preventDefault();
      const id = document.getElementById('bookId').value;
      if (books.some(b => b.id === id)) { showToast('‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return;
      }
      const q = parseInt(document.getElementById('bookQuantity').value);
      const b = { id: id, title: document.getElementById('bookTitle').value, author: document.getElementById('bookAuthor').value, category: document.getElementById('bookCategory').value, isbn: document.getElementById('bookISBN').value ||
      '', quantity: q, available: q, timestamp: Date.now() };
      const btn = event.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const s = await saveToSheets('books', b); if (s) { books.push(b); updateAllViews(); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); event.target.reset(); } btn.disabled = false;
      btn.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠';
    }

    async function handleAddMember(event) {
      event.preventDefault();
      const id = document.getElementById('memberId').value;
      if (members.some(m => m.id === id)) { showToast('‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return;
      }
      const m = { id: id, name: document.getElementById('memberName').value, email: document.getElementById('memberEmail').value ||
      '', phone: document.getElementById('memberPhone').value, type: document.getElementById('memberType').value, timestamp: Date.now() };
      const btn = event.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const s = await saveToSheets('members', m); if (s) { members.push(m); updateAllViews(); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); event.target.reset(); } btn.disabled = false;
      btn.textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
    }

    function addToCart() {
        const input = document.getElementById('borrowBookIdInput');
        const id = input.value.trim(); if (!id) return;
        const book = books.find(b => b.id === id); if (!book) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', 'warning');
        return; }
        const inCart = borrowCart.filter(i => i.id === id).length;
        if (parseInt(book.available) - inCart <= 0) { showToast('‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'warning'); return; }
        borrowCart.push(book);
        input.value = ''; input.focus(); updateCartTable();
    }
    function removeFromCart(i) { borrowCart.splice(i, 1); updateCartTable();
    }
    
    // ‚úÖ Modified: Add data-label for mobile card view
    function updateCartTable() {
        const tbody = document.getElementById('borrowCartTableBody');
        const btn = document.getElementById('borrowSubmitBtn');
        if (borrowCart.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: #aaa; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</td></tr>';
        btn.textContent = 'üìñ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; return; }
        tbody.innerHTML = borrowCart.map((b, i) => `<tr><td data-label="‡∏£‡∏´‡∏±‡∏™">${b.id}</td><td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">${b.title}</td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" style="text-align: center;"><button type="button" class="button-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="removeFromCart(${i})">‡∏•‡∏ö</button></td></tr>`).join('');
        btn.textContent = `üìñ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (${borrowCart.length} ‡πÄ‡∏•‡πà‡∏°)`;
    }

    async function handleBorrow(event) {
      event.preventDefault();
      let mid = document.getElementById('borrowMemberId').value; if (mid.includes(':')) mid = mid.split(':')[0].trim();
      const mem = members.find(m => m.id === mid);
      if (!mem) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'warning'); return; }
      if (borrowCart.length === 0) { showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏•‡πà‡∏°', 'warning');
      return; }
      const btn = document.getElementById('borrowSubmitBtn'); btn.disabled = true;
      let success = 0, fail = 0;
      for (let i = 0; i < borrowCart.length; i++) {
          const bCart = borrowCart[i];
          btn.textContent = `‚è≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... (${i+1}/${borrowCart.length})`;
          const liveB = books.find(b => b.id === bCart.id);
          if (liveB && parseInt(liveB.available) > 0) {
              const rec = { id: 'BR'+Date.now()+Math.floor(Math.random()*1000), memberId: mid, bookId: liveB.id, bookTitle: liveB.title, borrowDate: document.getElementById('borrowDate').value, dueDate: document.getElementById('dueDate').value, returnDate: '', status: 'borrowed', notes: document.getElementById('borrowNotes').value ||
              '', timestamp: Date.now() };
              const s = await saveToSheets('borrows', rec); if (s) { liveB.available = parseInt(liveB.available)-1; await saveToSheets('books', liveB); borrowRecords.push(rec);
              success++; } else fail++;
          } else fail++;
      }
      updateAllViews();
      if (fail === 0) { showToast(`‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success} ‡πÄ‡∏•‡πà‡∏°!`, 'success'); borrowCart = []; updateCartTable(); event.target.reset(); const t = new Date();
      const d = new Date(); d.setDate(d.getDate()+LOAN_DAYS); document.getElementById('borrowDate').value = t.toISOString().split('T')[0]; document.getElementById('dueDate').value = d.toISOString().split('T')[0];
      }
      else { showToast(`‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success}, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${fail}`, 'warning'); borrowCart = []; updateCartTable();
      }
      btn.disabled = false;
    }

    function returnBook(bid) {
      const b = borrowRecords.find(i => i.id === bid);
      if (!b) return;
      showConfirmModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô', `‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠: ${b.bookTitle}?`, async () => {
          b.status = 'returned'; b.returnDate = new Date().toISOString().split('T')[0];
          const s = await saveToSheets('borrows', b); if (s) { const book = books.find(k => k.id === b.bookId); if (book) { book.available = parseInt(book.available)+1; await saveToSheets('books', book); } updateAllViews(); showToast('‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); }
      });
    }

    function editHistory(rid) {
        const r = borrowRecords.find(i => i.id === rid);
        if (!r) return;
        const m = members.find(k => k.id === r.memberId); const mName = m ? m.name : '-';
        const html = `<input type="hidden" id="editHistoryId" value="${r.id}"><div class="form-layout"><div class="input-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label> <input type="text" value="${r.id}" disabled></div><div class="input-group"><label>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</label> <input type="text" value="${mName}" disabled></div><div class="input-group"><label>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label> <input type="text" value="${r.bookTitle}" disabled></div><div class="input-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label> <input type="date" id="editBorrowDate" value="${r.borrowDate}" required></div><div class="input-group"><label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô *</label> <input type="date" id="editDueDate" value="${r.dueDate}" required></div><div class="input-group" style="background: #e3f2fd; padding: 10px; border-radius: 8px;"><label style="color: #0d47a1;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</label> <input type="date" id="editReturnDate" value="${r.returnDate || ''}"><p style="font-size: 0.8em; color: #666; margin-top: 5px;">* ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô = ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p></div></div>`;
        showEditModal(`‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥`, html, updateHistoryDetails);
    }
    async function updateHistoryDetails() {
        const id = document.getElementById('editHistoryId').value;
        const old = borrowRecords.find(r => r.id === id);
        const up = { ...old, borrowDate: document.getElementById('editBorrowDate').value, dueDate: document.getElementById('editDueDate').value, returnDate: document.getElementById('editReturnDate').value };
        up.status = up.returnDate ? 'returned' : 'borrowed';
        const idx = borrowRecords.findIndex(r => r.id === id);
        if (idx !== -1) borrowRecords[idx] = up;
        showLoading(); const s = await saveToSheets('borrows', up); hideLoading();
        if (s) { updateAllViews();
        showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); return true; } else { if (idx !== -1) borrowRecords[idx] = old; updateAllViews(); return false;
        }
    }

    function editBook(bid) {
      const b = findItem(books, bid);
      if (!b) return;
      const cats = ['‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢','‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ','‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ','‡∏™‡∏≤‡∏£‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô','‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏≤‡∏ä‡∏µ‡∏û','‡∏™‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï','‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'].map(c => `<option value="${c}" ${b.category === c ? 'selected' : ''}>${c}</option>`).join('');
      const html = `<input type="hidden" id="editBookId" value="${b.id}"><div class="form-layout"><div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ *</label> <input type="text" id="editBookTitle" value="${b.title}" required></div><div class="input-group"><label>‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á *</label> <input type="text" id="editBookAuthor" value="${b.author}" required></div><div class="input-group"><label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *</label> <select id="editBookCategory" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>${cats}</select></div><div class="input-group"><label>ISBN</label> <input type="text" id="editBookISBN" value="${b.isbn||''}"></div><div class="input-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î *</label> <input type="number" id="editBookQuantity" value="${b.quantity}" required min="1"></div><div class="input-group"><label>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</label> <input type="number" value="${b.available}" disabled></div></div>`;
      showEditModal(`‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠`, html, updateBookDetails);
    }
    async function updateBookDetails() {
      const id = document.getElementById('editBookId').value;
      const old = findItem(books, id);
      const newQ = parseInt(document.getElementById('editBookQuantity').value);
      if (newQ < parseInt(old.quantity) - parseInt(old.available)) { showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', 'warning'); return false;
      }
      const newAv = parseInt(old.available) + (newQ - parseInt(old.quantity));
      const up = { id: id, title: document.getElementById('editBookTitle').value, author: document.getElementById('editBookAuthor').value, category: document.getElementById('editBookCategory').value, isbn: document.getElementById('editBookISBN').value, quantity: newQ, available: newAv, timestamp: old.timestamp };
      const idx = books.findIndex(b => b.id === id); if (idx !== -1) books[idx] = up;
      showLoading();
      const s = await saveToSheets('books', up); hideLoading();
      if (s) { updateAllViews(); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); return true;
      } else { if (idx !== -1) books[idx] = old; updateAllViews(); return false;
      }
    }

    function editMember(mid) {
      const m = findItem(members, mid);
      if (!m) return;
      const types = [{v:'‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤',t:'‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤'},{v:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô',t:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô'},{v:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢',t:'‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢'},{v:'‡∏Ñ‡∏£‡∏π',t:'‡∏Ñ‡∏£‡∏π'},{v:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£',t:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'},{v:'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',t:'‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}].map(t => `<option value="${t.v}" ${m.type === t.v ? 'selected' : ''}>${t.t}</option>`).join('');
      const html = `<input type="hidden" id="editMemberId" value="${m.id}"><div class="form-layout"><div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• *</label> <input type="text" id="editMemberName" value="${m.name}" required></div><div class="input-group"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input type="email" id="editMemberEmail" value="${m.email||''}"></div><div class="input-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label> <input type="tel" id="editMemberPhone" value="${m.phone}" required></div><div class="input-group"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label> <select id="editMemberType" required>${types}</select></div></div>`;
      showEditModal(`‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å`, html, updateMemberDetails);
    }
    async function updateMemberDetails() {
      const id = document.getElementById('editMemberId').value;
      const old = findItem(members, id);
      const up = { id: id, name: document.getElementById('editMemberName').value, email: document.getElementById('editMemberEmail').value, phone: document.getElementById('editMemberPhone').value, type: document.getElementById('editMemberType').value, timestamp: old.timestamp };
      const idx = members.findIndex(m => m.id === id); if (idx !== -1) members[idx] = up;
      showLoading();
      const s = await saveToSheets('members', up); hideLoading();
      if (s) { updateAllViews(); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); return true;
      } else { if (idx !== -1) members[idx] = old; updateAllViews(); return false;
      }
    }

    function deleteBook(id) { const b = books.find(i => i.id === id);
      if (!b) return; if (borrowRecords.some(r => r.bookId === id && r.status === 'borrowed')) { showToast('‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà', 'error'); return;
      } showConfirmModal('‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', `‡∏•‡∏ö: ${b.title}?`, async () => { const s = await deleteFromSheets('books', id); if (s) { books = books.filter(i => i.id !== id); updateAllViews(); showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); } });
    }
    function deleteMember(id) { const m = members.find(i => i.id === id); if (!m) return;
      if (borrowRecords.some(r => r.memberId === id && r.status === 'borrowed')) { showToast('‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà', 'error'); return;
      } showConfirmModal('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', `‡∏•‡∏ö: ${m.name}?`, async () => { const s = await deleteFromSheets('members', id); if (s) { members = members.filter(i => i.id !== id); updateAllViews(); showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); } });
    }

    // ‚úÖ Modified: Add data-label for mobile card view
    function updateBooksTable() {
      const term = document.getElementById('searchBooks')?.value.toLowerCase() ||
      '';
      const list = books.filter(b => b.id.toLowerCase().includes(term) || b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term));
      const tbody = document.getElementById('booksTableBody');
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="8" class="empty-message"><div class="empty-icon">üìö</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h3></td></tr>`; return;
      }
      tbody.innerHTML = list.map(b => `<tr><td data-label="‡∏£‡∏´‡∏±‡∏™">${b.id}</td><td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">${b.title}</td><td data-label="‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á">${b.author}</td><td data-label="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">${b.category}</td><td data-label="ISBN">${b.isbn||'-'}</td><td data-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">${b.quantity}</td><td data-label="‡πÄ‡∏´‡∏•‡∏∑‡∏≠">${b.available}</td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-button-group"><button class="button-secondary" onclick="editBook('${b.id}')">‚úèÔ∏è</button><button class="button-danger" onclick="deleteBook('${b.id}')">üóëÔ∏è</button></div></td></tr>`).join('');
    }

    // ‚úÖ Modified: Add data-label for mobile card view
    function updateMembersTable() {
      const term = document.getElementById('searchMembers')?.value.toLowerCase() ||
      ''; const type = document.getElementById('filterMemberType')?.value || '';
      const list = members.filter(m => (m.id.toLowerCase().includes(term) || m.name.toLowerCase().includes(term)) && (!type || m.type === type));
      const tbody = document.getElementById('membersTableBody');
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="empty-message"><div class="empty-icon">üë•</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3></td></tr>`; return;
      }
      tbody.innerHTML = list.map(m => `<tr><td data-label="‡∏£‡∏´‡∏±‡∏™">${m.id}</td><td data-label="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">${m.name}</td><td data-label="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">${m.email||'-'}</td><td data-label="‡πÇ‡∏ó‡∏£">${m.phone}</td><td data-label="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó">${m.type}</td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-button-group"><button class="button-secondary" onclick="editMember('${m.id}')">‚úèÔ∏è</button><button class="button-danger" onclick="deleteMember('${m.id}')">üóëÔ∏è</button></div></td></tr>`).join('');
    }

    // ‚úÖ Modified: Add data-label for mobile card view
    function updateHistoryTable() {
      const term = document.getElementById('searchHistory')?.value.toLowerCase() ||
      ''; const status = document.getElementById('filterStatus')?.value || '';
      let list = borrowRecords.filter(r => {
        const m = members.find(i => i.id === r.memberId); const mName = m ? m.name.toLowerCase() : '';
        const match = r.memberId.toLowerCase().includes(term) || r.bookId.toLowerCase().includes(term) || r.bookTitle.toLowerCase().includes(term) || mName.includes(term);
        let sMatch = true; if (status === 'borrowed') sMatch = r.status === 'borrowed' && new Date(r.dueDate) >= new Date(); else if (status === 'returned') sMatch = r.status === 'returned'; else if (status === 'overdue') sMatch = r.status === 'borrowed' && 
        new Date(r.dueDate) < new Date();
        return match && sMatch;
      });
      list.sort((a, b) => b.timestamp - a.timestamp);
      const tbody = document.getElementById('historyTableBody');
      if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="9" class="empty-message"><div class="empty-icon">üìã</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3></td></tr>`; return;
      }
      tbody.innerHTML = list.map(r => {
        let badge = '', cls = ''; const m = members.find(i => i.id === r.memberId); const mName = m ? m.name : '-';
        if (r.status === 'returned') { badge = '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; cls = 'status-returned'; } else if (new Date(r.dueDate) < new Date()) { badge = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î'; cls = 'status-overdue'; } else { badge = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°'; cls = 'status-borrowed'; }
        return `<tr><td data-label="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">${r.memberId}</td><td data-label="‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°">${mName}</td><td data-label="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">${r.bookId}</td><td data-label="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠">${r.bookTitle}</td><td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°">${r.borrowDate}</td><td data-label="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô">${r.dueDate}</td><td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô">${r.returnDate||'-'}</td><td 
        data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><span class="status-badge ${cls}">${badge}</span></td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-button-group"><button class="button-secondary" onclick="editHistory('${r.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>${r.status === 'borrowed' ? `<button class="button-success" onclick="returnBook('${r.id}')">‡∏Ñ‡∏∑‡∏ô</button>` : ''}</div></td></tr>`;
      }).join('');
    }

    function updateAvailableBooksList() {
      const term = document.getElementById('searchAvailableBooks')?.value.toLowerCase() || '';
      let list = books.filter(b => parseInt(b.available) > 0 && (b.id.toLowerCase().includes(term) || b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term)));
      const container = document.getElementById('availableBooksList');
      if (list.length === 0) { container.innerHTML = '<div class="empty-message"><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h3></div>'; return;
      }
      container.innerHTML = list.map(b => `<div class="book-card"><div class="book-card-header"><div><div class="book-card-title">${b.title}</div><div class="book-card-author">${b.author}</div></div><span class="status-badge status-available">${b.available} ‡πÄ‡∏•‡πà‡∏°</span></div><div class="book-card-info"><div class="book-card-info-item"><span class="book-card-info-label">‡∏£‡∏´‡∏±‡∏™:</span> ${b.id}</div></div></div>`).join('');
    }

    function updateBorrowedBooksList() {
      const term = document.getElementById('searchBorrowed')?.value.toLowerCase() || '';
      let list = borrowRecords.filter(b => b.status === 'borrowed').filter(b => {
        const m = members.find(i => i.id === b.memberId); const mName = m ? m.name.toLowerCase() : '';
        return b.memberId.toLowerCase().includes(term) || b.bookId.toLowerCase().includes(term) || b.bookTitle.toLowerCase().includes(term) || mName.includes(term);
      });
      list.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      const container = document.getElementById('borrowedBooksList');
      if (list.length === 0) { container.innerHTML = '<div class="empty-message"><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3></div>'; return;
      }
      container.innerHTML = list.map(b => {
        const m = members.find(i => i.id === b.memberId); const isOver = new Date(b.dueDate) < new Date();
        return `<div class="book-card"><div class="book-card-header"><div><div class="book-card-title">${b.bookTitle}</div><div class="book-card-author">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: ${m ? m.name : b.memberId}</div></div><span class="status-badge ${isOver ? 'status-overdue' : 'status-borrowed'}">${isOver ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°'}</span></div><div class="book-card-info"><div class="book-card-info-item"><span class="book-card-info-label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô:</span> ${b.dueDate}</div></div><div style="margin-top: 15px;"><button class="button-success" onclick="returnBook('${b.id}')">üì• ‡∏Ñ‡∏∑‡∏ô</button></div></div>`;
      }).join('');
    }

    function searchBooks() { updateBooksTable(); } function searchMembers() { updateMembersTable(); } function searchHistory() { updateHistoryTable();
    } function searchAvailableBooks() { updateAvailableBooksList(); } function searchBorrowedBooks() { updateBorrowedBooksList();
    }

    function exportHistory() {
      if (borrowRecords.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning'); return;
      }
      const headers = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°', '‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°', '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
      const csv = borrowRecords.map(r => {
        let st = r.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (new Date(r.dueDate) < new Date() ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°'); const m = members.find(i => i.id === r.memberId); const mn = m ? m.name : '-';
        return [r.memberId, `"${mn}"`, r.bookId, `"${r.bookTitle.replace(/"/g, '""')}"`, r.borrowDate, r.dueDate, r.returnDate || '', st].join(',');
      }).join('\n');
      const blob = new Blob(["\ufeff", headers.join(',') + '\n' + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = 
      `library_history_${new Date().toISOString().split('T')[0]}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    
    function initializeCharts() {
      const opts = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false } } };
      if (charts.borrow) charts.borrow.destroy();
      charts.borrow = new Chart(document.getElementById('borrowChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: '‡∏¢‡∏∑‡∏°', data: [], backgroundColor: 'rgba(102, 187, 106, 0.5)', borderColor: '#66bb6a', borderWidth: 2, tension: 0.4 }] }, options: opts });
      if (charts.popular) charts.popular.destroy(); charts.popular = new Chart(document.getElementById('popularChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: [], backgroundColor: '#ffb74d' }] }, options: { ...opts, indexAxis: 'y' } });
    }

    function updateCharts() {
      if (!charts.borrow || !charts.popular) return;
      const last7 = [], counts = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
        const ds = `${y}-${m}-${day}`; last7.push(`${d.getDate()}/${d.getMonth() + 1}`);
        counts.push(borrowRecords.filter(b => b.borrowDate === ds).length);
      }
      charts.borrow.data.labels = last7; charts.borrow.data.datasets[0].data = counts; charts.borrow.update();
      const bc = {};
      borrowRecords.forEach(b => bc[b.bookTitle] = (bc[b.bookTitle] || 0) + 1);
      const top = Object.entries(bc).sort((a, b) => b[1] - a[1]).slice(0, 10);
      charts.popular.data.labels = top.map(b => b[0]); charts.popular.data.datasets[0].data = top.map(b => b[1]); charts.popular.update();
    }

    function onConfigChange(c) { document.getElementById('headerTitle').textContent = c.library_name || defaultConfig.library_name; document.getElementById('headerSubtitle').textContent = c.admin_name || defaultConfig.admin_name;
    document.querySelector('footer p.mb-1').textContent = c.contact_info || defaultConfig.contact_info; }
    function initializeApp() { if (typeof elementSDK !== 'undefined') elementSDK.config.onConfigChange(onConfigChange);
    else onConfigChange(defaultConfig); initializeCharts(); loadDataFromSheets(); updateAvailableBooksListPublic(); }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initializeApp); else initializeApp();
  </script>
 </body>
</html>
